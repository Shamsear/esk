<!DOCTYPE html>
<html lang="en">
<head>
    <!-- PWA support -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3498db">
    <link rel="apple-touch-icon" href="/assets/images/icon-192x192.png">

    <!-- DNS prefetch and preconnect -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" media="print" onload="this.media='all'" crossorigin>
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"></noscript>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://assets.mixkit.co">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>R2G Player Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" media="print" onload="this.media='all'" crossorigin>
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"></noscript>
    <link rel="stylesheet" href="css/club-dropdown.css">
    <!-- Load club manager script -->
    <script src="js/club-loader.js" defer></script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #1a1a1a;
            color: #e3e3e3;
            margin: 0;
            padding: 0;
        }
        .header {
            background-color: #282828;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            color: #fff;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .username {
            color: #3498db;
            font-weight: 500;
        }
        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .logout-btn:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .container {
            padding: 25px;
            display: flex;
            height: calc(100vh - 70px);
            box-sizing: border-box;
            gap: 25px;
        }
        .player-list {
            flex: 1;
            background-color: rgba(40, 40, 40, 0.9);
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
            max-width: 320px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }
        .player-list h2 {
            margin-top: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
            font-weight: 600;
            color: #fff;
            letter-spacing: 0.5px;
        }
        .search-box {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            border: 1px solid #444;
            background-color: rgba(51, 51, 51, 0.8);
            color: #fff;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s ease;
        }
        .search-box:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        .player-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .player-item:hover {
            background-color: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .player-item.selected {
            background-color: rgba(52, 152, 219, 0.2);
            border: 1px solid rgba(52, 152, 219, 0.4);
        }
        .player-thumbnail {
            width: 45px;
            height: 45px;
            border-radius: 6px;
            margin-right: 12px;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .player-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }
        .player-value {
            color: #3498db;
            font-weight: 600;
            margin-left: 5px;
            background-color: rgba(52, 152, 219, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        .player-editor {
            flex: 3;
            background-color: rgba(40, 40, 40, 0.9);
            border-radius: 10px;
            padding: 25px;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #ccc;
            font-size: 15px;
        }
        input, select {
            width: 100%;
            padding: 14px 16px;
            border-radius: 6px;
            border: 1px solid #444;
            background-color: rgba(51, 51, 51, 0.8);
            color: #fff;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
            font-size: 15px;
            transition: all 0.3s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        button {
            padding: 12px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            margin-right: 12px;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        button:active {
            transform: translateY(0);
        }
        .btn-delete {
            background-color: #e74c3c;
        }
        .btn-delete:hover {
            background-color: #c0392b;
        }
        .stats-container {
            margin-top: 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
        }
        .stat-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            gap: 10px;
        }
        
        .season-input,
        .value-input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            flex: 1;
        }
        
        /* Add styling for the team select in stats */
        .team-select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            flex: 1.5;
            height: 38px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
            padding-right: 30px;
        }
        
        .team-select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        .team-select option {
            background-color: #1c1c1c;
        }
        
        .stat-item:hover {
            background-color: rgba(51, 51, 51, 0.7);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            transform: translateY(-3px);
        }
        .add-stat-btn {
            background-color: #3498db;
            padding: 12px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 0.5px;
        }
        .add-stat-btn:hover {
            background-color: #2980b9;
        }
        .add-stat-btn i {
            font-size: 16px;
        }
        .club-dropdown {
            position: relative;
        }
        .club-search {
            padding-right: 30px;
        }
        .club-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: rgba(51, 51, 51, 0.95);
            border: 1px solid #444;
            border-radius: 0 0 6px 6px;
            z-index: 100;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        .club-option {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .club-option:hover {
            background-color: rgba(52, 152, 219, 0.2);
        }
        .club-option:last-child {
            border-bottom: none;
        }
        .club-logo {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            object-fit: contain;
            border-radius: 4px;
        }
        .buttons-container {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .status-message {
            padding: 15px;
            margin-top: 20px;
            border-radius: 6px;
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .status-success {
            background-color: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        .status-error {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        .add-player-btn {
            margin: 0 0 15px auto;
            display: block;
            background-color: #27ae60;
        }
        .add-player-btn:hover {
            background-color: #219955;
        }
        /* Tab system */
        .tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            gap: 5px;
        }
        .tab {
            padding: 14px 22px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            transition: all 0.3s ease;
            border-radius: 6px 6px 0 0;
            font-weight: 500;
            color: #ccc;
        }
        .tab:hover {
            background-color: rgba(52, 152, 219, 0.1);
            color: #fff;
        }
        .tab.active {
            border-bottom: 2px solid #3498db;
            font-weight: 600;
            background-color: rgba(52, 152, 219, 0.15);
            color: #3498db;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        .tab-content.active {
            display: block;
        }
        .tab-content h3 {
            color: #fff;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 20px;
            letter-spacing: 0.5px;
        }
        /* Team dropdown for stats */
        .team-dropdown {
            position: relative;
        }
        .team-search {
            padding-right: 30px;
        }
        .team-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: rgba(51, 51, 51, 0.95);
            border: 1px solid #444;
            border-radius: 0 0 6px 6px;
            z-index: 100;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        .team-option {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .team-option:hover {
            background-color: rgba(52, 152, 219, 0.2);
        }
        .team-option:last-child {
            border-bottom: none;
        }
        .team-logo {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            object-fit: contain;
            border-radius: 4px;
        }
        
        /* Stats reordering controls */
        .stat-controls {
            display: flex;
            gap: 5px;
        }
        
        .move-up-btn,
        .move-down-btn,
        .delete-btn {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
        }
        
        .move-up-btn:hover,
        .move-down-btn:hover {
            background: rgba(0, 123, 255, 0.7);
            border-color: rgba(0, 123, 255, 0.8);
        }
        
        .delete-btn {
            background: rgba(220, 53, 69, 0.3);
        }
        
        .delete-btn:hover {
            background: rgba(220, 53, 69, 0.7);
            border-color: rgba(220, 53, 69, 0.8);
        }
        
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        /* Club preview */
        .club-preview {
            margin-top: 10px;
            display: flex;
            align-items: center;
        }
        
        .club-logo-preview {
            max-width: 50px;
            max-height: 50px;
            object-fit: contain;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 5px;
            background-color: rgba(51, 51, 51, 0.5);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        /* Image preview */
        #image-preview {
            margin-top: 20px;
            text-align: center;
        }
        
        #image-preview img {
            max-width: 200px;
            max-height: 200px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        #image-preview img:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
                padding: 15px;
            }
            
            .player-list {
                max-width: 100%;
                margin-right: 0;
                margin-bottom: 20px;
                max-height: 300px;
            }
            
            .header {
                flex-direction: column;
                padding: 15px;
                text-align: center;
            }
            
            .header h1 {
                margin-bottom: 10px;
                font-size: 22px;
            }
            
            .user-info {
                width: 100%;
                justify-content: center;
            }
            
            .buttons-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .btn-delete {
                align-self: center;
            }
            
            /* Make tabs more usable on mobile */
            .tabs {
                padding-bottom: 5px;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 15px;
            }
            
            /* Adjust stat items for mobile */
            .stat-item {
                flex-wrap: wrap;
                padding: 15px;
            }
            
            .stat-item > div {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .stat-controls {
                position: relative;
                transform: none;
                justify-content: flex-end;
                margin-top: 10px;
                right: 0;
            }
            
            /* Adjust form elements for touch */
            button, input, select {
                padding: 14px 16px;
                font-size: 16px; /* Prevents iOS zoom on focus */
                border-radius: 6px;
            }
            
            label {
                font-size: 15px;
                margin-bottom: 8px;
            }
            
            /* Styles for our new elements on mobile */
            .season-input,
            .team-select,
            .value-input {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .move-up-btn,
            .move-down-btn,
            .delete-btn {
                width: 42px;
                height: 42px;
                font-size: 16px;
            }
        }
    </style>

    <!-- Performance optimized CSS -->
    <link rel="stylesheet" href="css/performance.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="css/performance.css"></noscript>

</head>
<body>
    <div class="header">
        <h1>R2G Player Admin Panel</h1>
        <div class="user-info">
            <span>Logged in as: <span class="username" id="logged-user">Admin</span></span>
            <button class="logout-btn" id="logout-btn">Logout</button>
        </div>
    </div>
    
    <div class="container">
        <div class="player-list">
            <h2>Players</h2>
            <input type="text" class="search-box" id="player-search" placeholder="Search players...">
            <button class="add-player-btn" id="add-player-btn">+ New Player</button>
            <div id="players-container">
                <!-- Player list items will be added here dynamically -->
            </div>
        </div>
        
        <div class="player-editor" id="player-editor">
            <div class="tabs">
                <div class="tab active" data-tab="basic">Basic Info</div>
                <div class="tab" data-tab="stats">Stats & History</div>
                <div class="tab" data-tab="image">Image</div>
            </div>
            
            <div class="tab-content active" data-tab="basic">
                <div class="form-group">
                    <label for="player-name">Player Name</label>
                    <input type="text" id="player-name" placeholder="Player name">
                </div>
                
                <div class="form-group">
                    <label for="player-star">Star Rating</label>
                    <select id="player-star">
                        <option value="3-star-standard">3 Star Standard</option>
                        <option value="4-star-standard">4 Star Standard</option>
                        <option value="5-star-standard">5 Star Standard</option>
                        <option value="4-star-legend">4 Star Legend</option>
                        <option value="5-star-legend">5 Star Legend</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="player-level">Level</label>
                    <select id="player-level">
                        <option value="STANDARD">STANDARD</option>
                        <option value="LEGENDARY">LEGENDARY</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="player-club">Club</label>
                    <select id="player-club" class="club-select">
                        <option value="">-- Select Club --</option>
                        <option value="FREE AGENT">FREE AGENT</option>
                        <option value="AC Milan">AC Milan</option>
                        <option value="AFC Ajax">AFC Ajax</option>
                        <option value="Al Hilal SFC">Al Hilal SFC</option>
                        <option value="Al-Nassr FC">Al-Nassr FC</option>
                        <option value="Arsenal FC">Arsenal FC</option>
                        <option value="AS Roma">AS Roma</option>
                        <option value="Aston Villa FC">Aston Villa FC</option>
                        <option value="Atalanta BC">Atalanta BC</option>
                        <option value="Atletico de Madrid">Atletico de Madrid</option>
                        <option value="Bayer Leverkusen">Bayer Leverkusen</option>
                        <option value="Borussia Dortmund">Borussia Dortmund</option>
                        <option value="Chelsea FC">Chelsea FC</option>
                        <option value="FC Barcelona">FC Barcelona</option>
                        <option value="FC Bayern Munich">FC Bayern Munich</option>
                        <option value="FC Porto">FC Porto</option>
                        <option value="FSV MAINZ 05">FSV MAINZ 05</option>
                        <option value="Inter Miami">Inter Miami</option>
                        <option value="Inter Milan">Inter Milan</option>
                        <option value="Liverpool FC">Liverpool FC</option>
                        <option value="LOSC Lille">LOSC Lille</option>
                        <option value="Manchester City FC">Manchester City FC</option>
                        <option value="Manchester United FC">Manchester United FC</option>
                        <option value="Mohun Bagan AC">Mohun Bagan AC</option>
                        <option value="Mumbai City FC">Mumbai City FC</option>
                        <option value="Newcastle United FC">Newcastle United FC</option>
                        <option value="Paris Saint-Germain FC">Paris Saint-Germain FC</option>
                        <option value="Randers FC">Randers FC</option>
                        <option value="Rangers FC">Rangers FC</option>
                        <option value="RB Leipzig">RB Leipzig</option>
                        <option value="RC Lens">RC Lens</option>
                        <option value="Real Madrid CF">Real Madrid CF</option>
                        <option value="Red Bull Bragantino">Red Bull Bragantino</option>
                        <option value="Sepahan SC">Sepahan SC</option>
                        <option value="SL Benfica">SL Benfica</option>
                        <option value="Sporting CP">Sporting CP</option>
                        <option value="SS Lazio">SS Lazio</option>
                        <option value="Tottenham Hotspur FC">Tottenham Hotspur FC</option>
                        <option value="VfL Wolfsburg">VfL Wolfsburg</option>
                        <option value="Wolves">Wolves</option>
                    </select>
                    <div id="club-preview" class="club-preview">
                        <img id="club-logo-preview" class="club-logo-preview" src="" alt="Club Logo Preview" style="display: none;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="player-position">Position</label>
                    <select id="player-position">
                        <option value="GK">GK</option>
                        <option value="CB">CB</option>
                        <option value="LB">LB</option>
                        <option value="RB">RB</option>
                        <option value="DM">DM</option>
                        <option value="CM">CM</option>
                        <option value="AM">AM</option>
                        <option value="LW">LW</option>
                        <option value="RW">RW</option>
                        <option value="ST">ST</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="player-value">Value (RC)</label>
                    <input type="number" id="player-value" min="1" placeholder="Player value">
                </div>
            </div>
            
            <div id="stats-tab" class="tab-content">
                <div class="stats-header">
                    <h3>Player Statistics</h3>
                    <button id="add-stat-btn" class="add-stat-btn"><i class="fas fa-plus-circle"></i> Add New Stat</button>
                </div>
                
                <div id="stats-container" class="stats-container"></div>
            </div>
            
            <div class="tab-content" data-tab="image">
                <h3>Player Image</h3>
                <div class="form-group">
                    <label for="player-image-path">Image Path</label>
                    <input type="text" id="player-image-path" placeholder="../assets/images/players/...">
                </div>
                <div id="image-preview" style="margin-top: 20px; text-align: center;">
                    <!-- Image preview will be shown here -->
                </div>
            </div>
            
            <div class="buttons-container">
                <div>
                    <button id="save-btn">Save Changes</button>
                    <button id="cancel-btn">Cancel</button>
                </div>
                <button id="delete-btn" class="btn-delete">Delete Player</button>
            </div>
            
            <div id="status-message" class="status-message"></div>
        </div>
    </div>

    <!-- Add script tag with placeholder - will be filled in next edit -->
    <script defer src="github-config.js"></script>
    <script>
        // Authentication check
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading indicator
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = 'Loading...';
            statusElement.className = 'status-message status-success';
            statusElement.style.display = 'block';
            
            // First just check if logged in - do this synchronously for speed
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
            if (!isLoggedIn) {
                // Redirect to login page
                window.location.href = 'admin-login.html';
                return;
            }
            
            // Set logged in username immediately
            document.getElementById('logged-user').textContent = sessionStorage.getItem('adminUsername') || 'Admin';
            
            // Initialize the admin panel right away to show UI faster
            initAdminPanel().then(() => {
                // Check GitHub config after the UI is already showing
                if (!localStorage.getItem('githubToken')) {
                    const configMessage = document.createElement('div');
                    configMessage.className = 'status-message status-error';
                    configMessage.style.display = 'block';
                    configMessage.textContent = 'GitHub integration not configured. Changes will only be saved in memory.';
                    configMessage.style.marginBottom = '10px';
                    
                    // Add a setup button
                    const setupButton = document.createElement('button');
                    setupButton.textContent = 'Configure GitHub';
                    setupButton.style.marginTop = '5px';
                    setupButton.addEventListener('click', () => {
                        window.location.href = 'token-setup.html';
                    });
                    
                    configMessage.appendChild(setupButton);
                    
                    // Insert at the top of the player editor
                    const playerEditor = document.getElementById('player-editor');
                    playerEditor.insertBefore(configMessage, playerEditor.firstChild);
                }
            });
        });

        // Fast logout function
        function performLogout() {
            // Clear session data first for immediate response
            sessionStorage.removeItem('adminLoggedIn');
            sessionStorage.removeItem('adminUsername');
            
            // Redirect immediately to login page
            window.location.href = 'admin-login.html';
        }

        // Global variables
        let playersData = [];
        let currentPlayer = null;
        let clubsList = [];
        let isNewPlayer = false;
        let debounceTimer = null;
        
        // Pagination variables
        let currentPage = 1;
        const playersPerPage = 50;
        let filteredPlayers = [];
        let totalPages = 1;

        // Debounce function to improve performance for input events
        function debounce(func, delay = 300) {
            return function(...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        // Initialize admin panel
        async function initAdminPanel() {
            try {
                // Start with disabling editor while loading
                toggleEditorState(false);
                
                // Show loading in status element
                const statusElement = document.getElementById('status-message');
                statusElement.textContent = 'Loading player data...';
                statusElement.className = 'status-message status-success';
                statusElement.style.display = 'block';
                
                // Set up event listeners early
                setupEventListeners();
                
                // Load data with a timeout to allow UI to render first
                let loadedData = false;
                
                // Try to load data from server with timeout
                const loadPromise = new Promise(async (resolve) => {
                    try {
                        // First check if server is available - fast check
                        const serverAvailable = await isServerAvailable();
                        
                        if (serverAvailable) {
                            // Load from server
                            const response = await fetch('http://localhost:3000/players.json');
                            if (response.ok) {
                                playersData = await response.json();
                                console.log('Loaded data from Node.js server');
                                resolve(true);
                                return;
                            }
                        }
                        
                        // Fallback: Load from file
                        console.log('Server not available, loading from file');
                        const fallbackResponse = await fetch('players.json');
                        if (fallbackResponse.ok) {
                            playersData = await fallbackResponse.json();
                            
                            // Add unique ID to each player if missing
                            playersData = playersData.map((player, index) => ({
                                ...player,
                                id: player.id ? Number(player.id) : (index + 1)
                            }));
                            
                            console.log('Players loaded from file:', playersData.length);
                            
                            // Show server warning
                            showStatusMessage('Warning: Data server is not running. Changes will not be saved.', false);
                            resolve(true);
                        } else {
                            throw new Error('Failed to load players data');
                        }
                    } catch (error) {
                        console.error('Error loading data:', error);
                        resolve(false);
                    }
                });
                
                // Set timeout for loading
                const timeoutPromise = new Promise(resolve => {
                    setTimeout(() => {
                        if (!loadedData) {
                            statusElement.textContent = 'Still loading... This may take a moment.';
                        }
                        resolve(false);
                    }, 1500);
                });
                
                // Wait for data or timeout
                loadedData = await Promise.race([loadPromise, timeoutPromise]);
                
                // Wait for the actual data if timeout happened first
                if (!loadedData) {
                    loadedData = await loadPromise;
                }
                
                if (!loadedData) {
                    throw new Error('Failed to load players data');
                }
                
                // Extract clubs and populate UI
                extractClubs();
                
                // Reset pagination
                currentPage = 1;
                filteredPlayers = [...playersData];
                totalPages = Math.ceil(filteredPlayers.length / playersPerPage);
                
                // Render players
                populatePlayersList();
                
                // Show data summary
                showStatusMessage(`Loaded ${playersData.length} players. Showing page 1 of ${totalPages}.`, true, 3000);
                
                // Hide loading status if it was success
                if (statusElement.textContent === 'Loading player data...' || 
                    statusElement.textContent === 'Still loading... This may take a moment.') {
                    statusElement.style.display = 'none';
                }
                
                // Return a resolved promise for chaining
                return Promise.resolve();
                
            } catch (error) {
                showStatusMessage(`Error: ${error.message}`, false);
                console.error('Error initializing admin panel:', error);
                return Promise.resolve(); // Still resolve to continue
            }
        }

        // Helper function to determine if the server is available
        async function isServerAvailable() {
            try {
                // Use AbortController to implement a timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 500);  // 500ms timeout
                
                const response = await fetch('http://localhost:3000/players.json', {
                    method: 'HEAD',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                return response.ok;
            } catch (error) {
                console.log('Server check failed:', error.name);
                return false;
            }
        }

        // Extract unique clubs from player data
        function extractClubs() {
            // This function is now deprecated - using ClubManager instead
            console.log('Using ClubManager for club data');
            return window.ClubManager.initialize();
        }
        
        // Collect all unique team names from player stats
        function collectTeamNames() {
            // This function is now deprecated - using ClubManager instead
            console.log('Using ClubManager for team data');
        }

        // Populate players list
        function populatePlayersList(searchTerm = '') {
            const container = document.getElementById('players-container');
            container.innerHTML = '';
            
            // Filter players if there's a search term
            const lowerSearchTerm = searchTerm.toLowerCase();
            filteredPlayers = searchTerm 
                ? playersData.filter(player => player.name.toLowerCase().includes(lowerSearchTerm))
                : [...playersData];
            
            // Sort players by value (highest first)
            filteredPlayers.sort((a, b) => {
                // Sort by value (highest first)
                if (b.value !== a.value) {
                    return b.value - a.value;
                }
                // If values are equal, sort alphabetically by name
                return a.name.localeCompare(b.name);
            });
            
            // Calculate total pages
            totalPages = Math.ceil(filteredPlayers.length / playersPerPage);
            
            // Make sure current page is valid
            if (currentPage > totalPages) {
                currentPage = totalPages || 1;
            }
            
            // Get current page players
            const startIndex = (currentPage - 1) * playersPerPage;
            const endIndex = Math.min(startIndex + playersPerPage, filteredPlayers.length);
            const currentPagePlayers = filteredPlayers.slice(startIndex, endIndex);
            
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            
            // Show pagination info
            const paginationInfo = document.createElement('div');
            paginationInfo.className = 'pagination-info';
            paginationInfo.style.fontSize = '12px';
            paginationInfo.style.color = '#aaa';
            paginationInfo.style.margin = '5px 0 10px';
            paginationInfo.style.textAlign = 'center';
            paginationInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${filteredPlayers.length} players`;
            fragment.appendChild(paginationInfo);
            
            // Add players for current page
            currentPagePlayers.forEach(player => {
                const playerElement = document.createElement('div');
                playerElement.className = 'player-item';
                playerElement.dataset.id = player.id;
                
                const img = document.createElement('img');
                img.className = 'player-thumbnail';
                img.src = player.imagePath || player.img || 'https://via.placeholder.com/40';
                img.alt = player.name;
                img.loading = 'lazy'; // Lazy load images
                img.onerror = function() {
                    this.src = 'https://via.placeholder.com/40';
                };
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'player-name';
                nameSpan.textContent = player.name;
                
                const valueSpan = document.createElement('span');
                valueSpan.className = 'player-value';
                valueSpan.textContent = player.value;
                
                playerElement.appendChild(img);
                playerElement.appendChild(nameSpan);
                playerElement.appendChild(valueSpan);
                
                playerElement.addEventListener('click', () => {
                    selectPlayer(player.id);
                });
                
                fragment.appendChild(playerElement);
            });
            
            // Create pagination controls if more than one page
            if (totalPages > 1) {
                const paginationControls = document.createElement('div');
                paginationControls.className = 'pagination-controls';
                paginationControls.style.display = 'flex';
                paginationControls.style.justifyContent = 'center';
                paginationControls.style.marginTop = '15px';
                paginationControls.style.gap = '5px';
                
                const prevButton = document.createElement('button');
                prevButton.innerHTML = '&laquo;';
                prevButton.style.padding = '5px 10px';
                prevButton.style.backgroundColor = '#333';
                prevButton.style.border = '1px solid #444';
                prevButton.style.borderRadius = '4px';
                prevButton.style.color = '#fff';
                prevButton.style.cursor = 'pointer';
                prevButton.disabled = currentPage === 1;
                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        populatePlayersList(searchTerm);
                    }
                });
                
                const pageInfo = document.createElement('span');
                pageInfo.textContent = `${currentPage} / ${totalPages}`;
                pageInfo.style.padding = '5px 10px';
                pageInfo.style.backgroundColor = '#333';
                pageInfo.style.border = '1px solid #444';
                pageInfo.style.borderRadius = '4px';
                
                const nextButton = document.createElement('button');
                nextButton.innerHTML = '&raquo;';
                nextButton.style.padding = '5px 10px';
                nextButton.style.backgroundColor = '#333';
                nextButton.style.border = '1px solid #444';
                nextButton.style.borderRadius = '4px';
                nextButton.style.color = '#fff';
                nextButton.style.cursor = 'pointer';
                nextButton.disabled = currentPage === totalPages;
                nextButton.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        populatePlayersList(searchTerm);
                    }
                });
                
                paginationControls.appendChild(prevButton);
                paginationControls.appendChild(pageInfo);
                paginationControls.appendChild(nextButton);
                
                fragment.appendChild(paginationControls);
            }
            
            // Append all elements at once
            container.appendChild(fragment);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', performLogout);
            
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const tabName = tab.dataset.tab;
                    document.querySelector(`.tab-content[data-tab="${tabName}"]`).classList.add('active');
                });
            });
            
            // Player search
            const searchInput = document.getElementById('player-search');
            searchInput.addEventListener('input', debounce(function(e) {
                const searchTerm = e.target.value.toLowerCase();
                currentPage = 1; // Reset to first page on search
                populatePlayersList(searchTerm);
            }, 250));
            
            // Club dropdown - using select element now, no need for options container
            const clubInput = document.getElementById('player-club');
            
            // Set up club dropdown change event
            clubInput.addEventListener('change', function() {
                const selectedClub = this.value;
                
                // Update the club logo preview
                if (selectedClub) {
                    updateClubLogoPreview(selectedClub);
                } else {
                    // Hide the logo if no club is selected
                    const clubLogoPreview = document.getElementById('club-logo-preview');
                    if (clubLogoPreview) {
                        clubLogoPreview.style.display = 'none';
                    }
                }
            });
            
            // Global click handler for dropdowns (both club and team dropdowns)
            document.addEventListener('click', (e) => {
                // Handle club options dropdown
                if (clubOptions && !clubInput.contains(e.target) && !clubOptions.contains(e.target)) {
                    clubOptions.style.display = 'none';
                }
                
                // Handle all team options dropdowns in stat items
                const teamDropdowns = document.querySelectorAll('.team-dropdown');
                teamDropdowns.forEach(dropdown => {
                    const teamInput = dropdown.querySelector('.team-search');
                    const teamOptions = dropdown.querySelector('.team-options');
                    
                    if (teamInput && teamOptions && !teamInput.contains(e.target) && !teamOptions.contains(e.target)) {
                        teamOptions.style.display = 'none';
                    }
                });
            });
            
            // Add new player button
            document.getElementById('add-player-btn').addEventListener('click', createNewPlayer);
            
            // Save button
            document.getElementById('save-btn').addEventListener('click', savePlayerChanges);
            
            // Cancel button
            document.getElementById('cancel-btn').addEventListener('click', () => {
                if (currentPlayer) {
                    loadPlayerData(currentPlayer.id);
                } else {
                    toggleEditorState(false);
                }
            });
            
            // Delete button
            document.getElementById('delete-btn').addEventListener('click', deletePlayer);
            
            // Add stat buttons (both top and bottom)
            document.getElementById('add-stat-btn').addEventListener('click', () => addStatItem());
            
            // Image path input change
            const imagePathInput = document.getElementById('player-image-path');
            imagePathInput.addEventListener('input', debounce(updateImagePreview, 300));
        }

        // Select player by ID
        function selectPlayer(playerId) {
            // Convert playerId to number to ensure consistent comparison
            playerId = Number(playerId);
            
            // Find the player in the data
            currentPlayer = playersData.find(p => Number(p.id) === playerId);
            
            if (!currentPlayer) {
                console.error("Player not found with ID:", playerId);
                showStatusMessage("Error: Player not found", false);
                return;
            }
            
            // Highlight selected player if it's on the current page
            document.querySelectorAll('.player-item').forEach(item => {
                item.classList.remove('selected');
                if (Number(item.dataset.id) === playerId) {
                    item.classList.add('selected');
                    // Scroll the player into view
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
            
            // If player is not on current page, try to find and navigate to their page
            const playerIndex = filteredPlayers.findIndex(p => Number(p.id) === playerId);
            if (playerIndex !== -1) {
                const playerPage = Math.floor(playerIndex / playersPerPage) + 1;
                if (playerPage !== currentPage) {
                    currentPage = playerPage;
                    populatePlayersList(document.getElementById('player-search').value);
                    
                    // Re-select the player after page change (small delay to let DOM update)
                    setTimeout(() => {
                        document.querySelectorAll('.player-item').forEach(item => {
                            item.classList.remove('selected');
                            if (Number(item.dataset.id) === playerId) {
                                item.classList.add('selected');
                                item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }
                        });
                    }, 50);
                }
            }
            
            // Load player data
            loadPlayerData(playerId);
            
            // Enable editor
            toggleEditorState(true);
            isNewPlayer = false;
        }

        // Load player data into editor
        function loadPlayerData(playerId) {
            // Convert playerId to number to ensure consistent comparison
            playerId = Number(playerId);
            
            currentPlayer = playersData.find(p => Number(p.id) === playerId);
            if (!currentPlayer) {
                console.error("loadPlayerData: Player not found with ID:", playerId);
                return;
            }
            
            // Basic info tab
            document.getElementById('player-name').value = currentPlayer.name || '';
            document.getElementById('player-star').value = currentPlayer.star || '3-star-standard';
            document.getElementById('player-level').value = currentPlayer.level || 'STANDARD';
            document.getElementById('player-club').value = currentPlayer.club || '';
            document.getElementById('player-position').value = currentPlayer.position || 'ST';
            document.getElementById('player-value').value = currentPlayer.value || '';
            
            // Update club logo preview
            updateClubLogoPreview(currentPlayer.club, currentPlayer.clubLogo);
            
            // Image tab - also handle stats property correctly
            document.getElementById('player-image-path').value = currentPlayer.imagePath || currentPlayer.img || '';
            updateImagePreview();
            
            // Stats tab
            populateStatsContainer();
        }

        // Toggle editor state (enabled/disabled)
        function toggleEditorState(enabled) {
            const editorInputs = document.querySelectorAll('#player-editor input, #player-editor select, #player-editor button:not(#add-player-btn)');
            editorInputs.forEach(input => {
                input.disabled = !enabled;
            });
            
            document.getElementById('player-editor').style.opacity = enabled ? '1' : '0.7';
            document.getElementById('delete-btn').style.display = isNewPlayer ? 'none' : 'block';
        }

        // Create new player
        function createNewPlayer() {
            isNewPlayer = true;
            
            // Generate a temporary ID (negative to avoid conflicts)
            const tempId = -Date.now();
            
            // Create empty player object
            currentPlayer = {
                id: tempId,
                name: '',
                star: '3-star-standard',
                level: 'STANDARD',
                club: '',
                clubLogo: '',
                position: 'ST',
                value: 1,
                imagePath: '',  // Change from img to imagePath to match the rest of the code
                stats: []
            };
            
            // Deselect all players
            document.querySelectorAll('.player-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Reset form
            document.getElementById('player-name').value = '';
            document.getElementById('player-star').value = '3-star-standard';
            document.getElementById('player-level').value = 'STANDARD';
            document.getElementById('player-club').value = '';
            document.getElementById('player-position').value = 'ST';
            document.getElementById('player-value').value = '1';
            document.getElementById('player-image-path').value = '';
            
            // Clear stats
            document.getElementById('stats-container').innerHTML = '';
            
            // Enable editor
            toggleEditorState(true);
            document.getElementById('delete-btn').style.display = 'none';
            
            // Switch to basic info tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.tab[data-tab="basic"]').classList.add('active');
            document.querySelector('.tab-content[data-tab="basic"]').classList.add('active');
            
            // Focus on name field
            document.getElementById('player-name').focus();
        }

        // Save player changes
        async function savePlayerChanges() {
            // First give immediate UI feedback that save was clicked
            const saveBtn = document.getElementById('save-btn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;
            
            try {
                // Validate required fields
                const playerName = document.getElementById('player-name').value.trim();
                const playerValue = parseInt(document.getElementById('player-value').value);
                
                if (!playerName) {
                    throw new Error('Player name is required');
                }
                
                if (isNaN(playerValue) || playerValue < 1) {
                    throw new Error('Player value must be a positive number');
                }
                
                // Update current player object with form values immediately
                const updatedPlayer = {
                    ...currentPlayer,
                    name: playerName,
                    star: document.getElementById('player-star').value,
                    level: document.getElementById('player-level').value,
                    club: document.getElementById('player-club').value,
                    position: document.getElementById('player-position').value,
                    value: playerValue,
                    imagePath: document.getElementById('player-image-path').value
                };
                
                // Process stats
                const statItems = document.querySelectorAll('.stat-item');
                const stats = [];
                
                statItems.forEach(item => {
                    const season = item.querySelector('[data-stat-season]').value;
                    const team = item.querySelector('[data-stat-team]').value;
                    const value = item.querySelector('[data-stat-value]').value;
                    
                    if (season && team && value) {
                        stats.push({
                            season,
                            team,
                            value
                        });
                    }
                });
                
                updatedPlayer.stats = stats;
                
                // Update club logo if it exists
                const matchingClub = clubsList.find(c => c.name === updatedPlayer.club);
                if (matchingClub) {
                    updatedPlayer.clubLogo = matchingClub.logo;
                }
                
                // Update in memory immediately - don't wait for server
                if (isNewPlayer) {
                    // Find the highest existing ID and increment by 1
                    const maxId = Math.max(...playersData.map(p => p.id), 0);
                    updatedPlayer.id = maxId + 1;
                    playersData.push(updatedPlayer);
                    
                    // Add to filtered players if applicable
                    const searchTerm = document.getElementById('player-search').value.toLowerCase();
                    if (!searchTerm || updatedPlayer.name.toLowerCase().includes(searchTerm)) {
                        // Add to filtered players and re-sort
                        filteredPlayers.push(updatedPlayer);
                        
                        // Navigate to the page with the new player
                        currentPage = Math.ceil(filteredPlayers.length / playersPerPage);
                    }
                } else {
                    // Update existing player
                    const playerIndex = playersData.findIndex(p => Number(p.id) === Number(currentPlayer.id));
                    if (playerIndex !== -1) {
                        playersData[playerIndex] = updatedPlayer;
                        
                        // Update in filtered players if present
                        const filteredIndex = filteredPlayers.findIndex(p => Number(p.id) === Number(currentPlayer.id));
                        if (filteredIndex !== -1) {
                            filteredPlayers[filteredIndex] = updatedPlayer;
                        }
                    } else {
                        throw new Error('Player not found in the database');
                    }
                }
                
                // Update current player reference and reset state
                currentPlayer = updatedPlayer;
                isNewPlayer = false;
                
                // Update players list to show changes immediately
                populatePlayersList(document.getElementById('player-search').value);
                
                // Reselect the current player in the list
                selectPlayer(currentPlayer.id);
                
                // Show immediate success message
                showStatusMessage('Player saved in memory. Saving to storage...', true);
                
                // Now try saving to persistence (GitHub or server) in background
                let savedPermanently = false;
                
                // First priority: GitHub if configured
                const useGithub = localStorage.getItem('githubToken');
                if (useGithub) {
                    try {
                        await saveToGitHub();
                        savedPermanently = true;
                    } catch (githubError) {
                        console.error('GitHub save failed:', githubError);
                        // Continue to try server save if GitHub fails
                    }
                }
                
                // Second priority: Local server if GitHub failed or not configured
                if (!savedPermanently) {
                    const serverAvailable = await isServerAvailable();
                    if (serverAvailable) {
                        try {
                            // Save updated data to JSON file using the Node.js server
                            const saveResponse = await fetch('http://localhost:3000/save-players', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(playersData)
                            });
                            
                            if (!saveResponse.ok) {
                                const errorData = await saveResponse.json();
                                throw new Error(errorData.message || 'Failed to save changes');
                            }
                            
                            savedPermanently = true;
                            showStatusMessage('Changes saved to server!', true);
                        } catch (serverError) {
                            console.error('Server save failed:', serverError);
                        }
                    }
                }
                
                // If neither GitHub nor server saved, show warning
                if (!savedPermanently) {
                    showStatusMessage('Warning: Changes are only in memory. Configure GitHub integration to save permanently.', false);
                }
                
            } catch (error) {
                showStatusMessage(error.message, false);
                console.error('Error saving player changes:', error);
            } finally {
                // Always restore button state
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }

        // Delete player
        async function deletePlayer() {
            if (!currentPlayer || isNewPlayer) return;
            
            if (!confirm(`Are you sure you want to delete ${currentPlayer.name}?`)) {
                return;
            }
            
            try {
                // Store player ID for later use
                const playerId = Number(currentPlayer.id);
                
                // Remove player from main array
                const playerIndex = playersData.findIndex(p => Number(p.id) === playerId);
                if (playerIndex !== -1) {
                    playersData.splice(playerIndex, 1);
                    
                    // Also remove from filtered players if present
                    const filteredIndex = filteredPlayers.findIndex(p => Number(p.id) === playerId);
                    if (filteredIndex !== -1) {
                        filteredPlayers.splice(filteredIndex, 1);
                    }
                    
                    // Calculate new total pages
                    totalPages = Math.ceil(filteredPlayers.length / playersPerPage);
                    
                    // Adjust current page if needed
                    if (currentPage > totalPages) {
                        currentPage = totalPages || 1;
                    }
                    
                    // Check if GitHub integration is configured
                    const useGithub = localStorage.getItem('githubToken');
                    
                    if (useGithub) {
                        // Save to GitHub
                        await saveToGitHub();
                    } else {
                        // Try server if available
                        const serverAvailable = await isServerAvailable();
                        
                        if (serverAvailable) {
                            // Save updated data to JSON file using the Node.js server
                            const saveResponse = await fetch('http://localhost:3000/save-players', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(playersData)
                            });
                            
                            if (!saveResponse.ok) {
                                const errorData = await saveResponse.json();
                                throw new Error(errorData.message || 'Failed to save changes');
                            }
                        } else {
                            // Server not available, show warning
                            showStatusMessage('Warning: Changes are only in memory. Configure GitHub integration to save permanently.', false);
                        }
                    }
                    
                    // Update players list with current search term
                    populatePlayersList(document.getElementById('player-search').value);
                    
                    // Reset editor
                    currentPlayer = null;
                    toggleEditorState(false);
                    
                    showStatusMessage('Player deleted successfully!', true);
                } else {
                    throw new Error('Player not found in the database');
                }
            } catch (error) {
                showStatusMessage(error.message, false);
                console.error('Error deleting player:', error);
            }
        }

        // Populate stats container
        function populateStatsContainer() {
            const container = document.getElementById('stats-container');
            container.innerHTML = '';

            if (currentPlayer && currentPlayer.stats && currentPlayer.stats.length > 0) {
                currentPlayer.stats.forEach(stat => {
                    addStatItem(stat.season, stat.team, stat.value);
                });
            }
        }

        // Add stat item with the correct fields matching the JSON structure
        function addStatItem(season, team, value) {
            const container = document.getElementById('stats-container');
            const statItem = document.createElement('div');
            statItem.className = 'stat-item';
            
            const seasonInput = document.createElement('input');
            seasonInput.type = 'text';
            seasonInput.value = season || '';
            seasonInput.className = 'season-input';
            seasonInput.placeholder = 'Season (e.g. 2023/24)';
            seasonInput.dataset.statSeason = 'true';
            
            // Create team dropdown select element
            const teamSelect = document.createElement('select');
            teamSelect.className = 'team-select';
            teamSelect.dataset.statTeam = 'true';
            
            // Add empty option
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = '-- Select Club --';
            teamSelect.appendChild(emptyOption);
            
            // Add club options (same as in the main club dropdown)
            const clubOptions = [
                "FREE AGENT", "AC Milan", "AFC Ajax", "Al Hilal SFC", "Al-Nassr FC", 
                "Arsenal FC", "AS Roma", "Aston Villa FC", "Atalanta BC", "Atletico de Madrid", 
                "Bayer Leverkusen", "Borussia Dortmund", "Chelsea FC", "FC Barcelona", 
                "FC Bayern Munich", "FC Porto", "FSV MAINZ 05", "Inter Miami", "Inter Milan", 
                "Liverpool FC", "LOSC Lille", "Manchester City FC", "Manchester United FC", 
                "Mohun Bagan AC", "Mumbai City FC", "Newcastle United FC", "Paris Saint-Germain FC", 
                "Randers FC", "Rangers FC", "RB Leipzig", "RC Lens", "Real Madrid CF", 
                "Red Bull Bragantino", "Sepahan SC", "SL Benfica", "Sporting CP", "SS Lazio", 
                "Tottenham Hotspur FC", "VfL Wolfsburg", "Wolves"
            ];
            
            // Add options to dropdown
            clubOptions.forEach(club => {
                const option = document.createElement('option');
                option.value = club;
                option.textContent = club;
                if (team === club) {
                    option.selected = true;
                }
                teamSelect.appendChild(option);
            });
            
            teamSelect.addEventListener('focus', async () => {
                // Make sure club data is initialized
                if (!window.ClubManager.initialized) {
                    await window.ClubManager.initialize();
                }
                
                populateTeamOptions(teamOptions, teamSelect, '');
                teamOptions.style.display = 'block';
            });
            
            teamSelect.addEventListener('input', async function() {
                // Make sure club data is initialized
                if (!window.ClubManager.initialized) {
                    await window.ClubManager.initialize();
                }
                
                populateTeamOptions(teamOptions, teamSelect, this.value);
                teamOptions.style.display = 'block';
            });
            
            teamSelect.addEventListener('blur', () => {
                setTimeout(() => {
                    teamOptions.style.display = 'none';
                }, 150);
            });
            
            const valueInput = document.createElement('input');
            valueInput.type = 'number';
            valueInput.value = value || '';
            valueInput.className = 'value-input';
            valueInput.placeholder = 'Value';
            valueInput.dataset.statValue = 'true';
            
            const btnContainer = document.createElement('div');
            btnContainer.className = 'stat-controls';
            
            const moveUpBtn = document.createElement('button');
            moveUpBtn.className = 'move-up-btn';
            moveUpBtn.innerHTML = '<i class="fas fa-chevron-up"></i>';
            moveUpBtn.title = 'Move Up';
            moveUpBtn.addEventListener('click', (e) => {
                e.preventDefault();
                moveStatUp(statItem);
            });
            
            const moveDownBtn = document.createElement('button');
            moveDownBtn.className = 'move-down-btn';
            moveDownBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';
            moveDownBtn.title = 'Move Down';
            moveDownBtn.addEventListener('click', (e) => {
                e.preventDefault();
                moveStatDown(statItem);
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteBtn.title = 'Delete';
            deleteBtn.addEventListener('click', (e) => {
                e.preventDefault();
                statItem.remove();
            });
            
            btnContainer.appendChild(moveUpBtn);
            btnContainer.appendChild(moveDownBtn);
            btnContainer.appendChild(deleteBtn);
            
            statItem.appendChild(seasonInput);
            statItem.appendChild(teamSelect);
            statItem.appendChild(valueInput);
            statItem.appendChild(btnContainer);
            
            container.appendChild(statItem);
        }

        // Move stat item up
        function moveStatUp(statItem) {
            const container = document.getElementById('stats-container');
            const prevStat = statItem.previousElementSibling;
            
            if (prevStat) {
                container.insertBefore(statItem, prevStat);
            }
        }
        
        // Move stat item down
        function moveStatDown(statItem) {
            const container = document.getElementById('stats-container');
            const nextStat = statItem.nextElementSibling;
            
            if (nextStat) {
                container.insertBefore(nextStat, statItem);
            }
        }
        
        // Populate team options for stat dropdowns
        function populateTeamOptions(container, inputElement, searchTerm = '') {
            // Use the ClubManager to populate team options
            window.ClubManager.populateClubOptions(container, inputElement, searchTerm, club => {
                // Update any related UI or data after selection
                    inputElement.value = club.name;
                    container.style.display = 'none';
                });
        }

        // Populate club options
        function populateClubOptions(searchTerm = '') {
            const container = document.getElementById('club-options');
            const inputElement = document.getElementById('player-club');
            
            // Use the ClubManager to populate club options
            window.ClubManager.populateClubOptions(container, inputElement, searchTerm, club => {
                // Update player club and related UI
                document.getElementById('player-club').value = club.name;
                
                // Update in club logo preview if it exists
                const clubLogoPreview = document.getElementById('club-logo-preview');
                if (clubLogoPreview) {
                    clubLogoPreview.src = club.logo || '';
                    clubLogoPreview.style.display = club.logo ? 'block' : 'none';
                    clubLogoPreview.onerror = function() {
                        this.style.display = 'none';
                    };
                }
            });
        }

        // Update image preview
        function updateImagePreview() {
            const imagePath = document.getElementById('player-image-path').value;
            const previewContainer = document.getElementById('image-preview');
            
            if (imagePath) {
                const img = document.createElement('img');
                img.src = imagePath;
                img.alt = 'Player image preview';
                img.style.maxWidth = '200px';
                img.style.maxHeight = '200px';
                img.style.border = '2px solid rgba(255, 255, 255, 0.1)';
                img.onerror = function() {
                    previewContainer.innerHTML = '<p style="color: #f44336;">Invalid image path</p>';
                };
                
                previewContainer.innerHTML = '';
                previewContainer.appendChild(img);
            } else {
                previewContainer.innerHTML = '<p>No image path provided</p>';
            }
        }

        // Update club logo preview
        function updateClubLogoPreview(clubName, clubLogo) {
            const clubLogoPreview = document.getElementById('club-logo-preview');
            if (!clubLogoPreview) return;
            
            // If no club name, hide preview and return
            if (!clubName) {
                clubLogoPreview.style.display = 'none';
                return;
            }
            
            // First try to use the provided clubLogo if available
            if (clubLogo) {
                clubLogoPreview.src = clubLogo;
                clubLogoPreview.style.display = 'block';
                clubLogoPreview.alt = clubName || 'Club logo';
                
                // Handle image load errors
                clubLogoPreview.onerror = function() {
                    // Try alternative sources
                    tryAlternativeLogoSources(clubName, clubLogoPreview);
                };
                return;
            }
            
            // If no direct logo provided but we have a club name, try to find it from ClubManager
            if (window.ClubManager && window.ClubManager.initialized) {
                const club = window.ClubManager.findClubByName(clubName);
                if (club && club.logo) {
                    clubLogoPreview.src = club.logo;
                    clubLogoPreview.style.display = 'block';
                    clubLogoPreview.alt = clubName;
                    
                    // Handle image load errors
                    clubLogoPreview.onerror = function() {
                        // Try alternative sources
                        tryAlternativeLogoSources(clubName, clubLogoPreview);
                    };
                    return;
                }
            }
            
            // If we've reached here, try alternative sources
            tryAlternativeLogoSources(clubName, clubLogoPreview);
        }
        
        // Helper function to try different ways to get a club logo
        function tryAlternativeLogoSources(clubName, imgElement) {
            if (!clubName || !imgElement) return;
            
            // Generate an SVG placeholder that doesn't require network requests
            function generateSvgPlaceholder(name) {
                // Extract initials and clean up
                const cleanText = name.substring(0, 2).replace(/[^\w]/g, '');
                // Create SVG data URL with club initials
                return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Crect width='40' height='40' fill='%23333'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='14' fill='white' text-anchor='middle' dy='.3em'%3E${cleanText}%3C/text%3E%3C/svg%3E`;
            }
            
            // Using an SVG placeholder avoids network requests
            imgElement.src = generateSvgPlaceholder(clubName);
            imgElement.style.display = 'block';
            
            // If Club Manager is available, use it to get the normalized name
            if (window.ClubManager && window.ClubManager.normalizeClubName) {
                const normalizedName = window.ClubManager.normalizeClubName(clubName);
                
                // Use the normalized name to get the correct logo path
                if (normalizedName) {
                    const logoPath = `assets/images/players/club/${normalizedName}.webp`;
                    const lowResPath = `assets/images/players/club/${normalizedName}-low.webp`;
                    
                    // Try to load the actual logo
                    const actualImg = new Image();
                    actualImg.onload = function() {
                        // Only update if successfully loaded
                        imgElement.src = this.src;
                    };
                    
                    // Try high-res version first, then low-res version as fallback
                    actualImg.onerror = function() {
                        // Try low-res version
                        actualImg.onerror = null; // Prevent infinite loop
                        actualImg.src = lowResPath;
                    };
                    
                    // Start with high-res version
                    actualImg.src = logoPath;
                    return;
                }
            }
            
            // Fallback to trying multiple paths if ClubManager is not available
            // Try to load the actual logo in the background without error notifications
            const actualImg = new Image();
            actualImg.onload = function() {
                // Only update if successfully loaded
                imgElement.src = this.src;
            };
            
            // Try different paths and formats silently
            const paths = [
                // Try different formats with the club name
                `assets/images/players/club/${clubName}.webp`,
                `assets/images/players/club/${clubName}-low.webp`,
                `assets/images/players/club/${clubName}.png`
            ];
            
            // Try paths sequentially without logging errors
            let currentIndex = 0;
            
            function tryNextPath() {
                if (currentIndex >= paths.length) return;
                
                actualImg.onerror = () => {
                    currentIndex++;
                    if (currentIndex < paths.length) {
                        actualImg.src = paths[currentIndex];
                    }
                };
                
                actualImg.src = paths[currentIndex];
            }
            
            // Start trying paths
            tryNextPath();
        }

        // Show status message
        function showStatusMessage(message, isSuccess, duration = 5000) {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.className = 'status-message';
            statusElement.classList.add(isSuccess ? 'status-success' : 'status-error');
            statusElement.style.display = 'block';
            
            // Hide after duration
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, duration);
        }

        // Save to GitHub
        async function saveToGitHub() {
            try {
                // Check if GitHub integration is configured
                if (!githubConfig.isConfigured()) {
                    throw new Error('GitHub integration is not configured');
                }
                
                // Show saving message
                showStatusMessage('Saving to GitHub...', true);
                
                // Get repository details
                const repoDetails = {
                    owner: githubConfig.getOwner(),
                    repo: githubConfig.getRepo(),
                    path: localStorage.getItem('githubJsonPath') || githubConfig.filePath,
                    branch: githubConfig.getBranch()
                };
                
                // Get the current file to get its SHA (required for the GitHub API)
                const fileInfoResponse = await fetch(`https://api.github.com/repos/${repoDetails.owner}/${repoDetails.repo}/contents/${repoDetails.path}?ref=${repoDetails.branch}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.getToken()}`
                    }
                });
                
                let currentSHA = '';
                let fileExists = true;
                
                if (fileInfoResponse.status === 404) {
                    // File doesn't exist yet
                    fileExists = false;
                } else if (!fileInfoResponse.ok) {
                    const errorData = await fileInfoResponse.json();
                    throw new Error(`GitHub API error: ${errorData.message}`);
                } else {
                    // File exists, get its SHA
                    const fileInfo = await fileInfoResponse.json();
                    currentSHA = fileInfo.sha;
                }
                
                // Prepare the content
                const jsonString = JSON.stringify(playersData, null, 2);
                const content = btoa(unescape(encodeURIComponent(jsonString)));
                
                // Prepare the commit message
                const commitMessage = localStorage.getItem('githubCommitMessage') || 'Update player data';
                
                // Prepare the request body
                const requestBody = {
                    message: `${commitMessage} - ${new Date().toISOString()}`,
                    content: content,
                    branch: repoDetails.branch
                };
                
                // Add SHA if the file exists
                if (fileExists) {
                    requestBody.sha = currentSHA;
                }
                
                // Commit the updated file
                const commitResponse = await fetch(`https://api.github.com/repos/${repoDetails.owner}/${repoDetails.repo}/contents/${repoDetails.path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!commitResponse.ok) {
                    const errorData = await commitResponse.json();
                    throw new Error(`GitHub API error: ${errorData.message}`);
                }
                
                showStatusMessage('Changes saved to GitHub! The site will update in a few minutes.', true);
                
            } catch (error) {
                showStatusMessage(`GitHub Error: ${error.message}`, false);
                console.error('GitHub save error:', error);
                throw error; // Re-throw to be handled by the caller
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize club data first to ensure it's available
            await window.ClubManager.initialize();
            
            // Load players data through initAdminPanel() instead
            initAdminPanel();
            
            // Add event listeners
            setupEventListeners();
            
            // Setup club search functionality
            setupClubSearchFunctionality();
        });

        // Set up club search functionality
        function setupClubSearchFunctionality() {
            const clubSelect = document.getElementById('player-club');
            
            // Set up club dropdown functionality
            clubSelect.addEventListener('change', function() {
                const selectedClub = this.value;
                
                // Update the club logo preview
                if (selectedClub) {
                    updateClubLogoPreview(selectedClub);
                } else {
                    // Hide the logo if no club is selected
                    const clubLogoPreview = document.getElementById('club-logo-preview');
                    if (clubLogoPreview) {
                        clubLogoPreview.style.display = 'none';
                    }
                }
            });
            
            // Add club logo preview if not exists
            const clubPreviewContainer = document.getElementById('club-preview');
            if (clubPreviewContainer && !document.getElementById('club-logo-preview')) {
                const clubLogoPreview = document.createElement('img');
                clubLogoPreview.id = 'club-logo-preview';
                clubLogoPreview.className = 'club-logo-preview';
                clubLogoPreview.style.maxWidth = '50px';
                clubLogoPreview.style.maxHeight = '50px';
                clubLogoPreview.style.marginTop = '5px';
                clubLogoPreview.style.display = 'none';
                clubPreviewContainer.appendChild(clubLogoPreview);
            }
        }
    </script>

    <!-- Performance optimization JS -->
    <script>
        // Immediately executed critical JS
        document.addEventListener('DOMContentLoaded', function() {
            // Load the video after page content
            setTimeout(function() {
                const video = document.querySelector('.video-bg');
                if (video && video.dataset.src) {
                    const source = document.createElement('source');
                    source.src = video.dataset.src;
                    source.type = 'video/mp4';
                    video.appendChild(source);
                    video.load();
                    video.play().catch(e => console.log('Autoplay prevented:', e));
                }
            }, 1000);
            
            // Set fade out for preloader
            window.addEventListener('load', function() {
                const preloader = document.querySelector('.preloader');
                if (preloader) {
                    setTimeout(function() {
                        preloader.style.opacity = '0';
                        setTimeout(function() {
                            preloader.style.display = 'none';
                        }, 500);
                    }, 500);
                }
            });
        });
    </script>
    
    <!-- Load performance optimizations -->
    <script defer src="js/performance.js"></script>
    <!-- Load background scroll handling -->
    <script defer src="js/background-scroll.js"></script>

    <!-- Service worker registration -->
    <script defer src="js/sw-register.js"></script>
    
    <!-- Performance optimizations -->
    <script defer src="js/performance.js"></script>
    <script defer src="js/image-optimization.js"></script>

</body>
</html> 