<!DOCTYPE html>
<html lang="en">
<head>
    <!-- PWA support -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3498db">
    <link rel="apple-touch-icon" href="/assets/images/logo11.webp">

    <!-- DNS prefetch and preconnect -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" media="print" onload="this.media='all'" crossorigin>
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"></noscript>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://assets.mixkit.co">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="icon" href="assets/images/logo11.webp" type="image/webp">
    <link rel="shortcut icon" href="assets/images/logo11.webp" type="image/webp">
    <link rel="apple-touch-icon" href="/assets/images/logo11.webp">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>R2G Transfer Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" media="print" onload="this.media='all'" crossorigin>
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"></noscript>
    <link rel="stylesheet" href="css/club-dropdown.css">
    <!-- Load club manager scripts in the correct order -->
    <script src="js/club-loader.js"></script>
    <script>
        // Fallback if club-loader.js fails to load
        if (typeof window.ClubManager === 'undefined') {
            console.warn('club-loader.js not loaded, creating fallback ClubManager');
            window.ClubManager = {
                initialize: function() { console.log('Fallback ClubManager initialize called'); },
                getClub: function(clubName) { 
                    return { 
                        name: clubName, 
                        logo: `assets/images/players/club/${clubName.replace(/\s+/g, '-').toLowerCase()}.webp` 
                    }; 
                },
                initialized: false
            };
        }
    </script>
    <script src="js/club-manager.js"></script>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
        }
        .header {
            background-color: #1e1e1e;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            color: #fff;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .username {
            color: #4ecca3;
        }
        .logout-btn {
            background-color: #e53935;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .logout-btn:hover {
            background-color: #c62828;
        }
        .container {
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 70px);
            box-sizing: border-box;
            max-width: 1400px;
            margin: 0 auto;
        }
        .team-selection {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-left: 4px solid #4ecca3;
        }
        .team-selection h2 {
            color: #fff;
            font-size: 20px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #393939;
            display: flex;
            align-items: center;
        }
        .team-selection h2:before {
            content: "\f1e3";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            margin-right: 10px;
            color: #4ecca3;
        }
        .team-selector-container {
            position: relative;
        }
        .team-selector-container:after {
            content: "\f078";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #4ecca3;
            pointer-events: none;
        }
        #team-selector {
            appearance: none;
            padding: 12px 15px;
            background-color: #252525;
            border: 1px solid #333;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        #team-selector:hover {
            border-color: #4ecca3;
        }
        #team-selector:focus {
            border-color: #4ecca3;
            box-shadow: 0 0 0 2px rgba(78, 204, 163, 0.2);
        }
        #debug-controls {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
        }
        #debug-select-team {
            background-color: #333;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        #debug-select-team:hover {
            background-color: #444;
        }
        #debug-select-team:active {
            transform: translateY(1px);
        }
        .players-container {
            display: flex;
            flex: 1;
            gap: 20px;
        }
        .available-players {
            flex: 1;
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
            max-height: 700px;
        }
        .selected-players {
            flex: 1;
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
            max-height: 700px;
        }
        h2 {
            margin-top: 0;
            border-bottom: 1px solid #393939;
            padding-bottom: 10px;
            color: #fff;
        }
        .search-box {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #252525;
            color: #fff;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .search-box:focus {
            border-color: #4ecca3;
            outline: none;
            box-shadow: 0 0 0 2px rgba(78, 204, 163, 0.2);
        }
        .player-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s;
            background-color: #252525;
            animation: fadeIn 0.3s ease-out;
        }
        .player-item:hover {
            background-color: #303030;
            transform: translateY(-2px);
        }
        .player-thumbnail {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            margin-right: 12px;
            object-fit: cover;
        }
        .player-info {
            flex-grow: 1;
        }
        .player-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: bold;
            color: #fff;
        }
        .player-details {
            font-size: 12px;
            color: #aaa;
            margin-top: 2px;
        }
        .player-value {
            color: #4ecca3;
            font-weight: bold;
            margin-left: 5px;
            padding: 3px 8px;
            background-color: rgba(78, 204, 163, 0.1);
            border-radius: 4px;
        }
        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #3f51b5;
            color: white;
            border: none;
            cursor: pointer;
            margin-left: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }
        .action-btn:hover {
            transform: scale(1.1);
        }
        .add-btn {
            background-color: #4ecca3;
        }
        .add-btn:hover {
            background-color: #3da88a;
        }
        .remove-btn {
            background-color: #e53935;
        }
        .remove-btn:hover {
            background-color: #c62828;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #e0e0e0;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #252525;
            color: #fff;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus {
            border-color: #4ecca3;
            outline: none;
            box-shadow: 0 0 0 2px rgba(78, 204, 163, 0.2);
        }
        .team-dropdown {
            position: relative;
        }
        .team-search {
            padding-right: 30px;
        }
        .team-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #252525;
            border: 1px solid #444;
            border-radius: 0 0 6px 6px;
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .club-option {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            user-select: none;
        }
        .club-option:hover {
            background-color: #303030;
            transform: translateX(3px);
        }
        .club-option:last-child {
            border-bottom: none;
        }
        .club-logo {
            width: 28px;
            height: 28px;
            margin-right: 12px;
            object-fit: contain;
        }
        .club-option span {
            color: #fff;
            font-size: 14px;
            font-weight: 500;
        }
        .transfer-settings {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .transfer-item {
            background-color: #252525;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            position: relative;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .transfer-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .transfer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        .submit-container {
            margin-top: 20px;
            text-align: right;
        }
        .submit-btn {
            background-color: #4ecca3;
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .submit-btn:hover {
            background-color: #3da88a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .submit-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .status-message {
            padding: 12px 16px;
            margin-top: 15px;
            border-radius: 6px;
            display: none;
            font-weight: 500;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .status-success {
            background-color: rgba(78, 204, 163, 0.15);
            color: #4ecca3;
            border: 1px solid rgba(78, 204, 163, 0.3);
        }
        .status-error {
            background-color: rgba(229, 57, 53, 0.15);
            color: #e57373;
            border: 1px solid rgba(229, 57, 53, 0.3);
        }
        .filters {
            display: flex;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .filter-group {
            width: 100%;
        }
        
        .filter-group input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            font-size: 15px;
            border-radius: 6px;
            border: 1px solid #444;
            background-color: #252525;
            color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 768px) {
            .filters {
                margin-bottom: 10px;
            }
            
            .filter-group input[type="text"] {
                padding: 10px 12px;
                font-size: 14px;
            }
        }
        .season-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .season-input input {
            width: 80px;
        }
        .season-input span {
            color: #bbb;
        }
        .selected-team-display {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 18px;
            margin-bottom: 18px;
            padding: 16px;
            background-color: #252525;
            border-radius: 8px;
            border-left: 4px solid #4ecca3;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.3s ease-out;
        }
        
        .selected-team-logo {
            width: 48px;
            height: 48px;
            object-fit: contain;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            padding: 6px;
        }
        
        #selected-team-name {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }
        
        .squad-info {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .squad-info-item {
            background-color: #252525;
            border-radius: 8px;
            padding: 18px 15px;
            flex: 1;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            border-top: 3px solid #4ecca3;
        }
        
        .squad-info-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .squad-info-value {
            font-size: 24px;
            font-weight: bold;
            color: #4ecca3;
        }
        
        .squad-info-label {
            font-size: 14px;
            color: #aaa;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .season-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 20px;
            background-color: #252525;
            padding: 15px;
            border-radius: 6px;
        }
        
        .season-input label {
            color: #4ecca3;
            font-weight: bold;
            margin-bottom: 0;
            margin-right: 5px;
        }
        
        .season-input input {
            width: 80px;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #3f3f3f;
            background-color: #1e1e1e;
            color: #fff;
            text-align: center;
            font-weight: bold;
        }
        
        .season-input span {
            color: #ccc;
            margin: 0 5px;
        }
        
        @media (max-width: 768px) {
            .selected-team-display {
                padding: 12px;
                margin-top: 15px;
                margin-bottom: 15px;
                border-radius: 6px;
            }
            
            .selected-team-logo {
                width: 38px;
                height: 38px;
                padding: 4px;
            }
            
            #selected-team-name {
                font-size: 16px;
            }
        }

        /* Current Squad Styles */
        .current-squad-section {
            margin-bottom: 30px;
        }

        .current-squad-section h3 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 1.2rem;
            padding-bottom: 8px;
            border-bottom: 1px solid #393939;
        }

        .squad-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .squad-player-card {
            background: #252525;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .squad-player-card:hover {
            background: #303030;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .squad-player-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .squad-player-name {
            font-weight: 600;
            color: #fff;
            font-size: 1.1rem;
        }

        .squad-player-details {
            color: #aaa;
            font-size: 0.9rem;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }
            
            .players-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .header {
                flex-direction: column;
                padding: 12px 8px;
                text-align: center;
            }
            
            .header h1 {
                margin-bottom: 8px;
                font-size: 18px;
            }
            
            .user-info {
                width: 100%;
                justify-content: center;
                margin-top: 5px;
            }
            
            .filters {
                flex-direction: column;
                gap: 8px;
                margin-bottom: 10px;
            }
            
            .transfer-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            /* Make available players list container more compact for mobile */
            .available-players {
                max-height: 320px;
                margin-bottom: 15px;
                padding: 15px;
            }
            
            .selected-players {
                padding: 15px;
                max-height: none;
            }
            
            .player-item {
                padding: 8px 10px;
                margin-bottom: 4px;
                border-radius: 5px;
            }
            
            .player-thumbnail {
                width: 30px;
                height: 30px;
                margin-right: 8px;
            }
            
            .player-name {
                font-size: 13px;
            }
            
            .player-details {
                font-size: 10px;
            }
            
            .player-value {
                font-size: 11px;
                padding: 2px 6px;
            }
            
            /* Increase action button touchable area */
            .action-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            /* Adjust form elements for touch */
            button, input, select {
                padding: 12px 10px;
                font-size: 16px; /* Prevents iOS zoom on focus */
                border-radius: 5px;
            }
            
            label {
                font-size: 13px;
                margin-bottom: 4px;
            }

            /* Improve team selection area for mobile */
            .team-selection {
                padding: 16px;
                margin-bottom: 15px;
                border-radius: 6px;
            }
            
            .team-selection h2 {
                font-size: 17px;
                margin-bottom: 12px;
                padding-bottom: 8px;
            }
            
            #team-selector {
                padding: 12px;
                font-size: 15px;
            }
            
            #debug-controls {
                margin-top: 15px;
                justify-content: center;
            }
            
            #debug-select-team {
                padding: 8px 12px;
                font-size: 13px;
                width: 100%;
                max-width: 200px;
            }
            
            h2 {
                font-size: 16px;
                margin-bottom: 10px;
            }
            
            h3 {
                font-size: 15px;
            }

            /* Make squad info more compact */
            .squad-info {
                gap: 6px;
                flex-wrap: wrap;
            }
            
            .squad-info-item {
                padding: 10px;
                min-width: 75px;
            }

            .squad-info-value {
                font-size: 15px;
            }

            .squad-info-label {
                font-size: 10px;
            }
            
            /* Improve navigation */
            .nav-links {
                padding: 8px 5px;
                gap: 5px;
                z-index: 10;
            }
            
            .nav-links a {
                padding: 8px;
                font-size: 12px;
                justify-content: center;
                flex: 1;
                min-width: 0;
            }
            
            .nav-links a i {
                margin-right: 4px;
            }
            
            /* Improve squad grid for mobile */
            .squad-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 8px;
            }
            
            .squad-player-card {
                padding: 10px;
            }
            
            .squad-player-name {
                font-size: 13px;
            }
            
            .squad-player-details {
                font-size: 10px;
            }
            
            /* Improve submit button */
            .submit-btn {
                width: 100%;
                padding: 14px;
                margin-top: 10px;
            }
            
            /* Improve status message */
            .status-message {
                padding: 10px;
                font-size: 13px;
            }
            
            /* Season input for mobile */
            .season-input {
                padding: 12px;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .season-inputs {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .season-input input {
                width: 60px;
                padding: 8px;
            }
            
            .season-example {
                display: block;
                width: 100%;
                font-size: 12px;
                margin-top: 8px;
                text-align: center;
                color: #999;
            }
            
            /* Improve the selected team display */
            .selected-team-display {
                padding: 10px;
                margin-top: 10px;
            }
            
            /* Improve transfer settings */
            .transfer-settings {
                padding: 15px;
            }
            
            .transfer-item {
                padding: 12px;
                margin-bottom: 8px;
            }

            /* Mobile player items */
            .player-item:active {
                transform: scale(0.98);
                background-color: #2a2a2a;
            }
            
            /* Improve mobile action buttons */
            .action-btn:active {
                transform: scale(0.9);
            }
            
            /* Add a subtle separator between players */
            .player-item:not(:last-child) {
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                border-radius: 5px 5px 0 0;
            }
            
            .player-item:last-child {
                margin-bottom: 15px;
            }
            
            /* Improve text truncation on small screens */
            .player-name {
                max-width: 120px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            /* Regular list headers */
            .available-players h2, .selected-players h2 {
                background-color: #1e1e1e;
                padding-top: 15px;
                margin-top: 0;
            }
            
            .mobile-quick-nav {
                padding: 10px 5px;
            }
            
            .quick-nav-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        .nav-links {
            background-color: #1e1e1e;
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 20px;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .nav-links a {
            color: #e0e0e0;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-links a:hover {
            background-color: #252525;
            color: #4ecca3;
        }
        
        .nav-links i {
            font-size: 16px;
        }
        
        @media (max-width: 768px) {
            .nav-links {
                padding: 10px;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .nav-links a {
                padding: 8px 12px;
                font-size: 14px;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        #available-players-list .player-item {
            animation: slideIn 0.3s ease-out;
        }

        /* Mobile loading styles */
        .mobile-loading {
            overflow: hidden;
        }
        
        .mobile-loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(18, 18, 18, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(78, 204, 163, 0.3);
            border-radius: 50%;
            border-top-color: #4ecca3;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        .loading-text {
            color: #e0e0e0;
            font-size: 14px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Add touch momentum scrolling for iOS */
        .available-players, .selected-players {
            -webkit-overflow-scrolling: touch;
        }
        
        @media (max-width: 768px) {
            /* Improve tap highlights on mobile */
            .player-item, .action-btn, button, .club-option {
                -webkit-tap-highlight-color: rgba(78, 204, 163, 0.1);
            }
        }

        /* Mobile sticky header and navigation */
        @media (max-width: 768px) {
            /* Quick jump navigation */
            .mobile-quick-nav {
                display: flex;
                gap: 8px;
                padding: 10px 5px;
                justify-content: center;
                margin-bottom: 10px;
                background-color: #121212;
                z-index: 9;
            }
            
            .quick-nav-btn {
                background-color: #252525;
                color: #e0e0e0;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
                white-space: nowrap;
            }
            
            .quick-nav-btn:active {
                background-color: #4ecca3;
                color: #121212;
            }
            
            /* Regular list headers */
            .available-players h2, .selected-players h2 {
                background-color: #1e1e1e;
                padding-top: 15px;
                margin-top: 0;
            }
        }

        /* Quick jump navigation */
        .mobile-quick-nav {
            display: flex;
            gap: 8px;
            padding: 12px 5px;
            justify-content: center;
            margin-bottom: 15px;
            background-color: #1a1a1a;
            border-radius: 6px;
        }
        
        .quick-nav-btn {
            background-color: #252525;
            color: #e0e0e0;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .season-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .season-example {
            color: #aaa;
            font-style: italic;
            margin-left: 10px;
        }

        /* Add CSS for player type select */
        .player-type-select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #252525;
            color: #fff;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        .player-type-select:focus {
            border-color: #4ecca3;
            outline: none;
            box-shadow: 0 0 0 2px rgba(78, 204, 163, 0.2);
        }
        
        /* Add visual indicators for player types */
        .player-type-standard {
            background-color: #555;
            color: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-left: 5px;
        }
        
        .player-type-prime {
            background: linear-gradient(135deg, #00CED1, #20B2AA);
            color: #000;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-left: 5px;
        }
        
        .player-type-legend {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-left: 5px;
        }
        
        .player-type-prime-legend {
            background: linear-gradient(135deg, #9400D3, #4B0082);
            color: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        .success-message {
            background-color: rgba(46, 204, 113, 0.2);
            border-left: 4px solid #2ecc71;
            color: #2ecc71;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            animation: slideIn 0.3s ease-out;
        }

        .error-message {
            background-color: rgba(231, 76, 60, 0.2);
            border-left: 4px solid #e74c3c;
            color: #e74c3c;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Add History Panel Styles */
        .history-panel {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-left: 4px solid #4ecca3;
        }

        .history-container {
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .history-item {
            background-color: #252525;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            background-color: #303030;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-timestamp {
            color: #aaa;
            font-size: 0.9em;
        }

        .history-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .history-type.incoming {
            background-color: #4caf50;
            color: white;
        }

        .history-type.outgoing {
            background-color: #f44336;
            color: white;
        }

        .history-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #393939;
        }

        .history-changes {
            display: flex;
            gap: 20px;
        }

        .history-old, .history-new {
            flex: 1;
        }

        .history-label {
            color: #aaa;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .history-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .history-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            background-color: #3f51b5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .history-btn:hover {
            background-color: #303f9f;
        }

        .history-btn.revert {
            background-color: #f44336;
        }

        .history-btn.revert:hover {
            background-color: #d32f2f;
        }

        #history-filter {
            padding: 8px;
            background-color: #252525;
            color: white;
            border: 1px solid #444;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .history-panel {
                margin: 10px;
                padding: 15px;
            }

            .history-changes {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* Mobile loading indicator */
        .mobile-loading {
            overflow: hidden; /* Prevent scrolling while loading */
        }
        
        .mobile-loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            color: white;
            font-size: 18px;
            text-align: center;
            padding: 0 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Improved status messages */
        .status-message {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: 500;
            position: relative;
            animation: fadeInOut 0.3s ease-in-out;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
    </style>

    <!-- Performance optimized CSS -->
    <link rel="stylesheet" href="css/performance.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="css/performance.css">
    <link rel="stylesheet" href="css/additional-fixes.css"></noscript>

    <!-- Club dropdown styles (inline since club-dropdown.css doesn't exist) -->
    <style>
        .team-dropdown {
            position: relative;
        }
        
        .team-search {
            padding-right: 30px;
        }
        
        .team-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #252525;
            border: 1px solid #444;
            border-radius: 0 0 6px 6px;
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .club-option {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            user-select: none;
        }
        
        .club-option:hover {
            background-color: #303030;
            transform: translateX(3px);
        }
        
        .club-option:last-child {
            border-bottom: none;
        }
        
        .club-logo {
            width: 28px;
            height: 28px;
            margin-right: 12px;
            object-fit: contain;
        }
        
        .club-option span {
            color: #fff;
            font-size: 14px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>R2G Transfer Admin Panel</h1>
        <div class="user-info">
            <span>Logged in as: <span class="username" id="logged-user">Admin</span></span>
            <button class="logout-btn" id="logout-btn">Logout</button>
        </div>
    </div>
    
    <div class="container">
        <!-- Add History Panel -->
        <div class="history-panel">
            <h2>Transfer History</h2>
            <div class="history-controls">
                <button id="refresh-history" class="history-btn">
                    <i class="fas fa-sync"></i> Refresh
                </button>
                <select id="history-filter">
                    <option value="all">All Transfers</option>
                    <option value="incoming">Incoming Transfers</option>
                    <option value="outgoing">Outgoing Transfers</option>
                </select>
            </div>
            <div id="history-container" class="history-container">
                <!-- History items will be added here dynamically -->
            </div>
        </div>

        <!-- Existing content -->
        <div class="mobile-quick-nav" id="mobile-quick-nav" style="display: none;">
            <button class="quick-nav-btn" data-target="team-selection">Team</button>
            <button class="quick-nav-btn" data-target="available-players">Available</button>
            <button class="quick-nav-btn" data-target="selected-players">Selected</button>
            <button class="quick-nav-btn" data-target="transfer-settings">Settings</button>
            <button class="quick-nav-btn" data-target="history-panel">History</button>
        </div>
        
        <div class="team-selection">
            <h2>Select Team</h2>
            <div class="form-group">
                <label for="team-selector">Select Team to Transfer Players To:</label>
                <div class="team-selector-container">
                    <select id="team-selector" class="search-box">
                        <option value="">-- Select a team --</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>
            <div id="selected-team-display" style="display: none;" class="selected-team-display">
                <img id="selected-team-logo" class="selected-team-logo" src="" alt="Team Logo">
                <span id="selected-team-name"></span>
            </div>
            <div id="squad-info" class="squad-info" style="display: none;">
                <div class="squad-info-item">
                    <div id="squad-size" class="squad-info-value">0</div>
                    <div class="squad-info-label">Squad Size</div>
                </div>
                <div class="squad-info-item">
                    <div id="squad-budget" class="squad-info-value">0</div>
                    <div class="squad-info-label">R2G Coins</div>
                    <button id="fix-coins-btn" title="Fix R2G Coins display" style="background-color: #444; margin-top: 5px; font-size: 12px; padding: 3px 6px; border: none; border-radius: 4px; color: white; cursor: pointer;">Fix Coins</button>
                </div>
            </div>
            <div class="form-group season-input">
                <label for="season-start">Season:</label>
                <div class="season-inputs">
                    <input type="number" id="season-start" min="1" max="20" value="6" step="0.5">
                    <span>-</span>
                    <input type="number" id="season-end" min="1" max="20" value="8" step="0.5">
                </div>
                <span class="season-example">(e.g. 6-8)</span>
            </div>
            
            <div id="debug-controls">
                <button id="debug-select-team" title="Automatically select the first available team">Debug Select Team</button>
                <button id="debug-check-data" title="Check for inconsistencies between manager data and players data" style="background-color: #444; margin-left: 10px;">Check Data Consistency</button>
            </div>
        </div>
        
        <div class="players-container">
            <div class="available-players">
                <h2>Available Players</h2>
                <div class="filters">
                    <div class="filter-group">
                        <label for="player-search">Search:</label>
                        <input type="text" id="player-search" placeholder="Search players..." class="search-box">
                    </div>
                </div>
                <div id="available-players-list">
                    <!-- Players will be populated here -->
                </div>
            </div>
            
            <div class="selected-players">
                <h2>Selected Players for Transfer</h2>
                <div id="selected-players-list">
                    <!-- Selected players will be populated here -->
                </div>
                <div id="transfer-settings" class="transfer-settings" style="display: none;">
                    <h3>Transfer Settings</h3>
                    <div class="form-group">
                        <label for="default-contract">Default Contract Length (years):</label>
                        <input type="number" id="default-contract" min="1" max="5" value="2" step="1">
                    </div>
                    <p>You can adjust individual values and contracts below:</p>
                    <div id="transfer-details" class="transfer-grid">
                        <!-- Transfer details will be populated here -->
                    </div>
                    <div class="submit-container">
                        <button id="submit-transfers" class="submit-btn">Complete Transfers</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="status-message" class="status-message"></div>
    </div>

    <!-- Add GitHub configuration script -->
    <script defer src="github-config.js"></script>
    <script>
        // GitHub configuration check
        let githubConfig = null;
        
        function initGitHubConfig() {
            try {
                if (typeof window.githubConfig !== 'undefined') {
                    githubConfig = window.githubConfig;
                    console.log('GitHub config loaded from global object');
                    return true;
                }
                    
                // Fallback implementation if github-config.js is not available
                githubConfig = {
                    isConfigured: function() {
                        return !!localStorage.getItem('githubToken');
                    },
                    getToken: function() {
                        return localStorage.getItem('githubToken');
                    },
                    getOwner: function() {
                        return localStorage.getItem('githubOwner') || 'default-owner';
                    },
                    getRepo: function() {
                        return localStorage.getItem('githubRepo') || 'default-repo';
                    },
                    getBranch: function() {
                        return localStorage.getItem('githubBranch') || 'main';
                    }
                };
                    
                return githubConfig.isConfigured();
            } catch (error) {
                console.error('Error initializing GitHub config:', error);
                    
                // Create minimal emergency fallback
                githubConfig = {
                    isConfigured: () => false,
                    getToken: () => null,
                    getOwner: () => 'default-owner',
                    getRepo: () => 'default-repo', 
                    getBranch: () => 'main'
                };
                    
                return false;
            }
        }
    
        // Authentication check
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading indicator
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = 'Loading...';
            statusElement.className = 'status-message status-success';
            statusElement.style.display = 'block';
            
            // Set up mobile loading indicator
            let mobileLoadingIndicator = null;
            if (window.innerWidth <= 768) {
                // Add loading class to body
                document.body.classList.add('mobile-loading');
                
                // Create loading indicator
                mobileLoadingIndicator = document.createElement('div');
                mobileLoadingIndicator.className = 'mobile-loading-indicator';
                mobileLoadingIndicator.innerHTML = '<div class="loading-spinner"></div><div class="loading-text">Loading players...</div>';
                document.body.appendChild(mobileLoadingIndicator);
            }
            
            // Function to remove mobile loading indicator
            const removeMobileLoading = () => {
                if (mobileLoadingIndicator) {
                    document.body.classList.remove('mobile-loading');
                    mobileLoadingIndicator.style.opacity = '0';
                    setTimeout(() => {
                        if (mobileLoadingIndicator && mobileLoadingIndicator.parentNode) {
                            mobileLoadingIndicator.remove();
                        }
                    }, 300);
                }
            };
            
            // Check if logged in
            const isLoggedIn = sessionStorage.getItem('transferAdminLoggedIn');
            if (!isLoggedIn) {
                // Remove loading before redirect
                removeMobileLoading();
                // Redirect to login page
                window.location.href = 'transfer-login.html';
                return;
            }
            
            // Set logged in username
            document.getElementById('logged-user').textContent = sessionStorage.getItem('transferAdminUsername') || 'Admin';
            
            // Initialize the transfer panel
            initTransferPanel().then(() => {
                // Check GitHub config after UI is showing
                if (!localStorage.getItem('githubToken')) {
                    const configMessage = document.createElement('div');
                    configMessage.className = 'status-message status-error';
                    configMessage.style.display = 'block';
                    configMessage.textContent = 'GitHub integration not configured. Changes will only be saved in memory.';
                    configMessage.style.marginBottom = '10px';
                    
                    // Add setup button
                    const setupButton = document.createElement('button');
                    setupButton.textContent = 'Configure GitHub';
                    setupButton.style.marginTop = '5px';
                    setupButton.addEventListener('click', () => {
                        window.location.href = 'token-setup.html';
                    });
                    
                    configMessage.appendChild(setupButton);
                    
                    // Insert at the top of container
                    const container = document.querySelector('.container');
                    container.insertBefore(configMessage, container.firstChild);
                }
                
                // Remove mobile loading indicator
                removeMobileLoading();
            }).catch(error => {
                console.error('Error initializing transfer panel:', error);
                
                // Show error message
                statusElement.textContent = `Failed to initialize: ${error.message}`;
                statusElement.className = 'status-message status-error';
                
                // Remove mobile loading indicator
                removeMobileLoading();
            });
            
            // Set a safety timeout to remove loading in case of other issues
            setTimeout(removeMobileLoading, 10000);
        });

        // Logout function
        function performLogout() {
            // Clear session data
            sessionStorage.removeItem('transferAdminLoggedIn');
            sessionStorage.removeItem('transferAdminUsername');
            
            // Redirect to login page
            window.location.href = 'transfer-login.html';
        }

        // Global variables
        let playersData = [];
        let managersData = [];
        let selectedTeam = null;
        let selectedPlayers = [];
        let filteredPlayers = [];
        
        // Initialize transfer panel
        async function initTransferPanel() {
            try {
                // Show loading in status element
                const statusElement = document.getElementById('status-message');
                statusElement.textContent = 'Loading player and team data...';
                statusElement.className = 'status-message status-success';
                statusElement.style.display = 'block';
                
                // Initialize GitHub config first
                initGitHubConfig();
                
                // Add GitHub configuration message if needed
                checkGitHubConfigStatus();
                
                // Load data first before setting up the UI
                let loadedData = false;
                
                const loadPromise = new Promise(async (resolve) => {
                    try {
                        // Check if server is available
                        const serverAvailable = await isServerAvailable();
                        
                        if (serverAvailable) {
                            try {
                                // Load players from server
                                const playersResponse = await fetch('http://localhost:3000/players.json');
                                if (playersResponse.ok) {
                                    playersData = await playersResponse.json();
                                    console.log(`Loaded ${playersData.length} players from server`);
                                    
                                    // Load managers data
                                    const managersResponse = await fetch('http://localhost:3000/manager_data.json');
                                    if (managersResponse.ok) {
                                        const managersRawData = await managersResponse.json();
                                        
                                        // Handle different manager data formats
                                        if (Array.isArray(managersRawData.managers)) {
                                            managersData = managersRawData.managers;
                                            console.log(`Loaded ${managersData.length} managers from server (managers array format)`);
                                        } else if (Array.isArray(managersRawData)) {
                                            managersData = managersRawData;
                                            console.log(`Loaded ${managersData.length} managers from server (direct array format)`);
                                        } else {
                                            console.error('Server returned invalid manager data format');
                                            throw new Error('Invalid manager data format from server');
                                        }
                                        
                                        resolve(true);
                                        return;
                                    } else {
                                        console.error('Failed to load manager data from server:', managersResponse.status, managersResponse.statusText);
                                        throw new Error(`Failed to load manager data: ${managersResponse.status}`);
                                    }
                                } else {
                                    console.error('Failed to load player data from server:', playersResponse.status, playersResponse.statusText);
                                    throw new Error(`Failed to load player data: ${playersResponse.status}`);
                                }
                            } catch (serverError) {
                                console.error('Error accessing server data:', serverError);
                                // Continue to fallback loading
                            }
                        }
                        
                        // Fallback: Load from files
                        console.log('Server not available, loading from files');
                        try {
                            const playersResponse = await fetch('players.json', {
                                cache: 'no-store',  // Don't use cache to get latest data
                                headers: { 'Cache-Control': 'no-cache' }
                            });
                            
                            if (!playersResponse.ok) {
                                throw new Error(`Failed to load players.json: ${playersResponse.status}`);
                            }
                            
                            playersData = await playersResponse.json();
                            console.log(`Loaded ${playersData.length} players from file`);
                            
                            const managersResponse = await fetch('manager_data.json', {
                                cache: 'no-store',  // Don't use cache to get latest data
                                headers: { 'Cache-Control': 'no-cache' }
                            });
                            
                            if (!managersResponse.ok) {
                                throw new Error(`Failed to load manager_data.json: ${managersResponse.status}`);
                            }
                            
                            const managersRawData = await managersResponse.json();
                            
                            // Make sure managersData is in the right format
                            if (Array.isArray(managersRawData.managers)) {
                                // If the data is an object with a managers array property
                                console.log('Manager data has managers array property');
                                managersData = managersRawData.managers;
                            } else if (Array.isArray(managersRawData)) {
                                // If it's already an array, use it directly
                                managersData = managersRawData;
                            } else {
                                console.error('Manager data has unexpected format:', typeof managersRawData);
                                managersData = [];
                                throw new Error('Invalid manager data format from file');
                            }
                            
                            console.log(`Data loaded from files: ${playersData.length} players, ${managersData.length} managers`);
                            if (managersData.length > 0) {
                                console.log('First manager:', managersData[0].name || managersData[0].club || 'unnamed');
                            }
                            
                            // Show server warning
                            showStatusMessage('Warning: Data server is not running. Changes will not be saved.', false);
                            resolve(true);
                        } catch (fileError) {
                            console.error('Error loading data from files:', fileError);
                            resolve(false);
                        }
                    } catch (error) {
                        console.error('Error loading data:', error);
                        resolve(false);
                    }
                });
                
                // Set timeout for loading
                const timeoutPromise = new Promise(resolve => {
                    setTimeout(() => {
                        if (!loadedData) {
                            statusElement.textContent = 'Still loading... This may take a moment.';
                        }
                        resolve(false);
                    }, 1500);
                });
                
                // Wait for data or timeout
                loadedData = await Promise.race([loadPromise, timeoutPromise]);
                
                // Wait for actual data if timeout happened first
                if (!loadedData) {
                    loadedData = await loadPromise;
                }
                
                if (!loadedData) {
                    throw new Error('Failed to load data');
                }
                
                // Add unique ID to each player if missing
                playersData = playersData.map((player, index) => ({
                    ...player,
                    id: player.id ? Number(player.id) : (index + 1)
                }));
                
                // Set up filtered players list
                filteredPlayers = [...playersData];
                
                // Now set up event listeners after data is loaded
                setupEventListeners();
                
                // Populate available players list
                populateAvailablePlayers();
                
                // Hide loading status
                statusElement.style.display = 'none';
                
                return Promise.resolve();
                
            } catch (error) {
                showStatusMessage(`Error: ${error.message}`, false);
                console.error('Error initializing transfer panel:', error);
                return Promise.resolve(); // Still resolve to continue
            }
        }

        // Helper function to check if server is available
        async function isServerAvailable() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 500);  // 500ms timeout
                
                const response = await fetch('http://localhost:3000/players.json', {
                    method: 'HEAD',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                return response.ok;
            } catch (error) {
                console.log('Server check failed:', error.name);
                return false;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', performLogout);
            
            // Team selector
            const teamSelector = document.getElementById('team-selector');
            if (teamSelector) {
                // Populate team selector options
                populateTeamSelector();
                
                // Add change event handler
                teamSelector.addEventListener('change', function() {
                    const selectedTeamName = this.value;
                    if (selectedTeamName) {
                        selectTeam(selectedTeamName);
                    }
                });
            }
            
            // Player filters
            document.getElementById('player-search').addEventListener('input', filterPlayers);
            
            // Default contract change
            document.getElementById('default-contract').addEventListener('change', updateAllContracts);
            
            // Submit transfers button
            document.getElementById('submit-transfers').addEventListener('click', submitTransfers);
            
            // Debug button for team selection
            const debugBtn = document.getElementById('debug-select-team');
            if (debugBtn) {
                debugBtn.addEventListener('click', function() {
                    console.log('Debug button clicked');
                    console.log('Manager data length:', managersData.length);
                    
                    if (managersData.length > 0) {
                        // Find first manager with a club
                        const firstManager = managersData.find(m => m.club);
                        if (firstManager) {
                            console.log('Selecting first team:', firstManager.club);
                            const selector = document.getElementById('team-selector');
                            if (selector) {
                                selector.value = firstManager.club;
                                selectTeam(firstManager.club);
                            }
                        } else {
                            console.error('No manager with club found');
                            showStatusMessage('No teams available', false);
                        }
                    } else {
                        console.error('No managers data available');
                        showStatusMessage('Manager data not loaded', false);
                    }
                });
            }
            
            // Debug button for data consistency check
            const debugCheckBtn = document.getElementById('debug-check-data');
            if (debugCheckBtn) {
                debugCheckBtn.addEventListener('click', checkDataConsistency);
            }
            
            // Fix R2G Coins button
            const fixCoinsBtn = document.getElementById('fix-coins-btn');
            if (fixCoinsBtn) {
                fixCoinsBtn.addEventListener('click', function() {
                    if (!selectedTeam || !selectedTeam.manager) {
                        showStatusMessage('No team selected', false);
                        return;
                    }
                    
                    // Log current manager data
                    console.log('Current manager data:', selectedTeam.manager);
                    
                    // Create dialog for manual R2G coin balance entry
                    const coinValue = prompt('Enter R2G Coin balance:', '2000');
                    if (coinValue !== null) {
                        const coinNumber = parseInt(coinValue.trim());
                        if (!isNaN(coinNumber)) {
                            // Add the property to the manager in all possible formats
                            selectedTeam.manager.r2g_coin_balance = coinNumber;
                            selectedTeam.manager.r2gCoinBalance = coinNumber;
                            selectedTeam.manager.r2g_coins = coinNumber;
                            selectedTeam.manager.r2gCoins = coinNumber;
                            selectedTeam.manager.coins = coinNumber;
                            
                            // Also update in the managers data array
                            const managerIndex = managersData.findIndex(m => m.club === selectedTeam.name);
                            if (managerIndex !== -1) {
                                managersData[managerIndex].r2g_coin_balance = coinNumber;
                                managersData[managerIndex].r2gCoinBalance = coinNumber;
                                managersData[managerIndex].r2g_coins = coinNumber;
                                managersData[managerIndex].r2gCoins = coinNumber;
                                managersData[managerIndex].coins = coinNumber;
                            }
                            
                            // Update display
                            updateSquadInfo();
                            showStatusMessage(`R2G Coin balance updated to ${coinNumber}`, true);
                        } else {
                            showStatusMessage('Invalid value. Please enter a number.', false);
                        }
                    }
                });
            }
        }

        // Populate the team selector dropdown
        function populateTeamSelector() {
            const selector = document.getElementById('team-selector');
            if (!selector) {
                console.error('Team selector element not found');
                return;
            }
            
            // Keep the first empty option
            selector.innerHTML = '<option value="">-- Select a team --</option>';
            
            try {
                if (!managersData || !Array.isArray(managersData) || managersData.length === 0) {
                    console.error('No manager data available');
                    return;
                }
                
                // Get all teams with unique club names
                const teams = managersData
                    .filter(manager => manager.club)
                    .sort((a, b) => a.club.localeCompare(b.club));
                
                console.log(`Found ${teams.length} teams to add to selector`);
                
                // Add each team as an option
                teams.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager.club;
                    option.textContent = manager.club;
                    selector.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error populating team selector:', error);
            }
        }

        // Select a team
        function selectTeam(teamName) {
            console.log('selectTeam called for:', teamName);
            
            if (!teamName) {
                console.error('No team name provided');
                showStatusMessage('Please select a valid team', false);
                return;
            }
            
            // Find the manager with this team
            const manager = managersData.find(m => m.club === teamName);
            
            if (!manager) {
                console.error(`Team "${teamName}" not found in manager data`);
                showStatusMessage(`Team "${teamName}" not found in manager data`, false);
                return;
            }
            
            console.log('Found manager for team:', manager);
            
            // Get logo path using a dedicated function
            const logoPath = getTeamLogoPath(teamName);
            
            selectedTeam = {
                name: teamName,
                manager: manager,
                logo: logoPath
            };
            
            // Show the selected team display
            const display = document.getElementById('selected-team-display');
            const logo = document.getElementById('selected-team-logo');
            const name = document.getElementById('selected-team-name');
            
            if (!display || !logo || !name) {
                console.error('Selected team display elements not found');
                return;
            }
            
            display.style.display = 'flex';
            logo.src = selectedTeam.logo;
            logo.onerror = function() {
                console.error('Error loading logo image:', selectedTeam.logo);
                this.src = 'assets/images/logo11.webp';
                this.onerror = null;
            };
            name.textContent = selectedTeam.name;
            
            // Show squad info
            updateSquadInfo();
            
            // Show current squad players
            showCurrentSquadPlayers();
            
            // Re-filter available players to exclude current squad
            filterPlayers();
            
            // Show success message
            showStatusMessage(`Team "${teamName}" selected successfully`, true, 2000);
        }

        // Helper function to get team logo path with proper fallbacks
        function getTeamLogoPath(teamName) {
            if (!teamName) return 'assets/images/logo11.webp';
            
            let logoPath = 'assets/images/logo11.webp'; // default logo
            
            // Try to get logo from club-manager if available
            try {
                if (window.ClubManager) {
                    // Initialize club manager if needed
                    if (window.ClubManager.initialize && !window.ClubManager.initialized) {
                        console.log('Initializing ClubManager...');
                        try {
                            window.ClubManager.initialize();
                        } catch (e) {
                            console.error('Error initializing ClubManager:', e);
                        }
                    }
                    
                    // Get club data using ClubManager
                    if (window.ClubManager.getClub) {
                        const club = window.ClubManager.getClub(teamName);
                        console.log('Club data for', teamName, ':', club);
                        
                        if (club && club.logo) {
                            logoPath = club.logo;
                            console.log('Found club logo:', logoPath);
                        } else {
                            console.log('No logo found for club in ClubManager');
                        }
                    }
                }
            } catch (error) {
                console.error('Error using ClubManager:', error);
            }
            
            // If ClubManager failed, try standard naming conventions
            if (logoPath === 'assets/images/logo11.webp') {
                // Try various common paths
                const possiblePaths = [
                    `assets/images/players/club/${teamName.replace(/\s+/g, '-').toLowerCase()}.webp`,
                    `assets/images/players/club/${teamName}.webp`,
                    `assets/images/club-logos/${teamName.replace(/\s+/g, '-').toLowerCase()}.webp`,
                    `assets/images/club-logos/${teamName}.webp`
                ];
                
                for (const path of possiblePaths) {
                    // We can't check if image exists on server side, so we'll provide
                    // a list of potential paths that the onerror handler can try
                    if (path) {
                        logoPath = path;
                        // Find first non-empty path
                        break;
                    }
                }
            }
            
            // Make sure logo path is correct - remove any leading slash
            if (logoPath.startsWith('/')) {
                logoPath = logoPath.substring(1);
                console.log('Fixed logo path by removing leading slash:', logoPath);
            }
            
            return logoPath;
        }

        // Show current squad players
        function showCurrentSquadPlayers() {
            const container = document.getElementById('selected-players-list');
            const transferSettings = document.getElementById('transfer-settings');
            
            // Clear the container
            container.innerHTML = '';
            
            // Add a section for current squad
            const currentSquadSection = document.createElement('div');
            currentSquadSection.className = 'current-squad-section';
            
            const squadHeader = document.createElement('h3');
            squadHeader.textContent = 'Current Squad';
            currentSquadSection.appendChild(squadHeader);
            
            // Get current squad players
            const currentSquad = selectedTeam.manager.squad?.players || [];
            
            if (currentSquad.length === 0) {
                const noPlayers = document.createElement('p');
                noPlayers.textContent = 'No players in current squad';
                noPlayers.style.textAlign = 'center';
                noPlayers.style.color = '#888';
                noPlayers.style.padding = '20px';
                currentSquadSection.appendChild(noPlayers);
            } else {
                // Create a grid for current squad players
                const squadGrid = document.createElement('div');
                squadGrid.className = 'squad-grid';
                
                currentSquad.forEach(player => {
                    const playerCard = document.createElement('div');
                    playerCard.className = 'squad-player-card';
                    
                    // Player info
                    const playerInfo = document.createElement('div');
                    playerInfo.className = 'squad-player-info';
                    
                    const playerName = document.createElement('div');
                    playerName.className = 'squad-player-name';
                    playerName.textContent = player.name;
                    
                    // Add player type badge if available
                    if (player.type) {
                        const typeBadge = document.createElement('span');
                        const typeClass = player.type.replace(' ', '-');
                        typeBadge.className = `player-type-${typeClass}`;
                        typeBadge.textContent = player.type;
                        playerName.appendChild(typeBadge);
                    }
                    
                    const playerDetails = document.createElement('div');
                    playerDetails.className = 'squad-player-details';
                    playerDetails.textContent = `${player.position} | Value: ${player.value.toLocaleString()} RC | Contract: ${player.contract} years`;
                    
                    playerInfo.appendChild(playerName);
                    playerInfo.appendChild(playerDetails);
                    
                    playerCard.appendChild(playerInfo);
                    squadGrid.appendChild(playerCard);
                });
                
                currentSquadSection.appendChild(squadGrid);
            }
            
            // Add a separator
            const separator = document.createElement('hr');
            separator.style.margin = '20px 0';
            separator.style.border = 'none';
            separator.style.borderTop = '1px solid rgba(255, 255, 255, 0.1)';
            
            // Add the new players section header
            const newPlayersHeader = document.createElement('h3');
            newPlayersHeader.textContent = 'New Players to Transfer';
            
            // Add all elements to the container
            container.appendChild(currentSquadSection);
            container.appendChild(separator);
            container.appendChild(newPlayersHeader);
            
            // Show transfer settings if there are selected players
            if (selectedPlayers.length > 0) {
                transferSettings.style.display = 'block';
                updateTransferDetails();
            } else {
                transferSettings.style.display = 'none';
            }
        }

        // Update squad information display
        function updateSquadInfo() {
            if (!selectedTeam || !selectedTeam.manager) return;
            
            const squadInfo = document.getElementById('squad-info');
            const squadSize = document.getElementById('squad-size');
            const squadBudget = document.getElementById('squad-budget');
            
            const manager = selectedTeam.manager;
            
            // Debug manager data
            console.log('Manager data:', JSON.stringify(manager));
            console.log('Manager properties:', Object.keys(manager));
            
            // Show the squad info section
            squadInfo.style.display = 'flex';
            
            // Update squad size
            const currentSquadSize = manager.squad?.players?.length || 0;
            squadSize.textContent = currentSquadSize;
            
            // Debug budget related properties
            console.log('r2g_coin_balance:', manager.r2g_coin_balance);
            console.log('r2gCoinBalance:', manager.r2gCoinBalance);
            console.log('r2g_coins:', manager.r2g_coins);
            console.log('r2gCoins:', manager.r2gCoins);
            console.log('coins:', manager.coins);
            console.log('budget:', manager.budget);
            
            // Budget - check all possible r2g coin balance properties
            let budget = 0;
            if (typeof manager.r2g_coin_balance !== 'undefined' && manager.r2g_coin_balance !== null) {
                budget = manager.r2g_coin_balance;
                console.log(`Using r2g_coin_balance: ${budget} for ${manager.club}`);
            } else if (typeof manager.r2gCoinBalance !== 'undefined' && manager.r2gCoinBalance !== null) {
                budget = manager.r2gCoinBalance;
                console.log(`Using r2gCoinBalance: ${budget} for ${manager.club}`);
            } else if (typeof manager.r2g_coins !== 'undefined' && manager.r2g_coins !== null) {
                budget = manager.r2g_coins;
                console.log(`Using r2g_coins: ${budget} for ${manager.club}`);
            } else if (typeof manager.r2gCoins !== 'undefined' && manager.r2gCoins !== null) {
                budget = manager.r2gCoins;
                console.log(`Using r2gCoins: ${budget} for ${manager.club}`);
            } else if (typeof manager.coins !== 'undefined' && manager.coins !== null) {
                budget = manager.coins;
                console.log(`Using coins: ${budget} for ${manager.club}`);
            } else if (typeof manager.budget !== 'undefined' && manager.budget !== null) {
                budget = manager.budget;
                console.log(`Using budget: ${budget} for ${manager.club}`);
            } else if (typeof manager.cash !== 'undefined' && manager.cash !== null) {
                budget = manager.cash;
                console.log(`Using cash: ${budget} for ${manager.club}`);
            } else {
                // Default value if no budget information is available
                budget = 10000;
                console.log(`No budget information found for ${manager.club}, using default: ${budget}`);
            }
            
            squadBudget.textContent = budget.toLocaleString();
        }

        // Populate available players list with filtered data
        function populateAvailablePlayers() {
            const container = document.getElementById('available-players-list');
            container.innerHTML = '';
            
            if (filteredPlayers.length === 0) {
                const noResults = document.createElement('p');
                noResults.textContent = 'No players match your filters';
                noResults.style.textAlign = 'center';
                noResults.style.color = '#888';
                noResults.style.padding = '20px';
                container.appendChild(noResults);
                return;
            }
            
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            
            filteredPlayers.forEach(player => {
                const playerElement = createPlayerElement(player, true);
                fragment.appendChild(playerElement);
            });
            
            container.appendChild(fragment);
        }

        // Create a player element
        function createPlayerElement(player, isAvailable = true) {
            const playerElement = document.createElement('div');
            playerElement.className = 'player-item';
            playerElement.dataset.id = player.id;
            
            const img = document.createElement('img');
            img.className = 'player-thumbnail';
            
            // Use a default image URL that exists in the project
            const defaultImageUrl = 'assets/images/logo11.webp';
            
            // Try to use player image path if available
            if (player.imagePath) {
                img.src = player.imagePath;
            } else {
                img.src = defaultImageUrl;
            }
            
            img.alt = player.name;
            img.loading = 'lazy'; // Lazy load images
            
            // Handle image loading errors
            img.onerror = function() {
                // Don't try to load placeholder.com as it's unreliable
                // Instead, use a local asset we know exists
                this.src = defaultImageUrl;
                // Stop the error cascade
                this.onerror = null;
            };
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'player-info';
            
            const nameSpan = document.createElement('div');
            nameSpan.className = 'player-name';
            nameSpan.textContent = player.name;
            
            // Add player type badge if available
            if (player.type) {
                const typeBadge = document.createElement('span');
                const typeClass = player.type.replace(' ', '-');
                typeBadge.className = `player-type-${typeClass}`;
                typeBadge.textContent = player.type;
                nameSpan.appendChild(typeBadge);
            }
            
            const detailsSpan = document.createElement('div');
            detailsSpan.className = 'player-details';
            
            // Extract star rating for display
            let starRating = '⭐';
            if (player.star) {
                const starMatch = player.star.match(/(\d)-star/);
                if (starMatch && starMatch[1]) {
                    starRating = '⭐'.repeat(parseInt(starMatch[1]));
                }
            }
            
            detailsSpan.textContent = `${player.position} | ${starRating} | ${player.club || 'Free Agent'}`;
            
            const valueSpan = document.createElement('span');
            valueSpan.className = 'player-value';
            valueSpan.textContent = player.value;
            
            infoDiv.appendChild(nameSpan);
            infoDiv.appendChild(detailsSpan);
            
            playerElement.appendChild(img);
            playerElement.appendChild(infoDiv);
            playerElement.appendChild(valueSpan);
            
            // Add action button
            const actionBtn = document.createElement('button');
            actionBtn.className = isAvailable ? 'action-btn add-btn' : 'action-btn remove-btn';
            actionBtn.innerHTML = isAvailable ? '<i class="fas fa-plus"></i>' : '<i class="fas fa-minus"></i>';
            actionBtn.title = isAvailable ? 'Add to transfer' : 'Remove from transfer';
            
            actionBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (isAvailable) {
                    addPlayerToTransfer(player);
                } else {
                    removePlayerFromTransfer(player.id);
                }
            });
            
            playerElement.appendChild(actionBtn);
            
            return playerElement;
        }

        // Filter players based on search and filters
        function filterPlayers() {
            const searchTerm = document.getElementById('player-search').value.toLowerCase();
            
            // Get IDs of already selected players to exclude them
            const selectedIds = selectedPlayers.map(p => p.id);
            
            // Get IDs of players already in the selected team's squad
            const teamSquadIds = [];
            if (selectedTeam && selectedTeam.manager && selectedTeam.manager.squad && selectedTeam.manager.squad.players) {
                selectedTeam.manager.squad.players.forEach(squadPlayer => {
                    // Try to find this player in players data
                    const matchingPlayer = playersData.find(p => p.name === squadPlayer.name);
                    if (matchingPlayer) {
                        teamSquadIds.push(matchingPlayer.id);
                    }
                });
            }
            
            filteredPlayers = playersData.filter(player => {
                // Exclude already selected players
                if (selectedIds.includes(player.id)) return false;
                
                // Exclude players already in the team's squad
                if (teamSquadIds.includes(player.id)) return false;
                
                // Apply search term filter
                if (searchTerm && !player.name.toLowerCase().includes(searchTerm)) return false;
                
                return true;
            });
            
            // Sort by value (highest first)
            filteredPlayers.sort((a, b) => {
                // Sort by value (highest first)
                if (b.value !== a.value) {
                    return b.value - a.value;
                }
                // If values are equal, sort alphabetically by name
                return a.name.localeCompare(b.name);
            });
            
            // Update the list
            populateAvailablePlayers();
        }

        // Add player to transfer list
        function addPlayerToTransfer(player) {
            // Check if already added
            if (selectedPlayers.some(p => p.id === player.id)) return;
            
            // Add to selected players
            selectedPlayers.push(player);
            
            // Update UI
            updateSelectedPlayersList();
            
            // Re-filter available players
            filterPlayers();
        }

        // Remove player from transfer list
        function removePlayerFromTransfer(playerId) {
            // Find index of player
            const index = selectedPlayers.findIndex(p => p.id === playerId);
            if (index === -1) return;
            
            // Remove from array
            selectedPlayers.splice(index, 1);
            
            // Update UI
            updateSelectedPlayersList();
            
            // Re-filter available players
            filterPlayers();
        }

        // Update the list of selected players
        function updateSelectedPlayersList() {
            const container = document.getElementById('selected-players-list');
            const transferSettings = document.getElementById('transfer-settings');
            
            // Clear the container
            container.innerHTML = '';
            
            if (selectedPlayers.length === 0) {
                transferSettings.style.display = 'none';
                
                const noPlayers = document.createElement('p');
                noPlayers.textContent = 'No players selected for transfer';
                noPlayers.style.textAlign = 'center';
                noPlayers.style.color = '#888';
                noPlayers.style.padding = '20px';
                container.appendChild(noPlayers);
                return;
            }
            
            // Show transfer settings
            transferSettings.style.display = 'block';
            
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            
            // Add selected players
            selectedPlayers.forEach(player => {
                const playerElement = createPlayerElement(player, false);
                fragment.appendChild(playerElement);
            });
            
            container.appendChild(fragment);
            
            // Update transfer details
            updateTransferDetails();
        }
        
        // Update transfer details
        function updateTransferDetails() {
            const container = document.getElementById('transfer-details');
            container.innerHTML = '';
            
            if (selectedPlayers.length === 0) return;
            
            // Get default contract length
            const defaultContract = parseInt(document.getElementById('default-contract').value) || 2;
            
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            
            selectedPlayers.forEach(player => {
                const transferItem = document.createElement('div');
                transferItem.className = 'transfer-item';
                transferItem.dataset.id = player.id;
                
                // Player name
                const nameHeading = document.createElement('h4');
                nameHeading.style.margin = '0 0 10px 0';
                nameHeading.textContent = player.name;
                
                // Value input
                const valueGroup = document.createElement('div');
                valueGroup.className = 'form-group';
                
                const valueLabel = document.createElement('label');
                valueLabel.textContent = 'Transfer Value:';
                valueLabel.htmlFor = `value-${player.id}`;
                
                const valueInput = document.createElement('input');
                valueInput.type = 'number';
                valueInput.id = `value-${player.id}`;
                valueInput.className = 'transfer-value';
                valueInput.min = '1';
                valueInput.value = player.value;
                valueInput.dataset.id = player.id;
                
                valueInput.addEventListener('input', updatePlayerSalary);
                valueGroup.appendChild(valueLabel);
                valueGroup.appendChild(valueInput);
                
                // Contract input
                const contractGroup = document.createElement('div');
                contractGroup.className = 'form-group';
                
                const contractLabel = document.createElement('label');
                contractLabel.textContent = 'Contract Length (years):';
                contractLabel.htmlFor = `contract-${player.id}`;
                
                const contractInput = document.createElement('input');
                contractInput.type = 'number';
                contractInput.id = `contract-${player.id}`;
                contractInput.className = 'transfer-contract';
                contractInput.min = '1';
                contractInput.max = '5';
                contractInput.value = defaultContract;
                contractInput.dataset.id = player.id;
                
                contractGroup.appendChild(contractLabel);
                contractGroup.appendChild(contractInput);
                
                // Add player type dropdown
                const playerTypeGroup = document.createElement('div');
                playerTypeGroup.className = 'form-group';
                
                const playerTypeLabel = document.createElement('label');
                playerTypeLabel.textContent = 'Player Type:';
                playerTypeLabel.htmlFor = `player-type-${player.id}`;
                
                const playerTypeSelect = document.createElement('select');
                playerTypeSelect.id = `player-type-${player.id}`;
                playerTypeSelect.className = 'player-type-select';
                playerTypeSelect.dataset.id = player.id;
                
                // Add player type options
                const typeOptions = [
                    { value: 'standard', text: 'Standard' },
                    { value: 'prime', text: 'Prime' },
                    { value: 'legend', text: 'Legend' },
                    { value: 'prime legend', text: 'Prime Legend' }
                ];
                
                typeOptions.forEach(option => {
                    const optElement = document.createElement('option');
                    optElement.value = option.value;
                    optElement.textContent = option.text;
                    // Set default selection based on player name if possible
                    if (player.type && player.type === option.value) {
                        optElement.selected = true;
                    }
                    playerTypeSelect.appendChild(optElement);
                });
                
                playerTypeGroup.appendChild(playerTypeLabel);
                playerTypeGroup.appendChild(playerTypeSelect);
                
                // Salary calculation (5% of value)
                const salaryGroup = document.createElement('div');
                salaryGroup.className = 'form-group';
                
                const salaryLabel = document.createElement('label');
                salaryLabel.textContent = 'Salary (5% of value):';
                
                const salaryValue = document.createElement('div');
                salaryValue.id = `salary-${player.id}`;
                salaryValue.style.backgroundColor = '#333';
                salaryValue.style.padding = '10px';
                salaryValue.style.borderRadius = '4px';
                salaryValue.style.color = '#bada55';
                salaryValue.style.fontWeight = 'bold';
                salaryValue.textContent = (player.value * 0.05).toFixed(1);
                
                salaryGroup.appendChild(salaryLabel);
                salaryGroup.appendChild(salaryValue);
                
                // Append all elements
                transferItem.appendChild(nameHeading);
                transferItem.appendChild(valueGroup);
                transferItem.appendChild(contractGroup);
                transferItem.appendChild(playerTypeGroup);  // Add player type before salary
                transferItem.appendChild(salaryGroup);
                
                fragment.appendChild(transferItem);
            });
            
            container.appendChild(fragment);
        }
        
        // Update player salary based on value
        function updatePlayerSalary(event) {
            const value = parseInt(event.target.value) || 0;
            const playerId = event.target.dataset.id;
            const salaryElement = document.getElementById(`salary-${playerId}`);
            
            if (salaryElement) {
                const salary = (value * 0.05).toFixed(1);
                salaryElement.textContent = salary;
            }
        }
        
        // Update all contracts with default value
        function updateAllContracts() {
            const defaultContract = parseInt(document.getElementById('default-contract').value) || 2;
            const contractInputs = document.querySelectorAll('.transfer-contract');
            
            contractInputs.forEach(input => {
                input.value = defaultContract;
            });
        }

        // Submit transfers
        async function submitTransfers() {
            if (!selectedTeam) {
                showStatusMessage('Please select a team first', false);
                return;
            }
            
            if (selectedPlayers.length === 0) {
                showStatusMessage('No players selected for transfer', false);
                return;
            }
            
            // Show saving indicator
            const submitBtn = document.getElementById('submit-transfers');
            const originalBtnText = submitBtn.textContent;
            submitBtn.textContent = 'Processing...';
            submitBtn.disabled = true;
            
            try {
                // Get the current season range
                const seasonStart = document.getElementById('season-start').value;
                const seasonEnd = document.getElementById('season-end').value;
                const seasonRange = `${seasonStart}-${seasonEnd}`;
                
                // Validate season
                if (!seasonStart || !seasonEnd || parseFloat(seasonStart) >= parseFloat(seasonEnd)) {
                    throw new Error('Invalid season range. End season must be greater than start season.');
                }
                
                // Get the manager to update
                const managerIndex = managersData.findIndex(m => m.club === selectedTeam.name);
                if (managerIndex === -1) {
                    throw new Error('Team manager not found in data');
                }
                
                // Create a deep copy of the manager data to modify
                const manager = JSON.parse(JSON.stringify(managersData[managerIndex]));
                
                // Ensure the manager has a squad and players array
                if (!manager.squad) {
                    manager.squad = { totalPlayers: 0, players: [] };
                }
                if (!manager.squad.players) {
                    manager.squad.players = [];
                }
                
                // Process each transfer
                const updatedPlayers = [];
                let totalTransferSpend = 0;
                let playersAdded = 0;
                
                console.log('Processing player transfers...');
                
                for (const player of selectedPlayers) {
                    // Get transfer details
                    const valueInput = document.getElementById(`value-${player.id}`);
                    const contractInput = document.getElementById(`contract-${player.id}`);
                    const playerTypeSelect = document.getElementById(`player-type-${player.id}`);
                    
                    const transferValue = parseInt(valueInput.value) || player.value;
                    const contractYears = parseInt(contractInput.value) || 2;
                    const salary = Math.round(transferValue * 0.05);
                    const playerType = playerTypeSelect ? playerTypeSelect.value : 'standard';
                    
                    console.log(`Player ${player.name} transfer details:`, {
                        value: transferValue,
                        contract: contractYears,
                        salary: salary,
                        type: playerType
                    });
                    
                    // Track total spend
                    totalTransferSpend += transferValue;
                    
                    // Create a new player for the squad
                    const squadPlayer = {
                        name: player.name,
                        position: player.position,
                        value: transferValue,
                        contract: `SEASON ${seasonEnd}`,
                        salary: parseFloat((transferValue * 0.05).toFixed(1)),
                        type: playerType  // Add the player type
                    };
                    
                    // Add to squad
                    manager.squad.players.push(squadPlayer);
                    playersAdded++;
                    
                    // Update the player in players.json
                    const playerIndex = playersData.findIndex(p => p.name === player.name);
                    if (playerIndex !== -1) {
                        // Create a deep copy of the player to modify
                        const updatedPlayer = JSON.parse(JSON.stringify(playersData[playerIndex]));
                        
                        // Update club and value
                        updatedPlayer.club = selectedTeam.name;
                        updatedPlayer.value = transferValue;
                        
                        // Explicitly set the player type - this is the key fix
                        updatedPlayer.type = playerType;
                        
                        console.log(`Updated player ${player.name} in players.json:`, {
                            club: updatedPlayer.club,
                            value: updatedPlayer.value,
                            type: updatedPlayer.type
                        });
                        
                        // Add the new season stats entry
                        if (!updatedPlayer.stats) {
                            updatedPlayer.stats = [];
                        }
                        
                        updatedPlayer.stats.push({
                            season: seasonRange,
                            team: selectedTeam.name,
                            value: transferValue.toString(),
                            apps: "00"  // Start with 0 appearances
                        });
                        
                        // Save to updated players array
                        updatedPlayers.push({ index: playerIndex, player: updatedPlayer });
                    }
                }
                
                // Update manager data
                manager.squad.totalPlayers = manager.squad.players.length;
                
                // Update club total value - sum of all player values
                manager.clubTotalValue = manager.squad.players.reduce((total, p) => total + p.value, 0);
                
                // Deduct transfer spending from manager's coins
                if (manager.coins) {
                    manager.coins -= totalTransferSpend;
                    if (manager.coins < 0) manager.coins = 0;
                }
                
                // Update the managers data array
                managersData[managerIndex] = manager;
                
                // Apply player updates to playersData array
                updatedPlayers.forEach(({ index, player }) => {
                    playersData[index] = player;
                    console.log(`Applied update to playersData[${index}]:`, 
                        { name: player.name, club: player.club, value: player.value, type: player.type });
                });
                
                // Save changes - first try GitHub if configured
                let savedToPermanentStorage = false;
                
                // Check if GitHub integration is configured
                if (githubConfig && githubConfig.isConfigured()) {
                    try {
                        // Save both files to GitHub
                        await saveToGitHub();
                        savedToPermanentStorage = true;
                    } catch (githubError) {
                        console.error('GitHub save failed:', githubError);
                        // Continue to try server save if GitHub fails
                    }
                } else {
                    console.log('GitHub integration not configured');
                }
                
                // If GitHub failed or not configured, try server
                if (!savedToPermanentStorage) {
                    const serverAvailable = await isServerAvailable();
                    if (serverAvailable) {
                        try {
                            console.log('Saving to local server...');
                            
                            // Format manager data correctly
                            let managersDataToSave;
                            if (Array.isArray(managersData)) {
                                // If managersData is already an array, wrap it in the expected object format
                                managersDataToSave = { managers: managersData };
                            } else {
                                // If it's something else, handle appropriately
                                managersDataToSave = managersData;
                                console.warn('Manager data is not in expected array format for saving');
                            }
                            
                            // Log payload sizes to help diagnose potential issues
                            const playersDataSize = JSON.stringify(playersData).length;
                            const managersDataSize = JSON.stringify(managersDataToSave).length;
                            console.log(`Data payload sizes - Players: ${(playersDataSize/1024/1024).toFixed(2)}MB, Managers: ${(managersDataSize/1024/1024).toFixed(2)}MB`);
                            
                            // Save players data
                            const savePlayersResponse = await fetch('http://localhost:3000/save-players', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(playersData)
                            });
                            
                            if (!savePlayersResponse.ok) {
                                throw new Error(`Failed to save player data: ${savePlayersResponse.status} ${savePlayersResponse.statusText}`);
                            }
                            
                            console.log('Players data saved successfully to server');
                            
                            // Save managers data
                            const saveManagersResponse = await fetch('http://localhost:3000/save-managers', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(managersDataToSave)
                            });
                            
                            if (!saveManagersResponse.ok) {
                                throw new Error(`Failed to save manager data: ${saveManagersResponse.status} ${saveManagersResponse.statusText}`);
                            }
                            
                            console.log('Managers data saved successfully to server');
                            savedToPermanentStorage = true;
                        } catch (error) {
                            console.error('Server save failed:', error);
                            // Show error to user but don't rethrow - we still want to continue
                            showStatusMessage(`Server save error: ${error.message}`, false, 10000);
                        }
                    } else {
                        console.log('Local server not available for saving data');
                    }
                }
                
                // Show success message with details
                const successMsg = `Successfully transferred ${playersAdded} player${playersAdded !== 1 ? 's' : ''} to ${selectedTeam.name} for a total of ${totalTransferSpend.toLocaleString()} RC.`;
                showStatusMessage(savedToPermanentStorage ? 
                    successMsg + ' Changes saved to storage.' :
                    successMsg + ' Warning: Changes are only in memory.', savedToPermanentStorage);
                
                // Clear the selected players and refresh the lists
                selectedPlayers = [];
                updateSelectedPlayersList();
                
                // Update squad info display
                updateSquadInfo();
                
                // Re-filter available players
                filterPlayers();
                
                // Add to transfer history
                selectedPlayers.forEach(player => {
                    addToTransferHistory({
                        type: 'outgoing',
                        playerName: player.name,
                        fromTeam: player.club || 'Free Agent',
                        toTeam: selectedTeam.name,
                        value: player.value,
                        revertible: true
                    });
                });
                
            } catch (error) {
                showStatusMessage(`Error: ${error.message}`, false);
                console.error('Error processing transfers:', error);
            } finally {
                // Restore button state
                submitBtn.textContent = originalBtnText;
                submitBtn.disabled = false;
            }
        }

        // Save to GitHub
        async function saveToGitHub() {
            try {
                // Check if GitHub integration is configured
                if (!githubConfig || !githubConfig.isConfigured()) {
                    throw new Error('GitHub integration is not configured');
                }
                
                // Show saving message
                showStatusMessage('Saving to GitHub...', true);
                
                // Save players.json
                await saveFileToGitHub(playersData, 'players.json', 'Update players from transfer system');
                
                // Save manager_data.json - wrap managers array in the correct object structure
                const managersDataFormatted = { managers: managersData };
                await saveFileToGitHub(managersDataFormatted, 'manager_data.json', 'Update managers from transfer system');
                
                showStatusMessage('Changes saved to GitHub! The site will update in a few minutes.', true);
                return true;
                
            } catch (error) {
                showStatusMessage(`GitHub Error: ${error.message}`, false);
                console.error('GitHub save error:', error);
                throw error; // Re-throw to be handled by the caller
            }
        }
        
        // Save a file to GitHub
        async function saveFileToGitHub(data, filePath, commitMessage) {
            try {
                // Check if GitHub integration is configured
                if (!githubConfig || !githubConfig.isConfigured()) {
                    throw new Error('GitHub integration is not configured');
                }
                
                // Get repository details
                const repoDetails = {
                    owner: githubConfig.getOwner(),
                    repo: githubConfig.getRepo(),
                    path: filePath,
                    branch: githubConfig.getBranch()
                };
                
                // Get the current file to get its SHA (required for the GitHub API)
                const fileInfoResponse = await fetch(`https://api.github.com/repos/${repoDetails.owner}/${repoDetails.repo}/contents/${repoDetails.path}?ref=${repoDetails.branch}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.getToken()}`
                    }
                });
                
                let currentSHA = '';
                let fileExists = true;
                
                if (fileInfoResponse.status === 404) {
                    // File doesn't exist yet
                    fileExists = false;
                } else if (!fileInfoResponse.ok) {
                    const errorData = await fileInfoResponse.json();
                    throw new Error(`GitHub API error: ${errorData.message}`);
                } else {
                    // File exists, get its SHA
                    const fileInfo = await fileInfoResponse.json();
                    currentSHA = fileInfo.sha;
                }
                
                // Prepare the content
                const jsonString = JSON.stringify(data, null, 2);
                const content = btoa(unescape(encodeURIComponent(jsonString)));
                
                // Prepare the commit message
                const fullCommitMessage = `${commitMessage} - ${new Date().toISOString()}`;
                
                // Prepare the request body
                const requestBody = {
                    message: fullCommitMessage,
                    content: content,
                    branch: repoDetails.branch
                };
                
                // Add SHA if the file exists
                if (fileExists) {
                    requestBody.sha = currentSHA;
                }
                
                // Commit the updated file
                const commitResponse = await fetch(`https://api.github.com/repos/${repoDetails.owner}/${repoDetails.repo}/contents/${repoDetails.path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!commitResponse.ok) {
                    const errorData = await commitResponse.json();
                    throw new Error(`GitHub API error: ${errorData.message}`);
                }
                
                return true;
                
            } catch (error) {
                console.error(`GitHub save error for ${filePath}:`, error);
                throw error; // Re-throw to be handled by the caller
            }
        }

        // Show status message
        function showStatusMessage(message, isSuccess, duration = 5000) {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.className = 'status-message';
            statusElement.classList.add(isSuccess ? 'status-success' : 'status-error');
            statusElement.style.display = 'block';
            
            // Auto-hide after duration, unless it's an error
            if (isSuccess) {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, duration);
            }
        }

        // Check GitHub configuration status and add UI elements if needed
        function checkGitHubConfigStatus() {
            if (!githubConfig || !githubConfig.isConfigured()) {
                console.log('GitHub integration not configured');
                
                // Add a warning message at the top of the container
                const container = document.querySelector('.container');
                if (container) {
                    const configMessage = document.createElement('div');
                    configMessage.className = 'status-message status-error';
                    configMessage.style.display = 'block';
                    configMessage.style.margin = '0 0 20px 0';
                    configMessage.textContent = 'GitHub integration not configured. Changes will not be saved permanently.';
                    
                    // Add a setup button
                    const setupButton = document.createElement('button');
                    setupButton.textContent = 'Configure GitHub';
                    setupButton.style.marginTop = '5px';
                    setupButton.style.backgroundColor = '#3f51b5';
                    setupButton.style.color = 'white';
                    setupButton.style.border = 'none';
                    setupButton.style.padding = '8px 12px';
                    setupButton.style.borderRadius = '4px';
                    setupButton.style.cursor = 'pointer';
                    
                    setupButton.addEventListener('click', () => {
                        window.location.href = 'token-setup.html';
                    });
                    
                    configMessage.appendChild(setupButton);
                    
                    // Insert at the top of container
                    container.insertBefore(configMessage, container.firstChild);
                }
                
                return false;
            }
            
            return true;
        }

        // Check for inconsistencies between manager data and players data
        function checkDataConsistency() {
            try {
                console.log('Checking data consistency between manager data and players data...');
                
                if (!managersData || !playersData) {
                    throw new Error('Data not loaded yet');
                }
                
                const results = {
                    playersInManagerButNotInPlayers: [],
                    playersWithWrongClub: [],
                    playersWithMissingStats: [],
                    playersWithMissingTypes: []
                };
                
                // Get all players in manager data
                const managerSquadPlayers = [];
                managersData.forEach(manager => {
                    if (manager.squad && manager.squad.players) {
                        manager.squad.players.forEach(squadPlayer => {
                            managerSquadPlayers.push({
                                name: squadPlayer.name,
                                club: manager.club,
                                value: squadPlayer.value,
                                position: squadPlayer.position,
                                manager: manager.name,
                                type: squadPlayer.type || 'standard'
                            });
                        });
                    }
                });
                
                console.log(`Found ${managerSquadPlayers.length} players in manager squad data`);
                
                // Check each player in manager data
                managerSquadPlayers.forEach(squadPlayer => {
                    const playerData = playersData.find(p => p.name === squadPlayer.name);
                    
                    if (!playerData) {
                        results.playersInManagerButNotInPlayers.push(squadPlayer);
                        return;
                    }
                    
                    if (playerData.club !== squadPlayer.club) {
                        results.playersWithWrongClub.push({
                            name: squadPlayer.name,
                            managerClub: squadPlayer.club,
                            playerDataClub: playerData.club || 'None',
                            manager: squadPlayer.manager,
                            value: squadPlayer.value,
                            type: squadPlayer.type
                        });
                    }
                    
                    if (playerData.stats && Array.isArray(playerData.stats)) {
                        const hasStatsForCurrentClub = playerData.stats.some(stat => stat.team === squadPlayer.club);
                        if (!hasStatsForCurrentClub) {
                            results.playersWithMissingStats.push({
                                name: squadPlayer.name,
                                club: squadPlayer.club,
                                stats: playerData.stats,
                                manager: squadPlayer.manager,
                                value: squadPlayer.value,
                                type: squadPlayer.type
                            });
                        }
                    } else if (squadPlayer.club) {
                        results.playersWithMissingStats.push({
                            name: squadPlayer.name,
                            club: squadPlayer.club,
                            stats: [],
                            manager: squadPlayer.manager,
                            value: squadPlayer.value,
                            type: squadPlayer.type
                        });
                    }
                    
                    if (!playerData.type && squadPlayer.type) {
                        results.playersWithMissingTypes.push({
                            name: squadPlayer.name,
                            club: squadPlayer.club,
                            managerType: squadPlayer.type,
                            playerDataType: playerData.type || 'None',
                            manager: squadPlayer.manager,
                            value: squadPlayer.value
                        });
                    } else if (playerData.type !== squadPlayer.type && squadPlayer.type) {
                        results.playersWithMissingTypes.push({
                            name: squadPlayer.name,
                            club: squadPlayer.club,
                            managerType: squadPlayer.type,
                            playerDataType: playerData.type || 'None',
                            manager: squadPlayer.manager,
                            value: squadPlayer.value
                        });
                    }
                });
                
                // Create a modal with options
                const resultsContainer = document.createElement('div');
                resultsContainer.style.position = 'fixed';
                resultsContainer.style.top = '10%';
                resultsContainer.style.left = '50%';
                resultsContainer.style.transform = 'translateX(-50%)';
                resultsContainer.style.backgroundColor = '#252525';
                resultsContainer.style.padding = '20px';
                resultsContainer.style.borderRadius = '8px';
                resultsContainer.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.5)';
                resultsContainer.style.zIndex = '1000';
                resultsContainer.style.maxHeight = '80vh';
                resultsContainer.style.overflow = 'auto';
                resultsContainer.style.maxWidth = '90%';
                resultsContainer.style.width = '800px';
                
                // Create buttons container
                const buttonsContainer = document.createElement('div');
                buttonsContainer.style.display = 'flex';
                buttonsContainer.style.gap = '10px';
                buttonsContainer.style.marginBottom = '20px';
                buttonsContainer.style.justifyContent = 'space-between';
                
                // Create download CSV button
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = 'Download Full Report (CSV)';
                downloadBtn.style.backgroundColor = '#4ecca3';
                downloadBtn.style.color = 'white';
                downloadBtn.style.border = 'none';
                downloadBtn.style.borderRadius = '4px';
                downloadBtn.style.cursor = 'pointer';
                downloadBtn.style.padding = '10px 20px';
                
                downloadBtn.addEventListener('click', () => {
                    generateAndDownloadCSV(results);
                });
                
                // Create close button
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'Close';
                closeBtn.style.backgroundColor = '#e53935';
                closeBtn.style.color = 'white';
                closeBtn.style.border = 'none';
                closeBtn.style.borderRadius = '4px';
                closeBtn.style.cursor = 'pointer';
                closeBtn.style.padding = '10px 20px';
                
                closeBtn.addEventListener('click', () => {
                    resultsContainer.remove();
                });
                
                // Create fix button
                const fixBtn = document.createElement('button');
                fixBtn.textContent = 'Fix All Issues';
                fixBtn.style.backgroundColor = '#3f51b5';
                fixBtn.style.color = 'white';
                fixBtn.style.border = 'none';
                fixBtn.style.borderRadius = '4px';
                fixBtn.style.cursor = 'pointer';
                fixBtn.style.padding = '10px 20px';
                
                fixBtn.addEventListener('click', () => {
                    fixDataInconsistencies(results);
                    resultsContainer.remove();
                });
                
                // Add buttons to container
                buttonsContainer.appendChild(downloadBtn);
                buttonsContainer.appendChild(fixBtn);
                buttonsContainer.appendChild(closeBtn);
                
                // Create summary text
                let summaryText = '<h3>Data Consistency Check Summary:</h3>';
                summaryText += `<p>Total issues found: ${
                    results.playersInManagerButNotInPlayers.length +
                    results.playersWithWrongClub.length +
                    results.playersWithMissingStats.length +
                    results.playersWithMissingTypes.length
                }</p>`;
                summaryText += `<ul>`;
                summaryText += `<li>Players missing from players.json: ${results.playersInManagerButNotInPlayers.length}</li>`;
                summaryText += `<li>Players with wrong club data: ${results.playersWithWrongClub.length}</li>`;
                summaryText += `<li>Players missing stats: ${results.playersWithMissingStats.length}</li>`;
                summaryText += `<li>Players with type issues: ${results.playersWithMissingTypes.length}</li>`;
                summaryText += `</ul>`;
                summaryText += `<p>Click "Download Full Report" to get a detailed CSV file with all issues.</p>`;
                
                // Create content container
                const contentDiv = document.createElement('div');
                contentDiv.innerHTML = summaryText;
                contentDiv.style.marginTop = '20px';
                
                // Add everything to the modal
                resultsContainer.appendChild(buttonsContainer);
                resultsContainer.appendChild(contentDiv);
                document.body.appendChild(resultsContainer);
                
            } catch (error) {
                console.error('Error checking data consistency:', error);
                showStatusMessage(`Error checking data: ${error.message}`, false);
            }
        }

        // Function to generate and download CSV
        function generateAndDownloadCSV(results) {
            try {
                // Create CSV content
                let csvContent = 'Issue Type,Player Name,Current Club,Expected Club,Manager,Value,Player Type,Expected Type,Additional Info\n';
                
                // Add missing players
                results.playersInManagerButNotInPlayers.forEach(player => {
                    csvContent += `Missing from players.json,${escapeCsvField(player.name)},${escapeCsvField(player.club)},,${
                        escapeCsvField(player.manager)},${player.value},${escapeCsvField(player.type)},,Player exists in manager data but not in players.json\n`;
                });
                
                // Add wrong club players
                results.playersWithWrongClub.forEach(player => {
                    csvContent += `Wrong Club,${escapeCsvField(player.name)},${escapeCsvField(player.playerDataClub)},${
                        escapeCsvField(player.managerClub)},${escapeCsvField(player.manager)},${player.value},${
                        escapeCsvField(player.type)},,Club mismatch between manager and player data\n`;
                });
                
                // Add missing stats players
                results.playersWithMissingStats.forEach(player => {
                    const currentStats = player.stats.map(stat => `${stat.season}:${stat.team}`).join('; ');
                    csvContent += `Missing Stats,${escapeCsvField(player.name)},${escapeCsvField(player.club)},,${
                        escapeCsvField(player.manager)},${player.value},${escapeCsvField(player.type)},,Current stats: ${escapeCsvField(currentStats)}\n`;
                });
                
                // Add type issues players
                results.playersWithMissingTypes.forEach(player => {
                    csvContent += `Type Issue,${escapeCsvField(player.name)},${escapeCsvField(player.club)},,${
                        escapeCsvField(player.manager)},${player.value},${escapeCsvField(player.playerDataType)},${
                        escapeCsvField(player.managerType)},Type mismatch or missing\n`;
                });
                
                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `data_issues_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                
                showStatusMessage('CSV file downloaded successfully', true);
            } catch (error) {
                console.error('Error generating CSV:', error);
                showStatusMessage('Error generating CSV file', false);
            }
        }

        // Helper function to escape CSV fields
        function escapeCsvField(field) {
            if (field === null || field === undefined) return '';
            return `"${String(field).replace(/"/g, '""')}"`;
        }

        // Fix data inconsistencies
        async function fixDataInconsistencies(results) {
            try {
                console.log('Fixing data inconsistencies...');
                showStatusMessage('Fixing data inconsistencies...', true);
                
                let fixedCount = 0;
                
                // Get current season range
                const seasonStart = document.getElementById('season-start').value;
                const seasonEnd = document.getElementById('season-end').value;
                
                // Process each player's stats
                for (let playerIndex = 0; playerIndex < playersData.length; playerIndex++) {
                    const player = playersData[playerIndex];
                    let statsNeedUpdate = false;
                    
                    // Initialize stats array if doesn't exist
                    if (!player.stats) {
                        player.stats = [];
                        statsNeedUpdate = true;
                    }

                    // Sort stats chronologically
                    player.stats.sort((a, b) => {
                        const aStart = parseFloat(a.season.split('-')[0]);
                        const bStart = parseFloat(b.season.split('-')[0]);
                        return aStart - bStart;
                    });

                    // Find the manager data for this player
                    const managerWithPlayer = managersData.find(manager => 
                        manager.squad?.players?.some(p => p.name === player.name)
                    );

                    if (managerWithPlayer) {
                        const squadPlayer = managerWithPlayer.squad.players.find(p => p.name === player.name);
                        
                        // Case 1: Handle FREE AGENT to team transition
                        if (player.club === "FREE AGENT" || !player.club) {
                            const lastStat = player.stats[player.stats.length - 1];
                            if (lastStat && lastStat.team === "FREE AGENT") {
                                // Update the FREE AGENT period to end at new transfer
                                const [statStart, statEnd] = lastStat.season.split('-').map(Number);
                                if (statEnd > parseFloat(seasonStart)) {
                                    lastStat.season = `${statStart}-${seasonStart}`;
                                    statsNeedUpdate = true;
                                }
                            }
                        }

                        // Case 2: Handle overlapping periods
                        player.stats = player.stats.map(stat => {
                            if (!stat.season || !stat.team) return stat;

                            const [statStart, statEnd] = stat.season.split('-').map(Number);
                            const newStart = parseFloat(seasonStart);
                            const newEnd = parseFloat(seasonEnd);

                            // If this stat period overlaps with new transfer period
                            if (statEnd > newStart) {
                                statsNeedUpdate = true;
                                return {
                                    ...stat,
                                    season: `${statStart}-${newStart}`
                                };
                            }
                            return stat;
                        });

                        // Case 3: Add new stat entry for current team
                        const newStat = {
                            season: `${seasonStart}-${seasonEnd}`,
                            team: managerWithPlayer.club,
                            value: squadPlayer.value.toString(),
                            apps: "00",
                            goals: "00",
                            assists: "00",
                            clean_sheets: "00",
                            cards: { yellow: "00", red: "00" }
                        };

                        // Only add if we don't have this exact period already
                        const hasExactPeriod = player.stats.some(stat => 
                            stat.season === `${seasonStart}-${seasonEnd}` && 
                            stat.team === managerWithPlayer.club
                        );

                        if (!hasExactPeriod) {
                            player.stats.push(newStat);
                            statsNeedUpdate = true;
                        }

                        // Update current club and value
                        if (player.club !== managerWithPlayer.club) {
                            player.club = managerWithPlayer.club;
                            statsNeedUpdate = true;
                        }
                        if (player.value !== squadPlayer.value) {
                            player.value = squadPlayer.value;
                            statsNeedUpdate = true;
                        }

                        // Update player type if needed
                        if (squadPlayer.type && player.type !== squadPlayer.type) {
                            player.type = squadPlayer.type;
                            statsNeedUpdate = true;
                        }

                        // Clean up and validate
                        if (statsNeedUpdate) {
                            // Remove any zero-length periods
                            player.stats = player.stats.filter(stat => {
                                const [start, end] = stat.season.split('-').map(Number);
                                return start < end;
                            });

                            // Sort stats again after modifications
                            player.stats.sort((a, b) => {
                                const aStart = parseFloat(a.season.split('-')[0]);
                                const bStart = parseFloat(b.season.split('-')[0]);
                                return aStart - bStart;
                            });

                            // Validate the updated stats
                            const validationErrors = validatePlayerStats(player.stats);
                            if (validationErrors.length > 0) {
                                console.warn(`Validation warnings for ${player.name}:`, validationErrors);
                            }

                            fixedCount++;
                        }
                    }
                }

                // Save changes
                let saved = false;
                
                // Try GitHub first
                if (githubConfig && githubConfig.isConfigured()) {
                    try {
                        await saveFileToGitHub(playersData, 'players.json', 'Fix player data inconsistencies');
                        saved = true;
                    } catch (error) {
                        console.error('Failed to save to GitHub:', error);
                    }
                }
                
                // Try server if GitHub failed
                if (!saved) {
                    const serverAvailable = await isServerAvailable();
                    if (serverAvailable) {
                        const saveResponse = await fetch('http://localhost:3000/save-players', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(playersData)
                        });
                        
                        if (saveResponse.ok) {
                            saved = true;
                        }
                    }
                }

                // Show results
                const message = `Fixed ${fixedCount} player records. ${saved ? 'Changes saved successfully.' : 'Changes only in memory.'}`;
                showStatusMessage(message, saved);
                console.log('Fix completed:', message);

            } catch (error) {
                console.error('Error fixing data inconsistencies:', error);
                showStatusMessage(`Error fixing data: ${error.message}`, false);
            }
        }

        // Function to handle player transfer
        async function handlePlayerTransfer(player, newTeam) {
            try {
                const seasonStart = document.getElementById('season-start').value;
                const seasonEnd = document.getElementById('season-end').value;
                const newSeasonRange = `${seasonStart}-${seasonEnd}`;
                const newStart = parseFloat(seasonStart);
                const newEnd = parseFloat(seasonEnd);

                // Find the player in the data
                const existingPlayer = playersData.find(p => p.name === player.name);
                
                if (existingPlayer) {
                    // Initialize stats if needed
                    if (!existingPlayer.stats) {
                        existingPlayer.stats = [];
                    }

                    // Sort stats chronologically
                    existingPlayer.stats.sort((a, b) => {
                        const aStart = parseFloat(a.season.split('-')[0]);
                        const bStart = parseFloat(b.season.split('-')[0]);
                        return aStart - bStart;
                    });

                    // Handle Free Agent cases
                    const isCurrentlyFreeAgent = existingPlayer.club === "FREE AGENT" || !existingPlayer.club;
                    const lastStat = existingPlayer.stats[existingPlayer.stats.length - 1];
                    const isLastStatFreeAgent = lastStat && lastStat.team === "FREE AGENT";

                    // Find all overlapping periods
                    const overlappingStats = existingPlayer.stats.filter(stat => {
                        if (!stat.season || !stat.team) return false;
                        const [statStart, statEnd] = stat.season.split('-').map(Number);
                        return (statStart <= newEnd && statEnd >= newStart);
                    });

                    // Handle different cases
                    if (isCurrentlyFreeAgent || isLastStatFreeAgent) {
                        // Free Agent Cases
                        handleFreeAgentTransfer(existingPlayer, newTeam, newSeasonRange, newStart, newEnd);
                    } else if (overlappingStats.length > 0) {
                        // Overlapping Period Cases
                        handleOverlappingTransfer(existingPlayer, overlappingStats, newTeam, newSeasonRange, newStart, newEnd);
                    } else {
                        // Regular Transfer Case
                        handleRegularTransfer(existingPlayer, newTeam, newSeasonRange);
                    }

                    // Clean up and validate
                    cleanupAndValidateStats(existingPlayer);

                    // Update current info
                    existingPlayer.club = newTeam;
                    existingPlayer.value = player.value;
                    if (player.type) {
                        existingPlayer.type = player.type;
                    }
                }

                return existingPlayer;
            } catch (error) {
                console.error('Error handling player transfer:', error);
                throw error;
            }
        }

        // Handle Free Agent Transfer
        function handleFreeAgentTransfer(player, newTeam, newSeasonRange, newStart, newEnd) {
            // Case 1: Update existing FREE AGENT period if it overlaps
            const freeAgentPeriods = player.stats.filter(stat => 
                stat.team === "FREE AGENT" &&
                parseFloat(stat.season.split('-')[1]) >= newStart
            );

            freeAgentPeriods.forEach(period => {
                const periodIndex = player.stats.indexOf(period);
                const [periodStart, periodEnd] = period.season.split('-').map(Number);

                if (periodEnd > newEnd) {
                    // Split the free agent period
                    player.stats[periodIndex].season = `${periodStart}-${newStart}`;
                    player.stats.push({
                        season: `${newEnd}-${periodEnd}`,
                        team: "FREE AGENT",
                        value: period.value,
                        apps: "00",
                        goals: "00",
                        assists: "00",
                        clean_sheets: "00",
                        cards: { yellow: "00", red: "00" }
                    });
                } else {
                    // Update the overlapping period
                    player.stats[periodIndex].season = `${periodStart}-${newStart}`;
                }
            });
        }

        // Function to handle overlapping transfer periods
        function handleOverlappingTransfer(existingPlayer, overlappingStats, newTeam, newSeasonRange, newStart, newEnd) {
            // Remove any existing stats for the exact same period and new team
            existingPlayer.stats = existingPlayer.stats.filter(stat => {
                if (!stat.season || !stat.team) return true;
                return !(stat.season === newSeasonRange && stat.team === newTeam);
            });

            // For each overlapping stat
            overlappingStats.forEach(stat => {
                const [statStart, statEnd] = stat.season.split('-').map(Number);
                
                // If exact same season range, just update the team
                if (stat.season === newSeasonRange) {
                    stat.team = newTeam;
                    return;
                }
                
                // If this is a transfer within the same season range (e.g. 6-8 to 6-8)
                // Remove the old entry completely and add the new one
                if (statStart === newStart && statEnd === newEnd) {
                    existingPlayer.stats = existingPlayer.stats.filter(s => s !== stat);
                    existingPlayer.stats.push({
                        season: newSeasonRange,
                        team: newTeam,
                        value: existingPlayer.value.toString(),
                        apps: "00",
                        goals: "00",
                        assists: "00",
                        clean_sheets: "00",
                        cards: { yellow: "00", red: "00" }
                    });
                    return;
                }

                // For other overlapping cases, split the period
                if (statEnd > newStart) {
                    stat.season = `${statStart}-${newStart}`;
                    
                    // Add the new period
                    existingPlayer.stats.push({
                        season: newSeasonRange,
                        team: newTeam,
                        value: existingPlayer.value.toString(),
                        apps: "00",
                        goals: "00",
                        assists: "00",
                        clean_sheets: "00",
                        cards: { yellow: "00", red: "00" }
                    });
                }
            });
        }

        // Handle Regular Transfer
        function handleRegularTransfer(player, newTeam, newSeasonRange) {
            // Add new stat entry
            player.stats.push(createNewStatEntry(newTeam, newSeasonRange));
        }

        // Create new stat entry
        function createNewStatEntry(team, seasonRange) {
            return {
                season: seasonRange,
                team: team,
                value: player.value.toString(),
                apps: "00",
                goals: "00",
                assists: "00",
                clean_sheets: "00",
                cards: { yellow: "00", red: "00" }
            };
        }

        // Clean up and validate stats
        function cleanupAndValidateStats(player) {
            // Remove invalid periods
            player.stats = player.stats.filter(stat => {
                if (!stat.season || !stat.team) return false;
                const [start, end] = stat.season.split('-').map(Number);
                return start < end && start % 0.5 === 0 && end % 0.5 === 0;
            });

            // Sort chronologically
            player.stats.sort((a, b) => {
                const aStart = parseFloat(a.season.split('-')[0]);
                const bStart = parseFloat(b.season.split('-')[0]);
                return aStart - bStart;
            });

            // Merge adjacent periods with same team
            for (let i = player.stats.length - 2; i >= 0; i--) {
                const current = player.stats[i];
                const next = player.stats[i + 1];
                
                if (current.team === next.team) {
                    const [currentStart, currentEnd] = current.season.split('-').map(Number);
                    const [nextStart, nextEnd] = next.season.split('-').map(Number);
                    
                    if (currentEnd === nextStart) {
                        current.season = `${currentStart}-${nextEnd}`;
                        player.stats.splice(i + 1, 1);
                    }
                }
            }

            // Validate final stats
            const validationErrors = validatePlayerStats(player.stats);
            if (validationErrors.length > 0) {
                console.warn(`Validation warnings for ${player.name}:`, validationErrors);
            }
        }

        // Function to validate player stats
        function validatePlayerStats(stats) {
            const errors = [];
            
            // Sort stats by start season for validation
            stats.sort((a, b) => {
                const aStart = parseFloat(a.season.split('-')[0]);
                const bStart = parseFloat(b.season.split('-')[0]);
                return aStart - bStart;
            });

            // Check for overlapping periods
            for (let i = 0; i < stats.length - 1; i++) {
                const current = stats[i];
                const next = stats[i + 1];
                
                const [currentStart, currentEnd] = current.season.split('-').map(Number);
                const [nextStart, nextEnd] = next.season.split('-').map(Number);

                if (currentEnd > nextStart) {
                    errors.push(`Overlapping periods: ${current.season} (${current.team}) and ${next.season} (${next.team})`);
                }
            }

            // Check for invalid periods
            stats.forEach(stat => {
                const [start, end] = stat.season.split('-').map(Number);
                if (start >= end) {
                    errors.push(`Invalid period: ${stat.season} (${stat.team})`);
                }
                if (start % 0.5 !== 0 || end % 0.5 !== 0) {
                    errors.push(`Non-half season values: ${stat.season} (${stat.team})`);
                }
            });

            return errors;
        }

        // Function to validate season range
        function validateSeasonRange(start, end) {
            const startNum = parseFloat(start);
            const endNum = parseFloat(end);
            
            if (isNaN(startNum) || isNaN(endNum)) {
                throw new Error('Invalid season numbers');
            }
            
            if (startNum >= endNum) {
                throw new Error('End season must be greater than start season');
            }
            
            if (startNum % 0.5 !== 0 || endNum % 0.5 !== 0) {
                throw new Error('Seasons must be in .5 increments');
            }
            
            return true;
        }

        // Function to save players data
        async function savePlayersData(playersData) {
            try {
                const response = await fetch('players.json', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(playersData, null, 2)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save players data');
                }
            } catch (error) {
                console.error('Error saving players data:', error);
                throw error;
            }
        }

        // Add this to your existing transfer button click handler
        document.getElementById('transfer-button').addEventListener('click', async function() {
            const selectedTeam = document.getElementById('team-selector').value;
            const selectedPlayers = getSelectedPlayers(); // Your existing function to get selected players
            
            try {
                for (const player of selectedPlayers) {
                    await handlePlayerTransfer(player, selectedTeam);
                }
                
                // Refresh the display after transfers are complete
                await refreshPlayerLists();
                showSuccessMessage('Players transferred successfully!');
            } catch (error) {
                showErrorMessage('Error transferring players: ' + error.message);
            }
        });

        // Helper function to show success message
        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            messageDiv.textContent = message;
            document.querySelector('.container').prepend(messageDiv);
            setTimeout(() => messageDiv.remove(), 3000);
        }

        // Helper function to show error message
        function showErrorMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'error-message';
            messageDiv.textContent = message;
            document.querySelector('.container').prepend(messageDiv);
            setTimeout(() => messageDiv.remove(), 3000);
        }

        // Add to transfer history
        let transferHistory = [];

        function addToTransferHistory(transfer) {
            const timestamp = new Date().toISOString();
            transferHistory.unshift({
                timestamp,
                ...transfer
            });

            // Save to localStorage
            localStorage.setItem('transferHistory', JSON.stringify(transferHistory));
            
            // Update history display
            displayTransferHistory();
        }

        function displayTransferHistory() {
            const container = document.getElementById('history-container');
            const filter = document.getElementById('history-filter').value;
            container.innerHTML = '';

            const filteredHistory = transferHistory.filter(transfer => {
                if (filter === 'all') return true;
                return transfer.type === filter;
            });

            filteredHistory.forEach(transfer => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const header = document.createElement('div');
                header.className = 'history-header';
                
                const timestamp = new Date(transfer.timestamp).toLocaleString();
                header.innerHTML = `
                    <div class="history-timestamp">${timestamp}</div>
                    <div class="history-type ${transfer.type}">${transfer.type.toUpperCase()}</div>
                `;

                const details = document.createElement('div');
                details.className = 'history-details';
                
                details.innerHTML = `
                    <div class="history-changes">
                        <div class="history-old">
                            <div class="history-label">From:</div>
                            <div>${transfer.fromTeam || 'N/A'}</div>
                        </div>
                        <div class="history-new">
                            <div class="history-label">To:</div>
                            <div>${transfer.toTeam}</div>
                        </div>
                    </div>
                    <div class="history-player" style="margin-top: 10px;">
                        <div class="history-label">Player:</div>
                        <div>${transfer.playerName} (${transfer.value} RC)</div>
                    </div>
                `;

                // Add revert button if transfer is revertible
                if (transfer.revertible) {
                    const revertBtn = document.createElement('button');
                    revertBtn.className = 'history-btn revert';
                    revertBtn.innerHTML = '<i class="fas fa-undo"></i> Revert';
                    revertBtn.onclick = () => revertTransfer(transfer);
                    details.appendChild(revertBtn);
                }

                historyItem.appendChild(header);
                historyItem.appendChild(details);
                container.appendChild(historyItem);
            });
        }

        function revertTransfer(transfer) {
            if (confirm(`Are you sure you want to revert the transfer of ${transfer.playerName}?`)) {
                // Add revert transfer to history
                addToTransferHistory({
                    type: transfer.type === 'incoming' ? 'outgoing' : 'incoming',
                    playerName: transfer.playerName,
                    fromTeam: transfer.toTeam,
                    toTeam: transfer.fromTeam,
                    value: transfer.value,
                    description: `Reverted: ${transfer.description}`,
                    revertible: false
                });

                // Trigger the actual transfer reversion
                // This would need to be implemented based on your transfer system
                handleTransferReversion(transfer);
            }
        }

        // Function to handle reverting a transfer
        function handleTransferReversion(transfer) {
            try {
                console.log('Reverting transfer:', transfer);
                
                // Find the player in players data
                const playerIndex = playersData.findIndex(p => p.name === transfer.playerName);
                if (playerIndex === -1) {
                    showStatusMessage(`Player not found: ${transfer.playerName}`, false);
                    return;
                }
                
                const player = playersData[playerIndex];
                
                // Update the player's club back to the original team
                player.club = transfer.fromTeam;
                
                // Update stats if needed
                if (player.stats && Array.isArray(player.stats)) {
                    // Find the latest stat for this team
                    const currentTeamStat = player.stats.find(s => s.team === transfer.toTeam);
                    if (currentTeamStat) {
                        // Update team in the stat
                        currentTeamStat.team = transfer.fromTeam;
                    }
                }
                
                // If the player was in a manager's squad, update that as well
                const managerIndex = managersData.findIndex(m => m.club === transfer.toTeam);
                if (managerIndex !== -1) {
                    const manager = managersData[managerIndex];
                    
                    if (manager.squad && manager.squad.players) {
                        const squadPlayerIndex = manager.squad.players.findIndex(p => p.name === transfer.playerName);
                        if (squadPlayerIndex !== -1) {
                            // Remove from current team's squad
                            manager.squad.players.splice(squadPlayerIndex, 1);
                            manager.squad.totalPlayers = manager.squad.players.length;
                        }
                    }
                }
                
                // If there's a target team that's not "FREE AGENT", add to that team
                if (transfer.fromTeam && transfer.fromTeam !== "FREE AGENT") {
                    const targetManagerIndex = managersData.findIndex(m => m.club === transfer.fromTeam);
                    if (targetManagerIndex !== -1) {
                        const targetManager = managersData[targetManagerIndex];
                        
                        // Ensure squad structure exists
                        if (!targetManager.squad) {
                            targetManager.squad = { totalPlayers: 0, players: [] };
                        }
                        if (!targetManager.squad.players) {
                            targetManager.squad.players = [];
                        }
                        
                        // Add player to target team's squad
                        targetManager.squad.players.push({
                            name: transfer.playerName,
                            position: player.position,
                            value: parseInt(transfer.value),
                            contract: "REVERTED",
                            salary: Math.round(parseInt(transfer.value) * 0.05)
                        });
                        
                        targetManager.squad.totalPlayers = targetManager.squad.players.length;
                    }
                }
                
                // Update playersData with the reverted player
                playersData[playerIndex] = player;
                
                // Show success message
                showStatusMessage(`Successfully reverted ${transfer.playerName}'s transfer to ${transfer.fromTeam || 'FREE AGENT'}`, true);
                
                // Try to save changes
                saveChanges().catch(error => {
                    console.error('Error saving changes after reversion:', error);
                    showStatusMessage('Changes are only in memory. Error saving permanently.', false);
                });
            } catch (error) {
                console.error('Error reverting transfer:', error);
                showStatusMessage(`Error: ${error.message}`, false);
            }
        }

        // Helper function to save changes
        async function saveChanges() {
            let saved = false;
            
            // Try GitHub first
            if (githubConfig && githubConfig.isConfigured()) {
                try {
                    await saveToGitHub();
                    saved = true;
                    console.log('Successfully saved changes to GitHub');
                } catch (error) {
                    console.error('Failed to save to GitHub:', error);
                }
            }
            
            // Try server if GitHub failed
            if (!saved) {
                const serverAvailable = await isServerAvailable();
                if (serverAvailable) {
                    try {
                        console.log('Saving to local server...');
                        
                        // Format manager data correctly
                        let managersDataToSave;
                        if (Array.isArray(managersData)) {
                            // If managersData is already an array, wrap it in the expected object format
                            managersDataToSave = { managers: managersData };
                        } else {
                            // If it's something else, handle appropriately
                            managersDataToSave = managersData;
                            console.warn('Manager data is not in expected array format for saving');
                        }
                        
                        // Log payload sizes to help diagnose potential issues
                        const playersDataSize = JSON.stringify(playersData).length;
                        const managersDataSize = JSON.stringify(managersDataToSave).length;
                        console.log(`Data payload sizes - Players: ${(playersDataSize/1024/1024).toFixed(2)}MB, Managers: ${(managersDataSize/1024/1024).toFixed(2)}MB`);
                        
                        // Save players data first
                        const savePlayersResponse = await fetch('http://localhost:3000/save-players', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(playersData)
                        });
                        
                        if (!savePlayersResponse.ok) {
                            throw new Error(`Failed to save player data: ${savePlayersResponse.status} ${savePlayersResponse.statusText}`);
                        }
                        
                        console.log('Players data saved successfully to server');
                        
                        // Save managers data
                        const saveManagersResponse = await fetch('http://localhost:3000/save-managers', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(managersDataToSave)
                        });
                        
                        if (!saveManagersResponse.ok) {
                            throw new Error(`Failed to save manager data: ${saveManagersResponse.status} ${saveManagersResponse.statusText}`);
                        }
                        
                        console.log('Managers data saved successfully to server');
                        saved = true;
                    } catch (error) {
                        console.error('Server save failed:', error);
                        showStatusMessage(`Server save error: ${error.message}`, false, 10000);
                        throw error; // Re-throw for caller to handle
                    }
                } else {
                    console.log('Local server not available for saving data');
                }
            }
            
            return saved;
        }

        // Load history from localStorage on init
        document.addEventListener('DOMContentLoaded', () => {
            const savedHistory = localStorage.getItem('transferHistory');
            if (savedHistory) {
                transferHistory = JSON.parse(savedHistory);
            }

            // Add history filter change handler
            document.getElementById('history-filter').addEventListener('change', displayTransferHistory);
            
            // Add refresh button handler
            document.getElementById('refresh-history').addEventListener('click', displayTransferHistory);
        });

        // Modify your existing submitTransfers function to add to history
        const originalSubmitTransfers = submitTransfers;
        submitTransfers = async function() {
            // Store the current state
            const previousState = {
                selectedPlayers: [...selectedPlayers],
                selectedTeam: {...selectedTeam}
            };

            try {
                // Call the original function
                await originalSubmitTransfers();

                // Add successful transfers to history
                selectedPlayers.forEach(player => {
                    addToTransferHistory({
                        type: 'incoming',
                        playerName: player.name,
                        fromTeam: player.club || 'Free Agent',
                        toTeam: selectedTeam.name,
                        value: player.value,
                        revertible: true
                    });
                });
            } catch (error) {
                console.error('Transfer failed:', error);
            }
        };

        // Add this function after the existing checkDataConsistency function
        async function fixSeasonEightConsistency() {
            try {
                console.log('Starting Season 8 data consistency check...');
                const statusElement = document.getElementById('status-message');
                statusElement.textContent = 'Running Season 8 data consistency check...';
                statusElement.className = 'status-message status-success';
                statusElement.style.display = 'block';
                
                const fixes = {
                    freeAgentUpdates: 0,
                    seasonSplits: 0,
                    teamUpdates: 0,
                    errors: []
                };

                // First, collect all Season 8 players from manager data
                const season8Players = new Map(); // Map to store player info by name
                
                // Check if managersData is available and properly structured
                if (!Array.isArray(managersData) || managersData.length === 0) {
                    throw new Error('Manager data is not properly loaded. Please reload the page and try again.');
                }
                
                managersData.forEach(manager => {
                    if (!manager.squad?.players) return;
                    
                    manager.squad.players.forEach(player => {
                        if (player.contract === "SEASON 8") {
                            season8Players.set(player.name, {
                                name: player.name,
                                currentTeam: manager.club,
                                position: player.position,
                                value: player.value,
                                type: player.type || 'standard'
                            });
                        }
                    });
                });

                console.log(`Found ${season8Players.size} players in Season 8`);
                
                // Check if we have Season 8 player data
                if (season8Players.size === 0) {
                    showStatusMessage('No Season 8 players found in manager data.', false);
                    return;
                }

                // Check if playersData is available
                if (!Array.isArray(playersData) || playersData.length === 0) {
                    throw new Error('Player data is not properly loaded. Please reload the page and try again.');
                }

                // Now check these players in players.json
                for (const player of playersData) {
                    const season8Info = season8Players.get(player.name);
                    if (!season8Info) continue; // Skip if not a Season 8 player

                    let needsUpdate = false;
                    let statsUpdated = false;

                    // Initialize stats array if it doesn't exist
                    if (!player.stats) {
                        player.stats = [];
                        needsUpdate = true;
                    }

                    // Sort stats chronologically
                    player.stats.sort((a, b) => {
                        const aStart = parseFloat(a.season?.split('-')?.[0] || 0);
                        const bStart = parseFloat(b.season?.split('-')?.[0] || 0);
                        return aStart - bStart;
                    });

                    // Get the latest stat entry
                    const latestStat = player.stats[player.stats.length - 1];

                    // Case 1: Latest stat is FREE AGENT
                    if (latestStat && latestStat.team === "FREE AGENT") {
                        try {
                            const [start, end] = latestStat.season.split('-').map(Number);
                            if (end === 8) {
                                // Update the FREE AGENT period to end at current season start
                                latestStat.season = `${start}-6`;
                                // Add new entry for current team
                                player.stats.push({
                                    season: "6-8",
                                    team: season8Info.currentTeam,
                                    value: season8Info.value.toString(),
                                    apps: "00",
                                    goals: "00",
                                    assists: "00",
                                    clean_sheets: "00",
                                    cards: { yellow: "00", red: "00" }
                                });
                                fixes.freeAgentUpdates++;
                                statsUpdated = true;
                            }
                        } catch (error) {
                            console.error(`Error processing FREE AGENT stats for ${player.name}:`, error);
                            fixes.errors.push(`Error with ${player.name} FREE AGENT stats: ${error.message}`);
                        }
                    }

                    // Case 2: Has previous team stats that need splitting
                    player.stats = player.stats.map(stat => {
                        if (!stat.season || !stat.team) return stat;
                        try {
                            const [start, end] = stat.season.split('-').map(Number);
                            
                            // If stat period overlaps with Season 8 and team is different
                            if (end === 8 && stat.team !== season8Info.currentTeam) {
                                fixes.seasonSplits++;
                                statsUpdated = true;
                                // Split the period
                                return {
                                    ...stat,
                                    season: `${start}-6`
                                };
                            }
                            return stat;
                        } catch (error) {
                            console.error(`Error processing stats period for ${player.name}:`, error);
                            fixes.errors.push(`Error with ${player.name} stats period: ${error.message}`);
                            return stat; // Return unchanged if error
                        }
                    });

                    // Add new Season 8 entry if needed
                    const hasSeason8Entry = player.stats.some(stat => {
                        try {
                            if (!stat.season || !stat.team) return false;
                            const [start, end] = stat.season.split('-').map(Number);
                            return end === 8 && stat.team === season8Info.currentTeam;
                        } catch (error) {
                            console.error(`Error checking Season 8 entry for ${player.name}:`, error);
                            return false;
                        }
                    });

                    if (!hasSeason8Entry) {
                        player.stats.push({
                            season: "6-8",
                            team: season8Info.currentTeam,
                            value: season8Info.value.toString(),
                            apps: "00",
                            goals: "00",
                            assists: "00",
                            clean_sheets: "00",
                            cards: { yellow: "00", red: "00" }
                        });
                        fixes.teamUpdates++;
                        statsUpdated = true;
                    }

                    // Update current club and value
                    if (player.club !== season8Info.currentTeam || player.value !== season8Info.value) {
                        player.club = season8Info.currentTeam;
                        player.value = season8Info.value;
                        needsUpdate = true;
                    }

                    // Update player type if needed
                    if (season8Info.type && player.type !== season8Info.type) {
                        player.type = season8Info.type;
                        needsUpdate = true;
                    }

                    if (needsUpdate || statsUpdated) {
                        // Clean up and validate stats
                        player.stats = player.stats.filter(stat => {
                            if (!stat.season || !stat.team) return false;
                            try {
                                const [start, end] = stat.season.split('-').map(Number);
                                return start < end && start % 0.5 === 0 && end % 0.5 === 0;
                            } catch (error) {
                                console.error(`Error filtering invalid stat periods for ${player.name}:`, error);
                                return false; // Remove invalid entries
                            }
                        });

                        // Sort stats chronologically
                        player.stats.sort((a, b) => {
                            try {
                                const aStart = parseFloat(a.season.split('-')[0]);
                                const bStart = parseFloat(b.season.split('-')[0]);
                                return aStart - bStart;
                            } catch (error) {
                                console.error(`Error sorting stats for ${player.name}:`, error);
                                return 0; // Don't change order if error
                            }
                        });
                    }
                }

                // Save changes
                let saved = false;
                
                // Try GitHub first
                if (githubConfig && githubConfig.isConfigured()) {
                    try {
                        await saveToGitHub();
                        saved = true;
                        console.log('Successfully saved changes to GitHub');
                    } catch (error) {
                        console.error('Failed to save to GitHub:', error);
                    }
                }
                
                // Try server if GitHub failed
                if (!saved) {
                    const serverAvailable = await isServerAvailable();
                    if (serverAvailable) {
                        try {
                            console.log('Saving to local server...');
                            
                            // Save players data
                            const saveResponse = await fetch('http://localhost:3000/save-players', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(playersData)
                            });
                            
                            if (!saveResponse.ok) {
                                throw new Error(`Failed to save data: ${saveResponse.status} ${saveResponse.statusText}`);
                            }
                            
                            console.log('Player data saved successfully to server');
                            saved = true;
                        } catch (error) {
                            console.error('Server save failed:', error);
                            showStatusMessage(`Server save error: ${error.message}`, false, 10000);
                        }
                    } else {
                        console.log('Local server not available for saving data');
                    }
                }

                // Show results
                let message = '';
                if (fixes.errors.length > 0) {
                    message = `Completed with ${fixes.errors.length} errors. `;
                }
                
                message += `
                    Fixed ${fixes.freeAgentUpdates} free agent transitions
                    Split ${fixes.seasonSplits} season periods
                    Updated ${fixes.teamUpdates} team assignments
                    ${saved ? 'Changes saved successfully.' : 'Changes only in memory.'}
                `;
                
                showStatusMessage(message, saved);
                console.log('Fix completed:', message);
                
                if (fixes.errors.length > 0) {
                    console.warn('Fix completed with errors:', fixes.errors);
                }

            } catch (error) {
                console.error('Error fixing data consistency:', error);
                showStatusMessage(`Error fixing data: ${error.message}`, false);
            }
        }

        // Add button to UI for this function
        document.getElementById('debug-controls').innerHTML += `
            <button id="fix-season8-data" style="background-color: #4ecca3; margin-left: 10px;">
                Fix Season 8 Data
            </button>
        `;

        // Add event listener
        document.getElementById('fix-season8-data').addEventListener('click', fixSeasonEightConsistency);

        // Check if save endpoints are working properly
        async function checkSaveEndpoints() {
            try {
                // First check if server is available
                const serverAvailable = await isServerAvailable();
                if (!serverAvailable) {
                    console.log('Server is not available');
                    return {
                        available: false,
                        reason: 'Server is not reachable',
                        savePlayersEndpointWorks: false,
                        saveManagersEndpointWorks: false
                    };
                }
                
                // Check players endpoint
                let savePlayersEndpointWorks = false;
                try {
                    const pingPlayersResponse = await fetch('http://localhost:3000/save-players', {
                        method: 'HEAD',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    // If endpoint exists, HEAD should return 200 or 405 (Method not allowed)
                    savePlayersEndpointWorks = pingPlayersResponse.status === 200 || pingPlayersResponse.status === 405;
                } catch (error) {
                    console.log('Error testing players save endpoint:', error);
                }
                
                // Check managers endpoint
                let saveManagersEndpointWorks = false;
                try {
                    const pingManagersResponse = await fetch('http://localhost:3000/save-managers', {
                        method: 'HEAD',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    // If endpoint exists, HEAD should return 200 or 405 (Method not allowed)
                    saveManagersEndpointWorks = pingManagersResponse.status === 200 || pingManagersResponse.status === 405;
                } catch (error) {
                    console.log('Error testing managers save endpoint:', error);
                }
                
                const available = savePlayersEndpointWorks && saveManagersEndpointWorks;
                
                return {
                    available,
                    reason: available ? 'All endpoints available' : 'One or more save endpoints missing',
                    savePlayersEndpointWorks,
                    saveManagersEndpointWorks
                };
            } catch (error) {
                console.error('Error checking save endpoints:', error);
                return {
                    available: false,
                    reason: 'Error checking endpoints: ' + error.message,
                    savePlayersEndpointWorks: false,
                    saveManagersEndpointWorks: false
                };
            }
        }

        // Check save endpoints on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Add this after other initialization
            try {
                const endpointStatus = await checkSaveEndpoints();
                if (!endpointStatus.available) {
                    console.warn('Save endpoints check failed:', endpointStatus.reason);
                    
                    if (endpointStatus.savePlayersEndpointWorks !== endpointStatus.saveManagersEndpointWorks) {
                        // If only one endpoint works, show specific warning
                        const failedEndpoint = !endpointStatus.savePlayersEndpointWorks ? 'players' : 'managers';
                        showStatusMessage(`Warning: ${failedEndpoint} save endpoint is not available. Changes may not persist correctly.`, false, 0);
                    } else {
                        // General warning if both don't work
                        console.log('Both server save endpoints are unavailable. Changes will only be in memory unless GitHub is configured.');
                    }
                } else {
                    console.log('Save endpoints are working properly');
                }
            } catch (error) {
                console.error('Error during save endpoints check:', error);
            }
        });
    </script>
    
    <!-- Performance optimization JS -->
    <script>
        // Immediately executed critical JS
        document.addEventListener('DOMContentLoaded', function() {
            // Add loading indicator for mobile
            if (window.innerWidth <= 768) {
                // Add loading class to body
                document.body.classList.add('mobile-loading');
                
                // Create loading indicator
                const loadingEl = document.createElement('div');
                loadingEl.className = 'mobile-loading-indicator';
                loadingEl.innerHTML = '<div class="loading-spinner"></div><div class="loading-text">Loading players...</div>';
                document.body.appendChild(loadingEl);
                
                // Remove loading after a short delay (or when data is actually loaded)
                setTimeout(() => {
                    document.body.classList.remove('mobile-loading');
                    loadingEl.style.opacity = '0';
                    setTimeout(() => {
                        loadingEl.remove();
                    }, 300);
                }, 1500);
                
                // Show mobile quick navigation
                const quickNav = document.getElementById('mobile-quick-nav');
                if (quickNav) {
                    quickNav.style.display = 'flex';
                    
                    // Add event listeners to quick nav buttons
                    const quickNavButtons = quickNav.querySelectorAll('.quick-nav-btn');
                    quickNavButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            const targetId = this.getAttribute('data-target');
                            const targetElement = document.getElementById(targetId) || document.querySelector('.' + targetId);
                            
                            if (targetElement) {
                                // Add some additional offset for better scrolling
                                const yOffset = -20; 
                                const y = targetElement.getBoundingClientRect().top + window.pageYOffset + yOffset;
                                
                                window.scrollTo({
                                    top: y,
                                    behavior: 'smooth'
                                });
                                
                                // Add visual feedback for the selected button
                                quickNavButtons.forEach(btn => btn.style.backgroundColor = '#252525');
                                this.style.backgroundColor = '#4ecca3';
                                this.style.color = '#121212';
                                
                                // Reset after a short delay
                                setTimeout(() => {
                                    this.style.backgroundColor = '#252525';
                                    this.style.color = '#e0e0e0';
                                }, 500);
                            }
                        });
                    });
                }
            }
            
            // Focus on team selector
            setTimeout(() => {
                const teamSelector = document.getElementById('team-selector');
                if (teamSelector) {
                    teamSelector.focus();
                }
            }, 500);
        });
    </script>

    <div class="nav-links">
        <a href="token-setup.html"><i class="fas fa-key"></i> GitHub Token Setup</a>
        <a href="transfer-debug.html"><i class="fas fa-bug"></i> Debug Saving</a>
    </div>
</body>
</html> 