<!DOCTYPE html>
<html lang="en">
<head>
    <!-- PWA support -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3498db">
    <link rel="apple-touch-icon" href="/assets/images/logo11.webp">

    <!-- DNS prefetch and preconnect -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" media="print" onload="this.media='all'" crossorigin>
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"></noscript>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://assets.mixkit.co">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="icon" href="assets/images/logo11.webp" type="image/webp">
    <link rel="shortcut icon" href="assets/images/logo11.webp" type="image/webp">
    <link rel="apple-touch-icon" href="/assets/images/logo11.webp">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>R2G Transfer Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" media="print" onload="this.media='all'" crossorigin>
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"></noscript>
    <link rel="stylesheet" href="css/club-dropdown.css">
    <!-- Load club manager scripts in the correct order -->
    <script src="js/club-loader.js"></script>
    <script src="js/club-manager.js"></script>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
        }
        .header {
            background-color: #1e1e1e;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            color: #fff;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .username {
            color: #4ecca3;
        }
        .logout-btn {
            background-color: #e53935;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .logout-btn:hover {
            background-color: #c62828;
        }
        .container {
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 70px);
            box-sizing: border-box;
            max-width: 1400px;
            margin: 0 auto;
        }
        .team-selection {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-left: 4px solid #4ecca3;
        }
        .team-selection h2 {
            color: #fff;
            font-size: 20px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #393939;
            display: flex;
            align-items: center;
        }
        .team-selection h2:before {
            content: "\f1e3";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            margin-right: 10px;
            color: #4ecca3;
        }
        .team-selector-container {
            position: relative;
        }
        .team-selector-container:after {
            content: "\f078";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #4ecca3;
            pointer-events: none;
        }
        #team-selector {
            appearance: none;
            padding: 12px 15px;
            background-color: #252525;
            border: 1px solid #333;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        #team-selector:hover {
            border-color: #4ecca3;
        }
        #team-selector:focus {
            border-color: #4ecca3;
            box-shadow: 0 0 0 2px rgba(78, 204, 163, 0.2);
        }
        #debug-controls {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
        }
        #debug-select-team {
            background-color: #333;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        #debug-select-team:hover {
            background-color: #444;
        }
        #debug-select-team:active {
            transform: translateY(1px);
        }
        .players-container {
            display: flex;
            flex: 1;
            gap: 20px;
        }
        .available-players {
            flex: 1;
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
            max-height: 700px;
        }
        .selected-players {
            flex: 1;
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
            max-height: 700px;
        }
        h2 {
            margin-top: 0;
            border-bottom: 1px solid #393939;
            padding-bottom: 10px;
            color: #fff;
        }
        .search-box {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #252525;
            color: #fff;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .search-box:focus {
            border-color: #4ecca3;
            outline: none;
            box-shadow: 0 0 0 2px rgba(78, 204, 163, 0.2);
        }
        .player-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s;
            background-color: #252525;
            animation: fadeIn 0.3s ease-out;
        }
        .player-item:hover {
            background-color: #303030;
            transform: translateY(-2px);
        }
        .player-thumbnail {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            margin-right: 12px;
            object-fit: cover;
        }
        .player-info {
            flex-grow: 1;
        }
        .player-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: bold;
            color: #fff;
        }
        .player-details {
            font-size: 12px;
            color: #aaa;
            margin-top: 2px;
        }
        .player-value {
            color: #4ecca3;
            font-weight: bold;
            margin-left: 5px;
            padding: 3px 8px;
            background-color: rgba(78, 204, 163, 0.1);
            border-radius: 4px;
        }
        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #3f51b5;
            color: white;
            border: none;
            cursor: pointer;
            margin-left: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }
        .action-btn:hover {
            transform: scale(1.1);
        }
        .add-btn {
            background-color: #4ecca3;
        }
        .add-btn:hover {
            background-color: #3da88a;
        }
        .remove-btn {
            background-color: #e53935;
        }
        .remove-btn:hover {
            background-color: #c62828;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #e0e0e0;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #252525;
            color: #fff;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus {
            border-color: #4ecca3;
            outline: none;
            box-shadow: 0 0 0 2px rgba(78, 204, 163, 0.2);
        }
        .team-dropdown {
            position: relative;
        }
        .team-search {
            padding-right: 30px;
        }
        .team-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #252525;
            border: 1px solid #444;
            border-radius: 0 0 6px 6px;
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .club-option {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            user-select: none;
        }
        .club-option:hover {
            background-color: #303030;
            transform: translateX(3px);
        }
        .club-option:last-child {
            border-bottom: none;
        }
        .club-logo {
            width: 28px;
            height: 28px;
            margin-right: 12px;
            object-fit: contain;
        }
        .club-option span {
            color: #fff;
            font-size: 14px;
            font-weight: 500;
        }
        .transfer-settings {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .transfer-item {
            background-color: #252525;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            position: relative;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .transfer-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .transfer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        .submit-container {
            margin-top: 20px;
            text-align: right;
        }
        .submit-btn {
            background-color: #4ecca3;
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .submit-btn:hover {
            background-color: #3da88a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .submit-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .status-message {
            padding: 12px 16px;
            margin-top: 15px;
            border-radius: 6px;
            display: none;
            font-weight: 500;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .status-success {
            background-color: rgba(78, 204, 163, 0.15);
            color: #4ecca3;
            border: 1px solid rgba(78, 204, 163, 0.3);
        }
        .status-error {
            background-color: rgba(229, 57, 53, 0.15);
            color: #e57373;
            border: 1px solid rgba(229, 57, 53, 0.3);
        }
        .filters {
            display: flex;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .filter-group {
            width: 100%;
        }
        
        .filter-group input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            font-size: 15px;
            border-radius: 6px;
            border: 1px solid #444;
            background-color: #252525;
            color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 768px) {
            .filters {
                margin-bottom: 10px;
            }
            
            .filter-group input[type="text"] {
                padding: 10px 12px;
                font-size: 14px;
            }
        }
        .season-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .season-input input {
            width: 80px;
        }
        .season-input span {
            color: #bbb;
        }
        .selected-team-display {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 18px;
            margin-bottom: 18px;
            padding: 16px;
            background-color: #252525;
            border-radius: 8px;
            border-left: 4px solid #4ecca3;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.3s ease-out;
        }
        
        .selected-team-logo {
            width: 48px;
            height: 48px;
            object-fit: contain;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            padding: 6px;
        }
        
        #selected-team-name {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }
        
        .squad-info {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .squad-info-item {
            background-color: #252525;
            border-radius: 8px;
            padding: 18px 15px;
            flex: 1;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            border-top: 3px solid #4ecca3;
        }
        
        .squad-info-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .squad-info-value {
            font-size: 24px;
            font-weight: bold;
            color: #4ecca3;
        }
        
        .squad-info-label {
            font-size: 14px;
            color: #aaa;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .season-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 20px;
            background-color: #252525;
            padding: 15px;
            border-radius: 6px;
        }
        
        .season-input label {
            color: #4ecca3;
            font-weight: bold;
            margin-bottom: 0;
            margin-right: 5px;
        }
        
        .season-input input {
            width: 80px;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #3f3f3f;
            background-color: #1e1e1e;
            color: #fff;
            text-align: center;
            font-weight: bold;
        }
        
        .season-input span {
            color: #ccc;
            margin: 0 5px;
        }
        
        @media (max-width: 768px) {
            .selected-team-display {
                padding: 12px;
                margin-top: 15px;
                margin-bottom: 15px;
                border-radius: 6px;
            }
            
            .selected-team-logo {
                width: 38px;
                height: 38px;
                padding: 4px;
            }
            
            #selected-team-name {
                font-size: 16px;
            }
        }

        /* Current Squad Styles */
        .current-squad-section {
            margin-bottom: 30px;
        }

        .current-squad-section h3 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 1.2rem;
            padding-bottom: 8px;
            border-bottom: 1px solid #393939;
        }

        .squad-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .squad-player-card {
            background: #252525;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .squad-player-card:hover {
            background: #303030;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .squad-player-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .squad-player-name {
            font-weight: 600;
            color: #fff;
            font-size: 1.1rem;
        }

        .squad-player-details {
            color: #aaa;
            font-size: 0.9rem;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }
            
            .players-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .header {
                flex-direction: column;
                padding: 12px 8px;
                text-align: center;
            }
            
            .header h1 {
                margin-bottom: 8px;
                font-size: 18px;
            }
            
            .user-info {
                width: 100%;
                justify-content: center;
                margin-top: 5px;
            }
            
            .filters {
                flex-direction: column;
                gap: 8px;
                margin-bottom: 10px;
            }
            
            .transfer-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            /* Make available players list container more compact for mobile */
            .available-players {
                max-height: 320px;
                margin-bottom: 15px;
                padding: 15px;
            }
            
            .selected-players {
                padding: 15px;
                max-height: none;
            }
            
            .player-item {
                padding: 8px 10px;
                margin-bottom: 4px;
                border-radius: 5px;
            }
            
            .player-thumbnail {
                width: 30px;
                height: 30px;
                margin-right: 8px;
            }
            
            .player-name {
                font-size: 13px;
            }
            
            .player-details {
                font-size: 10px;
            }
            
            .player-value {
                font-size: 11px;
                padding: 2px 6px;
            }
            
            /* Increase action button touchable area */
            .action-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            /* Adjust form elements for touch */
            button, input, select {
                padding: 12px 10px;
                font-size: 16px; /* Prevents iOS zoom on focus */
                border-radius: 5px;
            }
            
            label {
                font-size: 13px;
                margin-bottom: 4px;
            }

            /* Improve team selection area for mobile */
            .team-selection {
                padding: 16px;
                margin-bottom: 15px;
                border-radius: 6px;
            }
            
            .team-selection h2 {
                font-size: 17px;
                margin-bottom: 12px;
                padding-bottom: 8px;
            }
            
            #team-selector {
                padding: 12px;
                font-size: 15px;
            }
            
            #debug-controls {
                margin-top: 15px;
                justify-content: center;
            }
            
            #debug-select-team {
                padding: 8px 12px;
                font-size: 13px;
                width: 100%;
                max-width: 200px;
            }
            
            h2 {
                font-size: 16px;
                margin-bottom: 10px;
            }
            
            h3 {
                font-size: 15px;
            }

            /* Make squad info more compact */
            .squad-info {
                gap: 6px;
                flex-wrap: wrap;
            }
            
            .squad-info-item {
                padding: 10px;
                min-width: 75px;
            }

            .squad-info-value {
                font-size: 15px;
            }

            .squad-info-label {
                font-size: 10px;
            }
            
            /* Improve navigation */
            .nav-links {
                padding: 8px 5px;
                gap: 5px;
                z-index: 10;
            }
            
            .nav-links a {
                padding: 8px;
                font-size: 12px;
                justify-content: center;
                flex: 1;
                min-width: 0;
            }
            
            .nav-links a i {
                margin-right: 4px;
            }
            
            /* Improve squad grid for mobile */
            .squad-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 8px;
            }
            
            .squad-player-card {
                padding: 10px;
            }
            
            .squad-player-name {
                font-size: 13px;
            }
            
            .squad-player-details {
                font-size: 10px;
            }
            
            /* Improve submit button */
            .submit-btn {
                width: 100%;
                padding: 14px;
                margin-top: 10px;
            }
            
            /* Improve status message */
            .status-message {
                padding: 10px;
                font-size: 13px;
            }
            
            /* Season input for mobile */
            .season-input {
                padding: 12px;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .season-inputs {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .season-input input {
                width: 60px;
                padding: 8px;
            }
            
            .season-example {
                display: block;
                width: 100%;
                font-size: 12px;
                margin-top: 8px;
                text-align: center;
                color: #999;
            }
            
            /* Improve the selected team display */
            .selected-team-display {
                padding: 10px;
                margin-top: 10px;
            }
            
            /* Improve transfer settings */
            .transfer-settings {
                padding: 15px;
            }
            
            .transfer-item {
                padding: 12px;
                margin-bottom: 8px;
            }

            /* Mobile player items */
            .player-item:active {
                transform: scale(0.98);
                background-color: #2a2a2a;
            }
            
            /* Improve mobile action buttons */
            .action-btn:active {
                transform: scale(0.9);
            }
            
            /* Add a subtle separator between players */
            .player-item:not(:last-child) {
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                border-radius: 5px 5px 0 0;
            }
            
            .player-item:last-child {
                margin-bottom: 15px;
            }
            
            /* Improve text truncation on small screens */
            .player-name {
                max-width: 120px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            /* Regular list headers */
            .available-players h2, .selected-players h2 {
                background-color: #1e1e1e;
                padding-top: 15px;
                margin-top: 0;
            }
            
            .mobile-quick-nav {
                padding: 10px 5px;
            }
            
            .quick-nav-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        .nav-links {
            background-color: #1e1e1e;
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 20px;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .nav-links a {
            color: #e0e0e0;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-links a:hover {
            background-color: #252525;
            color: #4ecca3;
        }
        
        .nav-links i {
            font-size: 16px;
        }
        
        @media (max-width: 768px) {
            .nav-links {
                padding: 10px;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .nav-links a {
                padding: 8px 12px;
                font-size: 14px;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        #available-players-list .player-item {
            animation: slideIn 0.3s ease-out;
        }

        /* Mobile loading styles */
        .mobile-loading {
            overflow: hidden;
        }
        
        .mobile-loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(18, 18, 18, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(78, 204, 163, 0.3);
            border-radius: 50%;
            border-top-color: #4ecca3;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        .loading-text {
            color: #e0e0e0;
            font-size: 14px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Add touch momentum scrolling for iOS */
        .available-players, .selected-players {
            -webkit-overflow-scrolling: touch;
        }
        
        @media (max-width: 768px) {
            /* Improve tap highlights on mobile */
            .player-item, .action-btn, button, .club-option {
                -webkit-tap-highlight-color: rgba(78, 204, 163, 0.1);
            }
        }

        /* Mobile sticky header and navigation */
        @media (max-width: 768px) {
            /* Quick jump navigation */
            .mobile-quick-nav {
                display: flex;
                gap: 8px;
                padding: 10px 5px;
                justify-content: center;
                margin-bottom: 10px;
                background-color: #121212;
                z-index: 9;
            }
            
            .quick-nav-btn {
                background-color: #252525;
                color: #e0e0e0;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
                white-space: nowrap;
            }
            
            .quick-nav-btn:active {
                background-color: #4ecca3;
                color: #121212;
            }
            
            /* Regular list headers */
            .available-players h2, .selected-players h2 {
                background-color: #1e1e1e;
                padding-top: 15px;
                margin-top: 0;
            }
        }

        /* Quick jump navigation */
        .mobile-quick-nav {
            display: flex;
            gap: 8px;
            padding: 12px 5px;
            justify-content: center;
            margin-bottom: 15px;
            background-color: #1a1a1a;
            border-radius: 6px;
        }
        
        .quick-nav-btn {
            background-color: #252525;
            color: #e0e0e0;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .season-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .season-example {
            color: #aaa;
            font-style: italic;
            margin-left: 10px;
        }
    </style>

    <!-- Performance optimized CSS -->
    <link rel="stylesheet" href="css/performance.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="css/performance.css">
    <link rel="stylesheet" href="css/additional-fixes.css"></noscript>

    <!-- Club dropdown styles (inline since club-dropdown.css doesn't exist) -->
    <style>
        .team-dropdown {
            position: relative;
        }
        
        .team-search {
            padding-right: 30px;
        }
        
        .team-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #252525;
            border: 1px solid #444;
            border-radius: 0 0 6px 6px;
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .club-option {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            user-select: none;
        }
        
        .club-option:hover {
            background-color: #303030;
            transform: translateX(3px);
        }
        
        .club-option:last-child {
            border-bottom: none;
        }
        
        .club-logo {
            width: 28px;
            height: 28px;
            margin-right: 12px;
            object-fit: contain;
        }
        
        .club-option span {
            color: #fff;
            font-size: 14px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>R2G Transfer Admin Panel</h1>
        <div class="user-info">
            <span>Logged in as: <span class="username" id="logged-user">Admin</span></span>
            <button class="logout-btn" id="logout-btn">Logout</button>
        </div>
    </div>
    
    <div class="container">
        <!-- Mobile Quick Navigation -->
        <div class="mobile-quick-nav" id="mobile-quick-nav" style="display: none;">
            <button class="quick-nav-btn" data-target="team-selection">Team</button>
            <button class="quick-nav-btn" data-target="available-players">Available</button>
            <button class="quick-nav-btn" data-target="selected-players">Selected</button>
            <button class="quick-nav-btn" data-target="transfer-settings">Settings</button>
        </div>
        
        <div class="team-selection">
            <h2>Select Team</h2>
            <div class="form-group">
                <label for="team-selector">Select Team to Transfer Players To:</label>
                <div class="team-selector-container">
                    <select id="team-selector" class="search-box">
                        <option value="">-- Select a team --</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>
            <div id="selected-team-display" style="display: none;" class="selected-team-display">
                <img id="selected-team-logo" class="selected-team-logo" src="" alt="Team Logo">
                <span id="selected-team-name"></span>
            </div>
            <div id="squad-info" class="squad-info" style="display: none;">
                <div class="squad-info-item">
                    <div id="squad-size" class="squad-info-value">0</div>
                    <div class="squad-info-label">Squad Size</div>
                </div>
                <div class="squad-info-item">
                    <div id="squad-budget" class="squad-info-value">0</div>
                    <div class="squad-info-label">R2G Coins</div>
                    <button id="fix-coins-btn" title="Fix R2G Coins display" style="background-color: #444; margin-top: 5px; font-size: 12px; padding: 3px 6px; border: none; border-radius: 4px; color: white; cursor: pointer;">Fix Coins</button>
                </div>
            </div>
            <div class="form-group season-input">
                <label for="season-start">Season:</label>
                <div class="season-inputs">
                    <input type="number" id="season-start" min="1" max="20" value="6" step="0.5">
                    <span>-</span>
                    <input type="number" id="season-end" min="1" max="20" value="8" step="0.5">
                </div>
                <span class="season-example">(e.g. 6-8)</span>
            </div>
            
            <div id="debug-controls">
                <button id="debug-select-team" title="Automatically select the first available team">Debug Select Team</button>
                <button id="debug-check-data" title="Check for inconsistencies between manager data and players data" style="background-color: #444; margin-left: 10px;">Check Data Consistency</button>
            </div>
        </div>
        
        <div class="players-container">
            <div class="available-players">
                <h2>Available Players</h2>
                <div class="filters">
                    <div class="filter-group">
                        <label for="player-search">Search:</label>
                        <input type="text" id="player-search" placeholder="Search players..." class="search-box">
                    </div>
                </div>
                <div id="available-players-list">
                    <!-- Players will be populated here -->
                </div>
            </div>
            
            <div class="selected-players">
                <h2>Selected Players for Transfer</h2>
                <div id="selected-players-list">
                    <!-- Selected players will be populated here -->
                </div>
                <div id="transfer-settings" class="transfer-settings" style="display: none;">
                    <h3>Transfer Settings</h3>
                    <div class="form-group">
                        <label for="default-contract">Default Contract Length (years):</label>
                        <input type="number" id="default-contract" min="1" max="5" value="2" step="1">
                    </div>
                    <p>You can adjust individual values and contracts below:</p>
                    <div id="transfer-details" class="transfer-grid">
                        <!-- Transfer details will be populated here -->
                    </div>
                    <div class="submit-container">
                        <button id="submit-transfers" class="submit-btn">Complete Transfers</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="status-message" class="status-message"></div>
    </div>

    <!-- Add GitHub configuration script -->
    <script defer src="github-config.js"></script>
    <script>
        // GitHub configuration check
        let githubConfig = null;
        
        function initGitHubConfig() {
            if (typeof window.githubConfig !== 'undefined') {
                githubConfig = window.githubConfig;
                console.log('GitHub config loaded from global object');
                return true;
            }
            
            // Fallback implementation if github-config.js is not available
            githubConfig = {
                isConfigured: function() {
                    return !!localStorage.getItem('githubToken');
                },
                getToken: function() {
                    return localStorage.getItem('githubToken');
                },
                getOwner: function() {
                    return localStorage.getItem('githubOwner') || 'default-owner';
                },
                getRepo: function() {
                    return localStorage.getItem('githubRepo') || 'default-repo';
                },
                getBranch: function() {
                    return localStorage.getItem('githubBranch') || 'main';
                }
            };
            
            return githubConfig.isConfigured();
        }
    
        // Authentication check
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading indicator
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = 'Loading...';
            statusElement.className = 'status-message status-success';
            statusElement.style.display = 'block';
            
            // Check if logged in
            const isLoggedIn = sessionStorage.getItem('transferAdminLoggedIn');
            if (!isLoggedIn) {
                // Redirect to login page
                window.location.href = 'transfer-login.html';
                return;
            }
            
            // Set logged in username
            document.getElementById('logged-user').textContent = sessionStorage.getItem('transferAdminUsername') || 'Admin';
            
            // Initialize the transfer panel
            initTransferPanel().then(() => {
                // Check GitHub config after UI is showing
                if (!localStorage.getItem('githubToken')) {
                    const configMessage = document.createElement('div');
                    configMessage.className = 'status-message status-error';
                    configMessage.style.display = 'block';
                    configMessage.textContent = 'GitHub integration not configured. Changes will only be saved in memory.';
                    configMessage.style.marginBottom = '10px';
                    
                    // Add setup button
                    const setupButton = document.createElement('button');
                    setupButton.textContent = 'Configure GitHub';
                    setupButton.style.marginTop = '5px';
                    setupButton.addEventListener('click', () => {
                        window.location.href = 'token-setup.html';
                    });
                    
                    configMessage.appendChild(setupButton);
                    
                    // Insert at the top of container
                    const container = document.querySelector('.container');
                    container.insertBefore(configMessage, container.firstChild);
                }
            });
        });

        // Logout function
        function performLogout() {
            // Clear session data
            sessionStorage.removeItem('transferAdminLoggedIn');
            sessionStorage.removeItem('transferAdminUsername');
            
            // Redirect to login page
            window.location.href = 'transfer-login.html';
        }

        // Global variables
        let playersData = [];
        let managersData = [];
        let selectedTeam = null;
        let selectedPlayers = [];
        let filteredPlayers = [];
        
        // Initialize transfer panel
        async function initTransferPanel() {
            try {
                // Show loading in status element
                const statusElement = document.getElementById('status-message');
                statusElement.textContent = 'Loading player and team data...';
                statusElement.className = 'status-message status-success';
                statusElement.style.display = 'block';
                
                // Initialize GitHub config first
                initGitHubConfig();
                
                // Add GitHub configuration message if needed
                checkGitHubConfigStatus();
                
                // Load data first before setting up the UI
                let loadedData = false;
                
                const loadPromise = new Promise(async (resolve) => {
                    try {
                        // Check if server is available
                        const serverAvailable = await isServerAvailable();
                        
                        if (serverAvailable) {
                            // Load players from server
                            const playersResponse = await fetch('http://localhost:3000/players.json');
                            if (playersResponse.ok) {
                                playersData = await playersResponse.json();
                                
                                // Load managers data
                                const managersResponse = await fetch('http://localhost:3000/manager_data.json');
                                if (managersResponse.ok) {
                                    managersData = await managersResponse.json();
                                    console.log('Loaded data from Node.js server');
                                    resolve(true);
                                    return;
                                }
                            }
                        }
                        
                        // Fallback: Load from files
                        console.log('Server not available, loading from files');
                        const playersResponse = await fetch('players.json');
                        const managersResponse = await fetch('manager_data.json');
                        
                        if (playersResponse.ok && managersResponse.ok) {
                            playersData = await playersResponse.json();
                            const managersRawData = await managersResponse.json();
                            
                            // Make sure managersData is in the right format
                            if (Array.isArray(managersRawData.managers)) {
                                // If the data is an object with a managers array property, use that
                                console.log('Manager data has managers array property');
                                managersData = managersRawData.managers;
                            } else if (Array.isArray(managersRawData)) {
                                // If it's already an array, use it directly
                                managersData = managersRawData;
                            } else {
                                console.error('Manager data has unexpected format:', typeof managersRawData);
                                managersData = [];
                            }
                            
                            console.log(`Data loaded from files: ${playersData.length} players, ${managersData.length} managers`);
                            console.log('First few managers:', managersData.slice(0, 3));
                            
                            // Show server warning
                            showStatusMessage('Warning: Data server is not running. Changes will not be saved.', false);
                            resolve(true);
                        } else {
                            throw new Error('Failed to load data');
                        }
                    } catch (error) {
                        console.error('Error loading data:', error);
                        resolve(false);
                    }
                });
                
                // Set timeout for loading
                const timeoutPromise = new Promise(resolve => {
                    setTimeout(() => {
                        if (!loadedData) {
                            statusElement.textContent = 'Still loading... This may take a moment.';
                        }
                        resolve(false);
                    }, 1500);
                });
                
                // Wait for data or timeout
                loadedData = await Promise.race([loadPromise, timeoutPromise]);
                
                // Wait for actual data if timeout happened first
                if (!loadedData) {
                    loadedData = await loadPromise;
                }
                
                if (!loadedData) {
                    throw new Error('Failed to load data');
                }
                
                // Add unique ID to each player if missing
                playersData = playersData.map((player, index) => ({
                    ...player,
                    id: player.id ? Number(player.id) : (index + 1)
                }));
                
                // Set up filtered players list
                filteredPlayers = [...playersData];
                
                // Now set up event listeners after data is loaded
                setupEventListeners();
                
                // Populate available players list
                populateAvailablePlayers();
                
                // Hide loading status
                statusElement.style.display = 'none';
                
                return Promise.resolve();
                
            } catch (error) {
                showStatusMessage(`Error: ${error.message}`, false);
                console.error('Error initializing transfer panel:', error);
                return Promise.resolve(); // Still resolve to continue
            }
        }

        // Helper function to check if server is available
        async function isServerAvailable() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 500);  // 500ms timeout
                
                const response = await fetch('http://localhost:3000/players.json', {
                    method: 'HEAD',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                return response.ok;
            } catch (error) {
                console.log('Server check failed:', error.name);
                return false;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', performLogout);
            
            // Team selector
            const teamSelector = document.getElementById('team-selector');
            if (teamSelector) {
                // Populate team selector options
                populateTeamSelector();
                
                // Add change event handler
                teamSelector.addEventListener('change', function() {
                    const selectedTeamName = this.value;
                    if (selectedTeamName) {
                        selectTeam(selectedTeamName);
                    }
                });
            }
            
            // Player filters
            document.getElementById('player-search').addEventListener('input', filterPlayers);
            
            // Default contract change
            document.getElementById('default-contract').addEventListener('change', updateAllContracts);
            
            // Submit transfers button
            document.getElementById('submit-transfers').addEventListener('click', submitTransfers);
            
            // Debug button for team selection
            const debugBtn = document.getElementById('debug-select-team');
            if (debugBtn) {
                debugBtn.addEventListener('click', function() {
                    console.log('Debug button clicked');
                    console.log('Manager data length:', managersData.length);
                    
                    if (managersData.length > 0) {
                        // Find first manager with a club
                        const firstManager = managersData.find(m => m.club);
                        if (firstManager) {
                            console.log('Selecting first team:', firstManager.club);
                            const selector = document.getElementById('team-selector');
                            if (selector) {
                                selector.value = firstManager.club;
                                selectTeam(firstManager.club);
                            }
                        } else {
                            console.error('No manager with club found');
                            showStatusMessage('No teams available', false);
                        }
                    } else {
                        console.error('No managers data available');
                        showStatusMessage('Manager data not loaded', false);
                    }
                });
            }
            
            // Debug button for data consistency check
            const debugCheckBtn = document.getElementById('debug-check-data');
            if (debugCheckBtn) {
                debugCheckBtn.addEventListener('click', checkDataConsistency);
            }
            
            // Fix R2G Coins button
            const fixCoinsBtn = document.getElementById('fix-coins-btn');
            if (fixCoinsBtn) {
                fixCoinsBtn.addEventListener('click', function() {
                    if (!selectedTeam || !selectedTeam.manager) {
                        showStatusMessage('No team selected', false);
                        return;
                    }
                    
                    // Log current manager data
                    console.log('Current manager data:', selectedTeam.manager);
                    
                    // Create dialog for manual R2G coin balance entry
                    const coinValue = prompt('Enter R2G Coin balance:', '2000');
                    if (coinValue !== null) {
                        const coinNumber = parseInt(coinValue.trim());
                        if (!isNaN(coinNumber)) {
                            // Add the property to the manager in all possible formats
                            selectedTeam.manager.r2g_coin_balance = coinNumber;
                            selectedTeam.manager.r2gCoinBalance = coinNumber;
                            selectedTeam.manager.r2g_coins = coinNumber;
                            selectedTeam.manager.r2gCoins = coinNumber;
                            selectedTeam.manager.coins = coinNumber;
                            
                            // Also update in the managers data array
                            const managerIndex = managersData.findIndex(m => m.club === selectedTeam.name);
                            if (managerIndex !== -1) {
                                managersData[managerIndex].r2g_coin_balance = coinNumber;
                                managersData[managerIndex].r2gCoinBalance = coinNumber;
                                managersData[managerIndex].r2g_coins = coinNumber;
                                managersData[managerIndex].r2gCoins = coinNumber;
                                managersData[managerIndex].coins = coinNumber;
                            }
                            
                            // Update display
                            updateSquadInfo();
                            showStatusMessage(`R2G Coin balance updated to ${coinNumber}`, true);
                        } else {
                            showStatusMessage('Invalid value. Please enter a number.', false);
                        }
                    }
                });
            }
        }

        // Populate the team selector dropdown
        function populateTeamSelector() {
            const selector = document.getElementById('team-selector');
            if (!selector) {
                console.error('Team selector element not found');
                return;
            }
            
            // Keep the first empty option
            selector.innerHTML = '<option value="">-- Select a team --</option>';
            
            try {
                if (!managersData || !Array.isArray(managersData) || managersData.length === 0) {
                    console.error('No manager data available');
                    return;
                }
                
                // Get all teams with unique club names
                const teams = managersData
                    .filter(manager => manager.club)
                    .sort((a, b) => a.club.localeCompare(b.club));
                
                console.log(`Found ${teams.length} teams to add to selector`);
                
                // Add each team as an option
                teams.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager.club;
                    option.textContent = manager.club;
                    selector.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error populating team selector:', error);
            }
        }

        // Select a team
        function selectTeam(teamName) {
            console.log('selectTeam called for:', teamName);
            
            if (!teamName) {
                console.error('No team name provided');
                showStatusMessage('Please select a valid team', false);
                return;
            }
            
            // Find the manager with this team
            const manager = managersData.find(m => m.club === teamName);
            
            if (!manager) {
                console.error(`Team "${teamName}" not found in manager data`);
                showStatusMessage(`Team "${teamName}" not found in manager data`, false);
                return;
            }
            
            console.log('Found manager for team:', manager);
            
            // Try to get logo from club-manager if available
            let logoPath = 'assets/images/logo11.webp'; // default logo
            
            // Debug club manager
            console.log('ClubManager available:', !!window.ClubManager);
            console.log('ClubManager getClub available:', !!(window.ClubManager && window.ClubManager.getClub));
            console.log('ClubManager initialized:', !!(window.ClubManager && window.ClubManager.initialized));
            
            if (window.ClubManager && window.ClubManager.getClub) {
                // Initialize club manager if needed
                if (window.ClubManager.initialize && !window.ClubManager.initialized) {
                    console.log('Initializing ClubManager...');
                    try {
                        window.ClubManager.initialize();
                    } catch (e) {
                        console.error('Error initializing ClubManager:', e);
                    }
                }
                
                const club = window.ClubManager.getClub(teamName);
                console.log('Club data for', teamName, ':', club);
                
                if (club && club.logo) {
                    logoPath = club.logo;
                    console.log('Found club logo:', logoPath);
                } else {
                    console.log('No logo found for club in ClubManager');
                }
            } else {
                console.log('ClubManager not available or missing getClub method');
            }
            
            // Make sure logo path is correct - remove any leading slash
            if (logoPath.startsWith('/')) {
                logoPath = logoPath.substring(1);
                console.log('Fixed logo path by removing leading slash:', logoPath);
            }
            
            selectedTeam = {
                name: teamName,
                manager: manager,
                logo: logoPath
            };
            
            // Show the selected team display
            const display = document.getElementById('selected-team-display');
            const logo = document.getElementById('selected-team-logo');
            const name = document.getElementById('selected-team-name');
            
            if (!display || !logo || !name) {
                console.error('Selected team display elements not found');
                return;
            }
            
            display.style.display = 'flex';
            logo.src = selectedTeam.logo;
            logo.onerror = function() {
                console.error('Error loading logo image:', selectedTeam.logo);
                this.src = 'assets/images/logo11.webp';
                this.onerror = null;
            };
            name.textContent = selectedTeam.name;
            
            // Show squad info
            updateSquadInfo();
            
            // Show current squad players
            showCurrentSquadPlayers();
            
            // Re-filter available players to exclude current squad
            filterPlayers();
            
            // Show success message
            showStatusMessage(`Team "${teamName}" selected successfully`, true, 2000);
        }

        // Show current squad players
        function showCurrentSquadPlayers() {
            const container = document.getElementById('selected-players-list');
            const transferSettings = document.getElementById('transfer-settings');
            
            // Clear the container
            container.innerHTML = '';
            
            // Add a section for current squad
            const currentSquadSection = document.createElement('div');
            currentSquadSection.className = 'current-squad-section';
            
            const squadHeader = document.createElement('h3');
            squadHeader.textContent = 'Current Squad';
            currentSquadSection.appendChild(squadHeader);
            
            // Get current squad players
            const currentSquad = selectedTeam.manager.squad?.players || [];
            
            if (currentSquad.length === 0) {
                const noPlayers = document.createElement('p');
                noPlayers.textContent = 'No players in current squad';
                noPlayers.style.textAlign = 'center';
                noPlayers.style.color = '#888';
                noPlayers.style.padding = '20px';
                currentSquadSection.appendChild(noPlayers);
            } else {
                // Create a grid for current squad players
                const squadGrid = document.createElement('div');
                squadGrid.className = 'squad-grid';
                
                currentSquad.forEach(player => {
                    const playerCard = document.createElement('div');
                    playerCard.className = 'squad-player-card';
                    
                    // Player info
                    const playerInfo = document.createElement('div');
                    playerInfo.className = 'squad-player-info';
                    
                    const playerName = document.createElement('div');
                    playerName.className = 'squad-player-name';
                    playerName.textContent = player.name;
                    
                    const playerDetails = document.createElement('div');
                    playerDetails.className = 'squad-player-details';
                    playerDetails.textContent = `${player.position} | Value: ${player.value.toLocaleString()} RC | Contract: ${player.contract} years`;
                    
                    playerInfo.appendChild(playerName);
                    playerInfo.appendChild(playerDetails);
                    
                    playerCard.appendChild(playerInfo);
                    squadGrid.appendChild(playerCard);
                });
                
                currentSquadSection.appendChild(squadGrid);
            }
            
            // Add a separator
            const separator = document.createElement('hr');
            separator.style.margin = '20px 0';
            separator.style.border = 'none';
            separator.style.borderTop = '1px solid rgba(255, 255, 255, 0.1)';
            
            // Add the new players section header
            const newPlayersHeader = document.createElement('h3');
            newPlayersHeader.textContent = 'New Players to Transfer';
            
            // Add all elements to the container
            container.appendChild(currentSquadSection);
            container.appendChild(separator);
            container.appendChild(newPlayersHeader);
            
            // Show transfer settings if there are selected players
            if (selectedPlayers.length > 0) {
                transferSettings.style.display = 'block';
                updateTransferDetails();
            } else {
                transferSettings.style.display = 'none';
            }
        }

        // Update squad information display
        function updateSquadInfo() {
            if (!selectedTeam || !selectedTeam.manager) return;
            
            const squadInfo = document.getElementById('squad-info');
            const squadSize = document.getElementById('squad-size');
            const squadBudget = document.getElementById('squad-budget');
            
            const manager = selectedTeam.manager;
            
            // Debug manager data
            console.log('Manager data:', JSON.stringify(manager));
            console.log('Manager properties:', Object.keys(manager));
            
            // Show the squad info section
            squadInfo.style.display = 'flex';
            
            // Update squad size
            const currentSquadSize = manager.squad?.players?.length || 0;
            squadSize.textContent = currentSquadSize;
            
            // Debug budget related properties
            console.log('r2g_coin_balance:', manager.r2g_coin_balance);
            console.log('r2gCoinBalance:', manager.r2gCoinBalance);
            console.log('r2g_coins:', manager.r2g_coins);
            console.log('r2gCoins:', manager.r2gCoins);
            console.log('coins:', manager.coins);
            console.log('budget:', manager.budget);
            
            // Budget - check all possible r2g coin balance properties
            let budget = 0;
            if (typeof manager.r2g_coin_balance !== 'undefined' && manager.r2g_coin_balance !== null) {
                budget = manager.r2g_coin_balance;
                console.log(`Using r2g_coin_balance: ${budget} for ${manager.club}`);
            } else if (typeof manager.r2gCoinBalance !== 'undefined' && manager.r2gCoinBalance !== null) {
                budget = manager.r2gCoinBalance;
                console.log(`Using r2gCoinBalance: ${budget} for ${manager.club}`);
            } else if (typeof manager.r2g_coins !== 'undefined' && manager.r2g_coins !== null) {
                budget = manager.r2g_coins;
                console.log(`Using r2g_coins: ${budget} for ${manager.club}`);
            } else if (typeof manager.r2gCoins !== 'undefined' && manager.r2gCoins !== null) {
                budget = manager.r2gCoins;
                console.log(`Using r2gCoins: ${budget} for ${manager.club}`);
            } else if (typeof manager.coins !== 'undefined' && manager.coins !== null) {
                budget = manager.coins;
                console.log(`Using coins: ${budget} for ${manager.club}`);
            } else if (typeof manager.budget !== 'undefined' && manager.budget !== null) {
                budget = manager.budget;
                console.log(`Using budget: ${budget} for ${manager.club}`);
            } else if (typeof manager.cash !== 'undefined' && manager.cash !== null) {
                budget = manager.cash;
                console.log(`Using cash: ${budget} for ${manager.club}`);
            } else {
                // Default value if no budget information is available
                budget = 10000;
                console.log(`No budget information found for ${manager.club}, using default: ${budget}`);
            }
            
            squadBudget.textContent = budget.toLocaleString();
        }

        // Populate available players list with filtered data
        function populateAvailablePlayers() {
            const container = document.getElementById('available-players-list');
            container.innerHTML = '';
            
            if (filteredPlayers.length === 0) {
                const noResults = document.createElement('p');
                noResults.textContent = 'No players match your filters';
                noResults.style.textAlign = 'center';
                noResults.style.color = '#888';
                noResults.style.padding = '20px';
                container.appendChild(noResults);
                return;
            }
            
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            
            filteredPlayers.forEach(player => {
                const playerElement = createPlayerElement(player, true);
                fragment.appendChild(playerElement);
            });
            
            container.appendChild(fragment);
        }

        // Create a player element
        function createPlayerElement(player, isAvailable = true) {
            const playerElement = document.createElement('div');
            playerElement.className = 'player-item';
            playerElement.dataset.id = player.id;
            
            const img = document.createElement('img');
            img.className = 'player-thumbnail';
            
            // Use a default image URL that exists in the project
            const defaultImageUrl = 'assets/images/logo11.webp';
            
            // Try to use player image path if available
            if (player.imagePath) {
                img.src = player.imagePath;
            } else {
                img.src = defaultImageUrl;
            }
            
            img.alt = player.name;
            img.loading = 'lazy'; // Lazy load images
            
            // Handle image loading errors
            img.onerror = function() {
                // Don't try to load placeholder.com as it's unreliable
                // Instead, use a local asset we know exists
                this.src = defaultImageUrl;
                // Stop the error cascade
                this.onerror = null;
            };
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'player-info';
            
            const nameSpan = document.createElement('div');
            nameSpan.className = 'player-name';
            nameSpan.textContent = player.name;
            
            const detailsSpan = document.createElement('div');
            detailsSpan.className = 'player-details';
            
            // Extract star rating for display
            let starRating = '';
            if (player.star) {
                const starMatch = player.star.match(/(\d)-star/);
                if (starMatch && starMatch[1]) {
                    starRating = ''.repeat(parseInt(starMatch[1]));
                }
            }
            
            detailsSpan.textContent = `${player.position} | ${starRating} | ${player.club || 'Free Agent'}`;
            
            const valueSpan = document.createElement('span');
            valueSpan.className = 'player-value';
            valueSpan.textContent = player.value;
            
            infoDiv.appendChild(nameSpan);
            infoDiv.appendChild(detailsSpan);
            
            playerElement.appendChild(img);
            playerElement.appendChild(infoDiv);
            playerElement.appendChild(valueSpan);
            
            // Add action button
            const actionBtn = document.createElement('button');
            actionBtn.className = isAvailable ? 'action-btn add-btn' : 'action-btn remove-btn';
            actionBtn.innerHTML = isAvailable ? '<i class="fas fa-plus"></i>' : '<i class="fas fa-minus"></i>';
            actionBtn.title = isAvailable ? 'Add to transfer' : 'Remove from transfer';
            
            actionBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (isAvailable) {
                    addPlayerToTransfer(player);
                } else {
                    removePlayerFromTransfer(player.id);
                }
            });
            
            playerElement.appendChild(actionBtn);
            
            return playerElement;
        }

        // Filter players based on search and filters
        function filterPlayers() {
            const searchTerm = document.getElementById('player-search').value.toLowerCase();
            
            // Get IDs of already selected players to exclude them
            const selectedIds = selectedPlayers.map(p => p.id);
            
            // Get IDs of players already in the selected team's squad
            const teamSquadIds = [];
            if (selectedTeam && selectedTeam.manager && selectedTeam.manager.squad && selectedTeam.manager.squad.players) {
                selectedTeam.manager.squad.players.forEach(squadPlayer => {
                    // Try to find this player in players data
                    const matchingPlayer = playersData.find(p => p.name === squadPlayer.name);
                    if (matchingPlayer) {
                        teamSquadIds.push(matchingPlayer.id);
                    }
                });
            }
            
            filteredPlayers = playersData.filter(player => {
                // Exclude already selected players
                if (selectedIds.includes(player.id)) return false;
                
                // Exclude players already in the team's squad
                if (teamSquadIds.includes(player.id)) return false;
                
                // Apply search term filter
                if (searchTerm && !player.name.toLowerCase().includes(searchTerm)) return false;
                
                return true;
            });
            
            // Sort by value (highest first)
            filteredPlayers.sort((a, b) => {
                // Sort by value (highest first)
                if (b.value !== a.value) {
                    return b.value - a.value;
                }
                // If values are equal, sort alphabetically by name
                return a.name.localeCompare(b.name);
            });
            
            // Update the list
            populateAvailablePlayers();
        }

        // Add player to transfer list
        function addPlayerToTransfer(player) {
            // Check if already added
            if (selectedPlayers.some(p => p.id === player.id)) return;
            
            // Add to selected players
            selectedPlayers.push(player);
            
            // Update UI
            updateSelectedPlayersList();
            
            // Re-filter available players
            filterPlayers();
        }

        // Remove player from transfer list
        function removePlayerFromTransfer(playerId) {
            // Find index of player
            const index = selectedPlayers.findIndex(p => p.id === playerId);
            if (index === -1) return;
            
            // Remove from array
            selectedPlayers.splice(index, 1);
            
            // Update UI
            updateSelectedPlayersList();
            
            // Re-filter available players
            filterPlayers();
        }

        // Update the list of selected players
        function updateSelectedPlayersList() {
            const container = document.getElementById('selected-players-list');
            const transferSettings = document.getElementById('transfer-settings');
            
            // Clear the container
            container.innerHTML = '';
            
            if (selectedPlayers.length === 0) {
                transferSettings.style.display = 'none';
                
                const noPlayers = document.createElement('p');
                noPlayers.textContent = 'No players selected for transfer';
                noPlayers.style.textAlign = 'center';
                noPlayers.style.color = '#888';
                noPlayers.style.padding = '20px';
                container.appendChild(noPlayers);
                return;
            }
            
            // Show transfer settings
            transferSettings.style.display = 'block';
            
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            
            // Add selected players
            selectedPlayers.forEach(player => {
                const playerElement = createPlayerElement(player, false);
                fragment.appendChild(playerElement);
            });
            
            container.appendChild(fragment);
            
            // Update transfer details
            updateTransferDetails();
        }
        
        // Update transfer details
        function updateTransferDetails() {
            const container = document.getElementById('transfer-details');
            container.innerHTML = '';
            
            if (selectedPlayers.length === 0) return;
            
            // Get default contract length
            const defaultContract = parseInt(document.getElementById('default-contract').value) || 2;
            
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            
            selectedPlayers.forEach(player => {
                const transferItem = document.createElement('div');
                transferItem.className = 'transfer-item';
                transferItem.dataset.id = player.id;
                
                // Player name
                const nameHeading = document.createElement('h4');
                nameHeading.style.margin = '0 0 10px 0';
                nameHeading.textContent = player.name;
                
                // Value input
                const valueGroup = document.createElement('div');
                valueGroup.className = 'form-group';
                
                const valueLabel = document.createElement('label');
                valueLabel.textContent = 'Transfer Value:';
                valueLabel.htmlFor = `value-${player.id}`;
                
                const valueInput = document.createElement('input');
                valueInput.type = 'number';
                valueInput.id = `value-${player.id}`;
                valueInput.className = 'transfer-value';
                valueInput.min = '1';
                valueInput.value = player.value;
                valueInput.dataset.id = player.id;
                
                valueInput.addEventListener('input', updatePlayerSalary);
                valueGroup.appendChild(valueLabel);
                valueGroup.appendChild(valueInput);
                
                // Contract input
                const contractGroup = document.createElement('div');
                contractGroup.className = 'form-group';
                
                const contractLabel = document.createElement('label');
                contractLabel.textContent = 'Contract Length (years):';
                contractLabel.htmlFor = `contract-${player.id}`;
                
                const contractInput = document.createElement('input');
                contractInput.type = 'number';
                contractInput.id = `contract-${player.id}`;
                contractInput.className = 'transfer-contract';
                contractInput.min = '1';
                contractInput.max = '5';
                contractInput.value = defaultContract;
                contractInput.dataset.id = player.id;
                
                contractGroup.appendChild(contractLabel);
                contractGroup.appendChild(contractInput);
                
                // Salary calculation (5% of value)
                const salaryGroup = document.createElement('div');
                salaryGroup.className = 'form-group';
                
                const salaryLabel = document.createElement('label');
                salaryLabel.textContent = 'Salary (5% of value):';
                
                const salaryValue = document.createElement('div');
                salaryValue.id = `salary-${player.id}`;
                salaryValue.style.backgroundColor = '#333';
                salaryValue.style.padding = '10px';
                salaryValue.style.borderRadius = '4px';
                salaryValue.style.color = '#bada55';
                salaryValue.style.fontWeight = 'bold';
                salaryValue.textContent = Math.round(player.value * 0.05).toLocaleString();
                
                salaryGroup.appendChild(salaryLabel);
                salaryGroup.appendChild(salaryValue);
                
                // Append all elements
                transferItem.appendChild(nameHeading);
                transferItem.appendChild(valueGroup);
                transferItem.appendChild(contractGroup);
                transferItem.appendChild(salaryGroup);
                
                fragment.appendChild(transferItem);
            });
            
            container.appendChild(fragment);
        }
        
        // Update player salary based on value
        function updatePlayerSalary(event) {
            const value = parseInt(event.target.value) || 0;
            const playerId = event.target.dataset.id;
            const salaryElement = document.getElementById(`salary-${playerId}`);
            
            if (salaryElement) {
                const salary = Math.round(value * 0.05);
                salaryElement.textContent = salary.toLocaleString();
            }
        }
        
        // Update all contracts with default value
        function updateAllContracts() {
            const defaultContract = parseInt(document.getElementById('default-contract').value) || 2;
            const contractInputs = document.querySelectorAll('.transfer-contract');
            
            contractInputs.forEach(input => {
                input.value = defaultContract;
            });
        }

        // Submit transfers
        async function submitTransfers() {
            if (!selectedTeam) {
                showStatusMessage('Please select a team first', false);
                return;
            }
            
            if (selectedPlayers.length === 0) {
                showStatusMessage('No players selected for transfer', false);
                return;
            }
            
            // Show saving indicator
            const submitBtn = document.getElementById('submit-transfers');
            const originalBtnText = submitBtn.textContent;
            submitBtn.textContent = 'Processing...';
            submitBtn.disabled = true;
            
            try {
                // Get the current season range
                const seasonStart = document.getElementById('season-start').value;
                const seasonEnd = document.getElementById('season-end').value;
                const seasonRange = `${seasonStart}-${seasonEnd}`;
                
                // Validate season
                if (!seasonStart || !seasonEnd || parseFloat(seasonStart) >= parseFloat(seasonEnd)) {
                    throw new Error('Invalid season range. End season must be greater than start season.');
                }
                
                // Get the manager to update
                const managerIndex = managersData.findIndex(m => m.club === selectedTeam.name);
                if (managerIndex === -1) {
                    throw new Error('Team manager not found in data');
                }
                
                // Create a deep copy of the manager data to modify
                const manager = JSON.parse(JSON.stringify(managersData[managerIndex]));
                
                // Ensure the manager has a squad and players array
                if (!manager.squad) {
                    manager.squad = { totalPlayers: 0, players: [] };
                }
                if (!manager.squad.players) {
                    manager.squad.players = [];
                }
                
                // Process each transfer
                const updatedPlayers = [];
                let totalTransferSpend = 0;
                let playersAdded = 0;
                
                for (const player of selectedPlayers) {
                    // Get transfer details
                    const valueInput = document.getElementById(`value-${player.id}`);
                    const contractInput = document.getElementById(`contract-${player.id}`);
                    
                    const transferValue = parseInt(valueInput.value) || player.value;
                    const contractYears = parseInt(contractInput.value) || 2;
                    const salary = Math.round(transferValue * 0.05);
                    
                    // Track total spend
                    totalTransferSpend += transferValue;
                    
                    // Create a new player for the squad
                    const squadPlayer = {
                        name: player.name,
                        position: player.position,
                        value: transferValue,
                        contract: contractYears,
                        salary: salary
                    };
                    
                    // Add to squad
                    manager.squad.players.push(squadPlayer);
                    playersAdded++;
                    
                    // Update the player in players.json
                    const playerIndex = playersData.findIndex(p => p.id === player.id);
                    if (playerIndex !== -1) {
                        // Create a deep copy of the player to modify
                        const updatedPlayer = JSON.parse(JSON.stringify(playersData[playerIndex]));
                        
                        // Update club and value
                        updatedPlayer.club = selectedTeam.name;
                        updatedPlayer.value = transferValue;
                        
                        // Add the new season stats entry
                        if (!updatedPlayer.stats) {
                            updatedPlayer.stats = [];
                        }
                        
                        updatedPlayer.stats.push({
                            season: seasonRange,
                            team: selectedTeam.name,
                            value: transferValue.toString(),
                            apps: "00"  // Start with 0 appearances
                        });
                        
                        // Save to updated players array
                        updatedPlayers.push({ index: playerIndex, player: updatedPlayer });
                    }
                }
                
                // Update manager data
                manager.squad.totalPlayers = manager.squad.players.length;
                
                // Update club total value - sum of all player values
                manager.clubTotalValue = manager.squad.players.reduce((total, p) => total + p.value, 0);
                
                // Deduct transfer spending from manager's coins
                if (manager.coins) {
                    manager.coins -= totalTransferSpend;
                    if (manager.coins < 0) manager.coins = 0;
                }
                
                // Update the managers data array
                managersData[managerIndex] = manager;
                
                // Apply player updates
                updatedPlayers.forEach(({ index, player }) => {
                    playersData[index] = player;
                });
                
                // Save changes - first try GitHub if configured
                let savedToPermanentStorage = false;
                
                // Check if GitHub integration is configured
                if (githubConfig && githubConfig.isConfigured()) {
                    try {
                        // Save both files to GitHub
                        await saveToGitHub();
                        savedToPermanentStorage = true;
                    } catch (githubError) {
                        console.error('GitHub save failed:', githubError);
                        // Continue to try server save if GitHub fails
                    }
                } else {
                    console.log('GitHub integration not configured');
                }
                
                // If GitHub failed or not configured, try server
                if (!savedToPermanentStorage) {
                    const serverAvailable = await isServerAvailable();
                    if (serverAvailable) {
                        try {
                            // Save players data
                            const savePlayersResponse = await fetch('http://localhost:3000/save-players', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(playersData)
                            });
                            
                            // Save managers data
                            const saveManagersResponse = await fetch('http://localhost:3000/save-managers', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ managers: managersData })
                            });
                            
                            if (savePlayersResponse.ok && saveManagersResponse.ok) {
                                savedToPermanentStorage = true;
                            } else {
                                throw new Error('Failed to save changes to server');
                            }
                        } catch (serverError) {
                            console.error('Server save failed:', serverError);
                        }
                    }
                }
                
                // Show success message with details
                const successMsg = `Successfully transferred ${playersAdded} player${playersAdded !== 1 ? 's' : ''} to ${selectedTeam.name} for a total of ${totalTransferSpend.toLocaleString()} RC.`;
                showStatusMessage(savedToPermanentStorage ? 
                    successMsg + ' Changes saved to storage.' :
                    successMsg + ' Warning: Changes are only in memory.', savedToPermanentStorage);
                
                // Clear the selected players and refresh the lists
                selectedPlayers = [];
                updateSelectedPlayersList();
                
                // Update squad info display
                updateSquadInfo();
                
                // Re-filter available players
                filterPlayers();
                
            } catch (error) {
                showStatusMessage(`Error: ${error.message}`, false);
                console.error('Error processing transfers:', error);
            } finally {
                // Restore button state
                submitBtn.textContent = originalBtnText;
                submitBtn.disabled = false;
            }
        }

        // Save to GitHub
        async function saveToGitHub() {
            try {
                // Check if GitHub integration is configured
                if (!githubConfig || !githubConfig.isConfigured()) {
                    throw new Error('GitHub integration is not configured');
                }
                
                // Show saving message
                showStatusMessage('Saving to GitHub...', true);
                
                // Save players.json
                await saveFileToGitHub(playersData, 'players.json', 'Update players from transfer system');
                
                // Save manager_data.json - wrap managers array in the correct object structure
                const managersDataFormatted = { managers: managersData };
                await saveFileToGitHub(managersDataFormatted, 'manager_data.json', 'Update managers from transfer system');
                
                showStatusMessage('Changes saved to GitHub! The site will update in a few minutes.', true);
                return true;
                
            } catch (error) {
                showStatusMessage(`GitHub Error: ${error.message}`, false);
                console.error('GitHub save error:', error);
                throw error; // Re-throw to be handled by the caller
            }
        }
        
        // Save a file to GitHub
        async function saveFileToGitHub(data, filePath, commitMessage) {
            try {
                // Check if GitHub integration is configured
                if (!githubConfig || !githubConfig.isConfigured()) {
                    throw new Error('GitHub integration is not configured');
                }
                
                // Get repository details
                const repoDetails = {
                    owner: githubConfig.getOwner(),
                    repo: githubConfig.getRepo(),
                    path: filePath,
                    branch: githubConfig.getBranch()
                };
                
                // Get the current file to get its SHA (required for the GitHub API)
                const fileInfoResponse = await fetch(`https://api.github.com/repos/${repoDetails.owner}/${repoDetails.repo}/contents/${repoDetails.path}?ref=${repoDetails.branch}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.getToken()}`
                    }
                });
                
                let currentSHA = '';
                let fileExists = true;
                
                if (fileInfoResponse.status === 404) {
                    // File doesn't exist yet
                    fileExists = false;
                } else if (!fileInfoResponse.ok) {
                    const errorData = await fileInfoResponse.json();
                    throw new Error(`GitHub API error: ${errorData.message}`);
                } else {
                    // File exists, get its SHA
                    const fileInfo = await fileInfoResponse.json();
                    currentSHA = fileInfo.sha;
                }
                
                // Prepare the content
                const jsonString = JSON.stringify(data, null, 2);
                const content = btoa(unescape(encodeURIComponent(jsonString)));
                
                // Prepare the commit message
                const fullCommitMessage = `${commitMessage} - ${new Date().toISOString()}`;
                
                // Prepare the request body
                const requestBody = {
                    message: fullCommitMessage,
                    content: content,
                    branch: repoDetails.branch
                };
                
                // Add SHA if the file exists
                if (fileExists) {
                    requestBody.sha = currentSHA;
                }
                
                // Commit the updated file
                const commitResponse = await fetch(`https://api.github.com/repos/${repoDetails.owner}/${repoDetails.repo}/contents/${repoDetails.path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!commitResponse.ok) {
                    const errorData = await commitResponse.json();
                    throw new Error(`GitHub API error: ${errorData.message}`);
                }
                
                return true;
                
            } catch (error) {
                console.error(`GitHub save error for ${filePath}:`, error);
                throw error; // Re-throw to be handled by the caller
            }
        }

        // Show status message
        function showStatusMessage(message, isSuccess, duration = 5000) {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.className = 'status-message';
            statusElement.classList.add(isSuccess ? 'status-success' : 'status-error');
            statusElement.style.display = 'block';
            
            // Auto-hide after duration, unless it's an error
            if (isSuccess) {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, duration);
            }
        }

        // Check GitHub configuration status and add UI elements if needed
        function checkGitHubConfigStatus() {
            if (!githubConfig || !githubConfig.isConfigured()) {
                console.log('GitHub integration not configured');
                
                // Add a warning message at the top of the container
                const container = document.querySelector('.container');
                if (container) {
                    const configMessage = document.createElement('div');
                    configMessage.className = 'status-message status-error';
                    configMessage.style.display = 'block';
                    configMessage.style.margin = '0 0 20px 0';
                    configMessage.textContent = 'GitHub integration not configured. Changes will not be saved permanently.';
                    
                    // Add a setup button
                    const setupButton = document.createElement('button');
                    setupButton.textContent = 'Configure GitHub';
                    setupButton.style.marginTop = '5px';
                    setupButton.style.backgroundColor = '#3f51b5';
                    setupButton.style.color = 'white';
                    setupButton.style.border = 'none';
                    setupButton.style.padding = '8px 12px';
                    setupButton.style.borderRadius = '4px';
                    setupButton.style.cursor = 'pointer';
                    
                    setupButton.addEventListener('click', () => {
                        window.location.href = 'token-setup.html';
                    });
                    
                    configMessage.appendChild(setupButton);
                    
                    // Insert at the top of container
                    container.insertBefore(configMessage, container.firstChild);
                }
                
                return false;
            }
            
            return true;
        }

        // Check for inconsistencies between manager data and players data
        function checkDataConsistency() {
            try {
                console.log('Checking data consistency between manager data and players data...');
                
                if (!managersData || !playersData) {
                    throw new Error('Data not loaded yet');
                }
                
                const results = {
                    playersInManagerButNotInPlayers: [],
                    playersWithWrongClub: [],
                    playersWithMissingStats: []
                };
                
                // Get all players in manager data
                const managerSquadPlayers = [];
                managersData.forEach(manager => {
                    if (manager.squad && manager.squad.players) {
                        manager.squad.players.forEach(squadPlayer => {
                            managerSquadPlayers.push({
                                name: squadPlayer.name,
                                club: manager.club,
                                value: squadPlayer.value,
                                position: squadPlayer.position,
                                manager: manager.name
                            });
                        });
                    }
                });
                
                console.log(`Found ${managerSquadPlayers.length} players in manager squad data`);
                
                // Check each player in manager data
                managerSquadPlayers.forEach(squadPlayer => {
                    // Look for this player in players data
                    const playerData = playersData.find(p => p.name === squadPlayer.name);
                    
                    // Player exists in manager data but not in players data
                    if (!playerData) {
                        results.playersInManagerButNotInPlayers.push(squadPlayer);
                        return;
                    }
                    
                    // Player exists in both but club doesn't match
                    if (playerData.club !== squadPlayer.club) {
                        results.playersWithWrongClub.push({
                            name: squadPlayer.name,
                            managerClub: squadPlayer.club,
                            playerDataClub: playerData.club || 'None',
                            manager: squadPlayer.manager,
                            value: squadPlayer.value  // Include the value from manager data
                        });
                    }
                    
                    // Check if player has stats for their current club
                    if (playerData.stats && Array.isArray(playerData.stats)) {
                        const hasStatsForCurrentClub = playerData.stats.some(stat => stat.team === squadPlayer.club);
                        if (!hasStatsForCurrentClub) {
                            results.playersWithMissingStats.push({
                                name: squadPlayer.name,
                                club: squadPlayer.club,
                                stats: playerData.stats,
                                manager: squadPlayer.manager,
                                value: squadPlayer.value  // Include the value from manager data
                            });
                        }
                    } else if (squadPlayer.club) {
                        // Player has no stats at all
                        results.playersWithMissingStats.push({
                            name: squadPlayer.name,
                            club: squadPlayer.club,
                            stats: [],
                            manager: squadPlayer.manager,
                            value: squadPlayer.value  // Include the value from manager data
                        });
                    }
                });
                
                // Show the results
                console.log('Data consistency check results:', results);
                
                // Create a formatted message
                let message = '<strong>Data Consistency Check Results:</strong><br>';
                
                if (results.playersInManagerButNotInPlayers.length > 0) {
                    message += `<br>Players in manager data but missing from players.json: ${results.playersInManagerButNotInPlayers.length}<br>`;
                    results.playersInManagerButNotInPlayers.slice(0, 5).forEach(p => {
                        message += `- ${p.name} (${p.club})<br>`;
                    });
                    if (results.playersInManagerButNotInPlayers.length > 5) {
                        message += `... and ${results.playersInManagerButNotInPlayers.length - 5} more<br>`;
                    }
                }
                
                if (results.playersWithWrongClub.length > 0) {
                    message += `<br>Players with mismatched club data: ${results.playersWithWrongClub.length}<br>`;
                    results.playersWithWrongClub.slice(0, 5).forEach(p => {
                        message += `- ${p.name}: Manager shows ${p.managerClub}, players.json shows ${p.playerDataClub}<br>`;
                    });
                    if (results.playersWithWrongClub.length > 5) {
                        message += `... and ${results.playersWithWrongClub.length - 5} more<br>`;
                    }
                }
                
                if (results.playersWithMissingStats.length > 0) {
                    message += `<br>Players missing stats for current club: ${results.playersWithMissingStats.length}<br>`;
                    results.playersWithMissingStats.slice(0, 5).forEach(p => {
                        message += `- ${p.name} (${p.club})<br>`;
                    });
                    if (results.playersWithMissingStats.length > 5) {
                        message += `... and ${results.playersWithMissingStats.length - 5} more<br>`;
                    }
                }
                
                if (results.playersInManagerButNotInPlayers.length === 0 &&
                    results.playersWithWrongClub.length === 0 &&
                    results.playersWithMissingStats.length === 0) {
                    message += '<br>No inconsistencies found. Data is in sync!';
                } else {
                    // Add fix button if issues were found
                    message += '<br><button id="fix-data-btn" style="background-color: #4ecca3; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-top: 10px;">Fix Data Issues</button>';
                }
                
                // Create a modal or popup to display the results
                const resultsContainer = document.createElement('div');
                resultsContainer.style.position = 'fixed';
                resultsContainer.style.top = '10%';
                resultsContainer.style.left = '50%';
                resultsContainer.style.transform = 'translateX(-50%)';
                resultsContainer.style.backgroundColor = '#252525';
                resultsContainer.style.padding = '20px';
                resultsContainer.style.borderRadius = '8px';
                resultsContainer.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.5)';
                resultsContainer.style.zIndex = '1000';
                resultsContainer.style.maxHeight = '80vh';
                resultsContainer.style.overflow = 'auto';
                resultsContainer.style.maxWidth = '90%';
                resultsContainer.style.width = '600px';
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'Close';
                closeBtn.style.position = 'absolute';
                closeBtn.style.top = '10px';
                closeBtn.style.right = '10px';
                closeBtn.style.backgroundColor = '#e53935';
                closeBtn.style.color = 'white';
                closeBtn.style.border = 'none';
                closeBtn.style.borderRadius = '4px';
                closeBtn.style.cursor = 'pointer';
                closeBtn.style.padding = '5px 10px';
                
                closeBtn.addEventListener('click', () => {
                    resultsContainer.remove();
                });
                
                const contentDiv = document.createElement('div');
                contentDiv.style.marginTop = '20px';
                contentDiv.innerHTML = message;
                
                resultsContainer.appendChild(closeBtn);
                resultsContainer.appendChild(contentDiv);
                document.body.appendChild(resultsContainer);
                
                // Add event listener for fix button if it exists
                setTimeout(() => {
                    const fixButton = document.getElementById('fix-data-btn');
                    if (fixButton) {
                        fixButton.addEventListener('click', () => {
                            fixDataInconsistencies(results);
                            // Close the modal
                            resultsContainer.remove();
                        });
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error checking data consistency:', error);
                showStatusMessage(`Error checking data: ${error.message}`, false);
            }
        }
        
        // Fix data inconsistencies
        async function fixDataInconsistencies(results) {
            try {
                console.log('Fixing data inconsistencies...');
                showStatusMessage('Fixing data inconsistencies...', true);
                
                let fixedCount = 0;
                
                // Fix players with wrong club
                results.playersWithWrongClub.forEach(player => {
                    const playerIndex = playersData.findIndex(p => p.name === player.name);
                    if (playerIndex !== -1) {
                        playersData[playerIndex].club = player.managerClub;
                        
                        // Also update the player value to match the squad value
                        if (typeof player.value !== 'undefined') {
                            console.log(`Updating ${player.name} value from ${playersData[playerIndex].value} to ${player.value} (from manager data)`);
                            playersData[playerIndex].value = player.value;
                        }
                        
                        fixedCount++;
                    }
                });
                
                // Fix players missing stats for current club
                const seasonStart = document.getElementById('season-start').value || "6";
                const seasonEnd = document.getElementById('season-end').value || "8";
                const seasonRange = `${seasonStart}-${seasonEnd}`;
                
                results.playersWithMissingStats.forEach(player => {
                    const playerIndex = playersData.findIndex(p => p.name === player.name);
                    if (playerIndex !== -1) {
                        if (!playersData[playerIndex].stats) {
                            playersData[playerIndex].stats = [];
                        }
                        
                        // Update the player value to match the squad value from manager data
                        if (typeof player.value !== 'undefined') {
                            console.log(`Updating ${player.name} value from ${playersData[playerIndex].value} to ${player.value} (from manager data)`);
                            playersData[playerIndex].value = player.value;
                        }
                        
                        // Add missing stats with the correct value from manager data
                        const newStat = {
                            season: seasonRange,
                            team: player.club,
                            value: typeof player.value !== 'undefined' ? player.value.toString() : 
                                  (playersData[playerIndex].value?.toString() || "1000"),
                            apps: "00"
                        };
                        
                        playersData[playerIndex].stats.push(newStat);
                        fixedCount++;
                    }
                });
                
                // 3. Save changes
                let saved = false;
                
                // Try GitHub first
                if (githubConfig && githubConfig.isConfigured()) {
                    try {
                        // Only save players.json as we're fixing inconsistencies
                        await saveFileToGitHub(playersData, 'players.json', 'Fix player data inconsistencies');
                        saved = true;
                    } catch (error) {
                        console.error('Failed to save to GitHub:', error);
                    }
                }
                
                // Try server if GitHub failed
                if (!saved) {
                    const serverAvailable = await isServerAvailable();
                    if (serverAvailable) {
                        const saveResponse = await fetch('http://localhost:3000/save-players', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(playersData)
                        });
                        
                        if (saveResponse.ok) {
                            saved = true;
                        } else {
                            throw new Error('Failed to save to server');
                        }
                    }
                }
                
                // Show results
                if (saved) {
                    showStatusMessage(`Fixed ${fixedCount} data inconsistencies and saved changes successfully.`, true);
                } else {
                    showStatusMessage(`Fixed ${fixedCount} data inconsistencies but couldn't save changes permanently.`, false);
                }
                
            } catch (error) {
                console.error('Error fixing data inconsistencies:', error);
                showStatusMessage(`Error fixing data: ${error.message}`, false);
            }
        }
    </script>
    
    <!-- Performance optimization JS -->
    <script>
        // Immediately executed critical JS
        document.addEventListener('DOMContentLoaded', function() {
            // Add loading indicator for mobile
            if (window.innerWidth <= 768) {
                // Add loading class to body
                document.body.classList.add('mobile-loading');
                
                // Create loading indicator
                const loadingEl = document.createElement('div');
                loadingEl.className = 'mobile-loading-indicator';
                loadingEl.innerHTML = '<div class="loading-spinner"></div><div class="loading-text">Loading players...</div>';
                document.body.appendChild(loadingEl);
                
                // Remove loading after a short delay (or when data is actually loaded)
                setTimeout(() => {
                    document.body.classList.remove('mobile-loading');
                    loadingEl.style.opacity = '0';
                    setTimeout(() => {
                        loadingEl.remove();
                    }, 300);
                }, 1500);
                
                // Show mobile quick navigation
                const quickNav = document.getElementById('mobile-quick-nav');
                if (quickNav) {
                    quickNav.style.display = 'flex';
                    
                    // Add event listeners to quick nav buttons
                    const quickNavButtons = quickNav.querySelectorAll('.quick-nav-btn');
                    quickNavButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            const targetId = this.getAttribute('data-target');
                            const targetElement = document.getElementById(targetId) || document.querySelector('.' + targetId);
                            
                            if (targetElement) {
                                // Add some additional offset for better scrolling
                                const yOffset = -20; 
                                const y = targetElement.getBoundingClientRect().top + window.pageYOffset + yOffset;
                                
                                window.scrollTo({
                                    top: y,
                                    behavior: 'smooth'
                                });
                                
                                // Add visual feedback for the selected button
                                quickNavButtons.forEach(btn => btn.style.backgroundColor = '#252525');
                                this.style.backgroundColor = '#4ecca3';
                                this.style.color = '#121212';
                                
                                // Reset after a short delay
                                setTimeout(() => {
                                    this.style.backgroundColor = '#252525';
                                    this.style.color = '#e0e0e0';
                                }, 500);
                            }
                        });
                    });
                }
            }
            
            // Focus on team selector
            setTimeout(() => {
                const teamSelector = document.getElementById('team-selector');
                if (teamSelector) {
                    teamSelector.focus();
                }
            }, 500);
        });
    </script>

    <div class="nav-links">
        <a href="token-setup.html"><i class="fas fa-key"></i> GitHub Token Setup</a>
        <a href="transfer-debug.html"><i class="fas fa-bug"></i> Debug Saving</a>
    </div>
</body>
</html> 