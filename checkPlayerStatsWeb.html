<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Stats Checker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #121212;
            color: #e0e0e0;
        }
        .container {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-left: 4px solid #4ecca3;
        }
        h1 {
            color: #4ecca3;
            margin-top: 0;
        }
        button {
            background-color: #4ecca3;
            color: #121212;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #3db893;
        }
        .loading {
            display: none;
            margin-top: 20px;
            color: #4ecca3;
        }
        .stats {
            margin-top: 15px;
            padding: 10px;
            background-color: #252525;
            border-radius: 4px;
        }
        .results-container {
            display: none;
            margin-top: 20px;
        }
        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        .tab-button {
            background-color: #333;
            color: #e0e0e0;
            border: none;
            padding: 8px 15px;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #4ecca3;
            color: #121212;
        }
        .tab-content {
            background-color: #252525;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .count-badge {
            display: inline-block;
            background-color: #ff5722;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 5px;
            font-weight: bold;
        }
        .tabs {
            display: none;
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Player Stats Checker</h1>
        <p>This tool checks players.json for mistakes and inconsistencies in player stats.</p>
        
        <button id="checkStats">Check Player Stats</button>
        <button id="downloadResults" disabled>Download Results</button>
        
        <div id="loading" class="loading">Analyzing players.json... This may take a moment.</div>
        
        <div id="stats" class="stats" style="display: none;">
            <h3>Issues Found:</h3>
            <div id="summaryStats"></div>
        </div>
        
        <div id="resultsContainer" class="results-container">
            <div id="tabs" class="tabs">
                <div class="tab-buttons" id="tabButtons"></div>
                <div class="tab-content" id="tabContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Get DOM elements
        const checkStatsBtn = document.getElementById('checkStats');
        const downloadBtn = document.getElementById('downloadResults');
        const loadingDiv = document.getElementById('loading');
        const statsDiv = document.getElementById('stats');
        const summaryStatsDiv = document.getElementById('summaryStats');
        const resultsContainer = document.getElementById('resultsContainer');
        const tabsDiv = document.getElementById('tabs');
        const tabButtons = document.getElementById('tabButtons');
        const tabContent = document.getElementById('tabContent');
        
        // Store results for download
        let resultsText = '';
        let issueCategories = {};
        
        // Issue type descriptions
        const issueTypes = {
            missingStats: 'Players missing stats array',
            emptyStats: 'Players with empty stats',
            invalidSeasonFormat: 'Invalid season format',
            seasonEndBeforeStart: 'Season end before or equal to start',
            teamMismatches: 'Team mismatches',
            duplicateStats: 'Duplicate season entries',
            invalidValues: 'Invalid value entries',
            missingFields: 'Missing required fields'
        };
        
        // Add event listeners
        checkStatsBtn.addEventListener('click', checkPlayerStats);
        downloadBtn.addEventListener('click', downloadResults);
        
        // Function to check player stats
        async function checkPlayerStats() {
            // Reset UI
            loadingDiv.style.display = 'block';
            statsDiv.style.display = 'none';
            resultsContainer.style.display = 'none';
            tabsDiv.style.display = 'none';
            tabButtons.innerHTML = '';
            tabContent.innerHTML = '';
            downloadBtn.disabled = true;
            
            try {
                // Fetch players.json
                const response = await fetch('players.json');
                const playersData = await response.json();
                
                // Arrays to store different types of issues
                const issues = {
                    missingStats: [],
                    emptyStats: [],
                    invalidSeasonFormat: [],
                    seasonEndBeforeStart: [],
                    teamMismatches: [],
                    duplicateStats: [],
                    invalidValues: [],
                    missingFields: []
                };
                
                // Loop through all players
                playersData.forEach(player => {
                    const playerIdentifier = `${player.name} (ID: ${player.id})`;
                    
                    // Check if player has stats
                    if (!player.stats || !Array.isArray(player.stats)) {
                        issues.missingStats.push(playerIdentifier);
                        return;
                    }
                    
                    // Check if stats array is empty but should have stats
                    if (player.stats.length === 0) {
                        issues.emptyStats.push(playerIdentifier);
                        return;
                    }
                    
                    // Check current club matches latest stat
                    if (player.club && player.club !== 'FREE AGENT' && player.club !== 'FREE AGENTP') {
                        // Sort stats by season end date to find the latest
                        const sortedStats = [...player.stats].sort((a, b) => {
                            if (!a.season || !b.season) return 0;
                            const aEnd = parseFloat(a.season.split('-')[1] || 0);
                            const bEnd = parseFloat(b.season.split('-')[1] || 0);
                            return bEnd - aEnd;
                        });
                        
                        // Check if latest team matches current club
                        if (sortedStats[0] && sortedStats[0].team && sortedStats[0].team !== player.club) {
                            issues.teamMismatches.push({
                                player: playerIdentifier,
                                club: player.club,
                                latestTeam: sortedStats[0].team,
                                latestSeason: sortedStats[0].season
                            });
                        }
                    }
                    
                    // Set to track duplicate seasons
                    const seasonSet = new Set();
                    
                    // Check each stat entry
                    player.stats.forEach(stat => {
                        // Check for missing required fields
                        if (!stat.team || !stat.season) {
                            issues.missingFields.push({
                                player: playerIdentifier,
                                missing: !stat.team ? 'team' : 'season',
                                stat: JSON.stringify(stat)
                            });
                            return;
                        }
                        
                        // Check season format (should be x-y where x and y are numbers)
                        const seasonRegex = /^\d+(\.\d+)?-\d+(\.\d+)?$/;
                        if (!seasonRegex.test(stat.season)) {
                            issues.invalidSeasonFormat.push({
                                player: playerIdentifier,
                                invalidSeason: stat.season
                            });
                        } else {
                            // Check if start season is greater than end season
                            const [startSeason, endSeason] = stat.season.split('-').map(Number);
                            if (startSeason >= endSeason) {
                                issues.seasonEndBeforeStart.push({
                                    player: playerIdentifier,
                                    season: stat.season,
                                    startSeason,
                                    endSeason
                                });
                            }
                            
                            // Check for duplicate seasons
                            if (seasonSet.has(stat.season)) {
                                issues.duplicateStats.push({
                                    player: playerIdentifier,
                                    season: stat.season,
                                    team: stat.team
                                });
                            } else {
                                seasonSet.add(stat.season);
                            }
                        }
                        
                        // Check if value is valid (should be a number or string representing a number)
                        if (stat.value) {
                            const numValue = parseFloat(stat.value);
                            if (isNaN(numValue)) {
                                issues.invalidValues.push({
                                    player: playerIdentifier,
                                    season: stat.season,
                                    team: stat.team,
                                    value: stat.value
                                });
                            }
                        }
                    });
                    
                    // Check for overlapping seasons
                    const seasons = player.stats
                        .filter(stat => stat.season && stat.season.includes('-'))
                        .map(stat => {
                            const [start, end] = stat.season.split('-').map(Number);
                            return { 
                                start, 
                                end, 
                                season: stat.season,
                                team: stat.team 
                            };
                        });
                    
                    // Sort seasons by start date
                    seasons.sort((a, b) => a.start - b.start);
                    
                    // Check for overlapping seasons
                    const overlappingSeasons = [];
                    for (let i = 0; i < seasons.length - 1; i++) {
                        for (let j = i + 1; j < seasons.length; j++) {
                            // Check if seasons overlap
                            if (seasons[i].end > seasons[j].start) {
                                overlappingSeasons.push({
                                    player: playerIdentifier,
                                    season1: `${seasons[i].season} (${seasons[i].team})`,
                                    season2: `${seasons[j].season} (${seasons[j].team})`
                                });
                            }
                        }
                    }
                    
                    // Add overlapping seasons to team mismatches if not already there
                    if (overlappingSeasons.length > 0) {
                        // Check if player already has a team mismatch
                        const hasTeamMismatch = issues.teamMismatches.some(m => m.player === playerIdentifier);
                        
                        if (!hasTeamMismatch) {
                            overlappingSeasons.forEach(overlap => {
                                issues.teamMismatches.push({
                                    player: playerIdentifier,
                                    issue: 'Overlapping seasons',
                                    details: `${overlap.season1} overlaps with ${overlap.season2}`
                                });
                            });
                        }
                    }
                });
                
                // Format results for output
                resultsText = formatResultsText(issues);
                issueCategories = issues;
                
                // Display results on page
                displayResults(issues);
                
                // Enable download button
                downloadBtn.disabled = false;
                
            } catch (error) {
                console.error('Error processing players.json:', error);
                tabContent.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }
        
        // Function to format results text for download
        function formatResultsText(issues) {
            let text = `==== PLAYER STATS ISSUES REPORT ====\n\n`;
            
            // Summary of issues found
            text += `SUMMARY OF ISSUES FOUND:\n`;
            for (const [type, list] of Object.entries(issues)) {
                text += `- ${issueTypes[type]}: ${list.length}\n`;
            }
            text += `\n`;
            
            // Add details for each issue type
            for (const [type, list] of Object.entries(issues)) {
                if (list.length > 0) {
                    text += `\n==== ${issueTypes[type].toUpperCase()} ====\n`;
                    
                    if (type === 'missingStats' || type === 'emptyStats') {
                        list.forEach(player => {
                            text += `- ${player}\n`;
                        });
                    } else if (type === 'invalidSeasonFormat') {
                        list.forEach(issue => {
                            text += `- ${issue.player}: Invalid season format "${issue.invalidSeason}"\n`;
                        });
                    } else if (type === 'seasonEndBeforeStart') {
                        list.forEach(issue => {
                            text += `- ${issue.player}: Season ${issue.season} has start (${issue.startSeason}) >= end (${issue.endSeason})\n`;
                        });
                    } else if (type === 'teamMismatches') {
                        list.forEach(issue => {
                            if (issue.issue) {
                                text += `- ${issue.player}: ${issue.issue} - ${issue.details}\n`;
                            } else {
                                text += `- ${issue.player}: Current club "${issue.club}" doesn't match latest team in stats "${issue.latestTeam}" (Season ${issue.latestSeason})\n`;
                            }
                        });
                    } else if (type === 'duplicateStats') {
                        list.forEach(issue => {
                            text += `- ${issue.player}: Duplicate season "${issue.season}" for team "${issue.team}"\n`;
                        });
                    } else if (type === 'invalidValues') {
                        list.forEach(issue => {
                            text += `- ${issue.player}: Season ${issue.season}, Team ${issue.team} has invalid value "${issue.value}"\n`;
                        });
                    } else if (type === 'missingFields') {
                        list.forEach(issue => {
                            text += `- ${issue.player}: Missing ${issue.missing} in stat entry ${issue.stat}\n`;
                        });
                    }
                }
            }
            
            return text;
        }
        
        // Function to display results on the page
        function displayResults(issues) {
            // Show results container
            resultsContainer.style.display = 'block';
            
            // Update summary stats
            let summaryHTML = '<ul>';
            for (const [type, list] of Object.entries(issues)) {
                summaryHTML += `<li>${issueTypes[type]}: <strong>${list.length}</strong></li>`;
            }
            summaryHTML += '</ul>';
            summaryStatsDiv.innerHTML = summaryHTML;
            statsDiv.style.display = 'block';
            
            // Create tabs for each issue type
            let hasIssues = false;
            for (const [type, list] of Object.entries(issues)) {
                if (list.length > 0) {
                    hasIssues = true;
                    
                    // Create tab button
                    const button = document.createElement('button');
                    button.className = 'tab-button';
                    button.dataset.tab = type;
                    button.innerHTML = `${issueTypes[type]} <span class="count-badge">${list.length}</span>`;
                    button.addEventListener('click', () => switchTab(type));
                    tabButtons.appendChild(button);
                    
                    // Create tab panel
                    const panel = document.createElement('div');
                    panel.className = 'tab-panel';
                    panel.id = `tab-${type}`;
                    
                    // Add content to panel
                    let panelHTML = '';
                    
                    if (type === 'missingStats' || type === 'emptyStats') {
                        list.forEach(player => {
                            panelHTML += `<div>- ${player}</div>`;
                        });
                    } else if (type === 'invalidSeasonFormat') {
                        list.forEach(issue => {
                            panelHTML += `<div>- ${issue.player}: Invalid season format "${issue.invalidSeason}"</div>`;
                        });
                    } else if (type === 'seasonEndBeforeStart') {
                        list.forEach(issue => {
                            panelHTML += `<div>- ${issue.player}: Season ${issue.season} has start (${issue.startSeason}) >= end (${issue.endSeason})</div>`;
                        });
                    } else if (type === 'teamMismatches') {
                        list.forEach(issue => {
                            if (issue.issue) {
                                panelHTML += `<div>- ${issue.player}: ${issue.issue} - ${issue.details}</div>`;
                            } else {
                                panelHTML += `<div>- ${issue.player}: Current club "${issue.club}" doesn't match latest team in stats "${issue.latestTeam}" (Season ${issue.latestSeason})</div>`;
                            }
                        });
                    } else if (type === 'duplicateStats') {
                        list.forEach(issue => {
                            panelHTML += `<div>- ${issue.player}: Duplicate season "${issue.season}" for team "${issue.team}"</div>`;
                        });
                    } else if (type === 'invalidValues') {
                        list.forEach(issue => {
                            panelHTML += `<div>- ${issue.player}: Season ${issue.season}, Team ${issue.team} has invalid value "${issue.value}"</div>`;
                        });
                    } else if (type === 'missingFields') {
                        list.forEach(issue => {
                            panelHTML += `<div>- ${issue.player}: Missing ${issue.missing} in stat entry ${issue.stat}</div>`;
                        });
                    }
                    
                    panel.innerHTML = panelHTML;
                    tabContent.appendChild(panel);
                }
            }
            
            if (hasIssues) {
                tabsDiv.style.display = 'block';
                // Activate first tab
                const firstTab = tabButtons.querySelector('.tab-button');
                if (firstTab) {
                    firstTab.click();
                }
            } else {
                tabContent.innerHTML = '<div>No issues found in player stats!</div>';
                tabsDiv.style.display = 'block';
            }
        }
        
        // Function to switch tabs
        function switchTab(tabId) {
            // Update active button
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
            
            // Update active panel
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            const activePanel = document.getElementById(`tab-${tabId}`);
            if (activePanel) {
                activePanel.classList.add('active');
            }
        }
        
        // Function to download results
        function downloadResults() {
            const blob = new Blob([resultsText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'player_stats_issues.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html> 