<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duplicate Players Checker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #121212;
            color: #e0e0e0;
        }
        .container {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-left: 4px solid #4ecca3;
        }
        h1 {
            color: #4ecca3;
            margin-top: 0;
        }
        button {
            background-color: #4ecca3;
            color: #121212;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #3db893;
        }
        .loading {
            display: none;
            margin-top: 20px;
            color: #4ecca3;
        }
        .stats {
            margin-top: 15px;
            padding: 10px;
            background-color: #252525;
            border-radius: 4px;
        }
        .results-container {
            display: none;
            margin-top: 20px;
        }
        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        .tab-button {
            background-color: #333;
            color: #e0e0e0;
            border: none;
            padding: 8px 15px;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #4ecca3;
            color: #121212;
        }
        .tab-content {
            background-color: #252525;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .count-badge {
            display: inline-block;
            background-color: #ff5722;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 5px;
            font-weight: bold;
        }
        .tabs {
            display: none;
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
        .player-details {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #4ecca3;
            background-color: #2a2a2a;
        }
        .player-name {
            font-weight: bold;
            color: #4ecca3;
        }
        .duplicate-entry {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #393939;
        }
        .settings {
            margin-top: 20px;
            padding: 15px;
            background-color: #252525;
            border-radius: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Duplicate Players Checker</h1>
        <p>This tool checks players.json for duplicate players based on various criteria.</p>
        
        <div class="settings">
            <div class="checkbox-option">
                <input type="checkbox" id="checkExactNames" checked>
                <label for="checkExactNames">Check exact name duplicates</label>
            </div>
            <div class="checkbox-option">
                <input type="checkbox" id="checkDifferentIds" checked>
                <label for="checkDifferentIds">Check same name with different IDs</label>
            </div>
            <div class="checkbox-option">
                <input type="checkbox" id="checkSimilarNames" checked>
                <label for="checkSimilarNames">Check similar names (potential misspellings)</label>
            </div>
            <div class="checkbox-option">
                <input type="checkbox" id="checkNamePositions" checked>
                <label for="checkNamePositions">Check same name and position</label>
            </div>
        </div>
        
        <button id="checkDuplicates">Check Duplicate Players</button>
        <button id="downloadResults" disabled>Download Results</button>
        
        <div id="loading" class="loading">Analyzing players.json... This may take a moment.</div>
        
        <div id="stats" class="stats" style="display: none;">
            <h3>Duplicates Found:</h3>
            <div id="summaryStats"></div>
        </div>
        
        <div id="resultsContainer" class="results-container">
            <div id="tabs" class="tabs">
                <div class="tab-buttons" id="tabButtons"></div>
                <div class="tab-content" id="tabContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Get DOM elements
        const checkDuplicatesBtn = document.getElementById('checkDuplicates');
        const downloadBtn = document.getElementById('downloadResults');
        const loadingDiv = document.getElementById('loading');
        const statsDiv = document.getElementById('stats');
        const summaryStatsDiv = document.getElementById('summaryStats');
        const resultsContainer = document.getElementById('resultsContainer');
        const tabsDiv = document.getElementById('tabs');
        const tabButtons = document.getElementById('tabButtons');
        const tabContent = document.getElementById('tabContent');
        
        // Settings checkboxes
        const checkExactNames = document.getElementById('checkExactNames');
        const checkDifferentIds = document.getElementById('checkDifferentIds');
        const checkSimilarNames = document.getElementById('checkSimilarNames');
        const checkNamePositions = document.getElementById('checkNamePositions');
        
        // Store results for download
        let resultsText = '';
        let duplicateCategories = {};
        
        // Duplicate type descriptions
        const duplicateTypes = {
            exactNameDuplicates: 'Exact name duplicates',
            exactNameDifferentIdDuplicates: 'Same name with different IDs',
            similarNameDuplicates: 'Similar name duplicates (potential misspellings)',
            sameNamePositionDuplicates: 'Same name and position duplicates'
        };
        
        // Add event listeners
        checkDuplicatesBtn.addEventListener('click', checkDuplicatePlayers);
        downloadBtn.addEventListener('click', downloadResults);
        
        // Function to normalize names for comparison
        function normalizeName(name) {
            return name.trim().toLowerCase()
                .replace(/\s+/g, ' ')           // Replace multiple spaces with single space
                .replace(/\./g, '')             // Remove periods
                .replace(/[^\w\s]/g, '');       // Remove other special characters
        }
        
        // Function to check if names are similar (potential misspellings)
        function areSimilarNames(name1, name2) {
            // Simple similarity check - at least 80% of characters match
            const normalizedName1 = normalizeName(name1);
            const normalizedName2 = normalizeName(name2);
            
            // Skip short names as they can lead to false positives
            if (normalizedName1.length < 5 || normalizedName2.length < 5) {
                return false;
            }
            
            // Count matching characters
            let matchCount = 0;
            const len1 = normalizedName1.length;
            const len2 = normalizedName2.length;
            const maxLength = Math.max(len1, len2);
            const minLength = Math.min(len1, len2);
            
            // If length difference is too big, not similar
            if (maxLength > minLength * 1.5) {
                return false;
            }
            
            // Check first 3 characters - if they don't match, likely not the same player
            if (normalizedName1.substring(0, 3) !== normalizedName2.substring(0, 3)) {
                return false;
            }
            
            // Compare each character
            for (let i = 0; i < minLength; i++) {
                if (normalizedName1[i] === normalizedName2[i]) {
                    matchCount++;
                }
            }
            
            const similarity = matchCount / maxLength;
            return similarity > 0.8; // 80% similarity threshold
        }
        
        // Function to check for duplicate players
        async function checkDuplicatePlayers() {
            // Reset UI
            loadingDiv.style.display = 'block';
            statsDiv.style.display = 'none';
            resultsContainer.style.display = 'none';
            tabsDiv.style.display = 'none';
            tabButtons.innerHTML = '';
            tabContent.innerHTML = '';
            downloadBtn.disabled = true;
            
            try {
                // Fetch players.json
                const response = await fetch('players.json');
                const playersData = await response.json();
                
                // Arrays to store different types of duplicates
                const duplicates = {
                    exactNameDuplicates: [],
                    exactNameDifferentIdDuplicates: [],
                    similarNameDuplicates: [],
                    sameNamePositionDuplicates: []
                };
                
                // Maps to track player names and IDs
                const nameMap = new Map();
                const idMap = new Map();
                const namePositionMap = new Map();
                const duplicateIds = new Set();
                
                // Process each player
                playersData.forEach(player => {
                    if (!player.name || !player.id) {
                        return; // Skip players without name or ID
                    }
                    
                    const playerIdentifier = `${player.name} (ID: ${player.id})`;
                    const originalName = player.name;
                    const normalizedName = normalizeName(originalName);
                    const namePositionKey = `${normalizedName}-${player.position || 'unknown'}`;
                    
                    // Check for exact name duplicates
                    if (checkExactNames.checked && nameMap.has(originalName)) {
                        duplicates.exactNameDuplicates.push({
                            name: originalName,
                            players: [
                                { 
                                    id: nameMap.get(originalName).id, 
                                    details: nameMap.get(originalName).details,
                                    club: nameMap.get(originalName).club,
                                    position: nameMap.get(originalName).position
                                },
                                { 
                                    id: player.id, 
                                    details: playerIdentifier,
                                    club: player.club,
                                    position: player.position
                                }
                            ]
                        });
                    } else {
                        nameMap.set(originalName, { 
                            id: player.id, 
                            details: playerIdentifier,
                            club: player.club,
                            position: player.position
                        });
                    }
                    
                    // Check for same name, different ID
                    if (checkDifferentIds.checked && nameMap.has(originalName) && nameMap.get(originalName).id !== player.id) {
                        duplicates.exactNameDifferentIdDuplicates.push({
                            name: originalName,
                            players: [
                                { 
                                    id: nameMap.get(originalName).id, 
                                    details: nameMap.get(originalName).details,
                                    club: nameMap.get(originalName).club,
                                    position: nameMap.get(originalName).position
                                },
                                { 
                                    id: player.id, 
                                    details: playerIdentifier,
                                    club: player.club,
                                    position: player.position
                                }
                            ]
                        });
                    }
                    
                    // Check for duplicate IDs
                    if (idMap.has(player.id)) {
                        // This is a severe error - IDs should be unique
                        console.error(`DUPLICATE ID FOUND: ${player.id} used by "${idMap.get(player.id)}" and "${originalName}"`);
                        duplicateIds.add(player.id);
                    } else {
                        idMap.set(player.id, originalName);
                    }
                    
                    // Check for same name and position
                    if (checkNamePositions.checked && namePositionMap.has(namePositionKey)) {
                        duplicates.sameNamePositionDuplicates.push({
                            name: originalName,
                            position: player.position || 'unknown',
                            players: [
                                { 
                                    id: namePositionMap.get(namePositionKey).id, 
                                    details: namePositionMap.get(namePositionKey).details,
                                    club: namePositionMap.get(namePositionKey).club
                                },
                                { 
                                    id: player.id, 
                                    details: playerIdentifier,
                                    club: player.club
                                }
                            ]
                        });
                    } else {
                        namePositionMap.set(namePositionKey, { 
                            id: player.id, 
                            details: playerIdentifier,
                            club: player.club
                        });
                    }
                });
                
                // Check for similar names (potential duplicates with misspellings)
                if (checkSimilarNames.checked) {
                    const processedPairs = new Set();
                    
                    for (const [name1, data1] of nameMap.entries()) {
                        for (const [name2, data2] of nameMap.entries()) {
                            // Skip same names or already processed pairs
                            if (name1 === name2) continue;
                            
                            const pairKey1 = `${data1.id}-${data2.id}`;
                            const pairKey2 = `${data2.id}-${data1.id}`;
                            
                            if (processedPairs.has(pairKey1) || processedPairs.has(pairKey2)) continue;
                            
                            // Check if names are similar
                            if (areSimilarNames(name1, name2)) {
                                duplicates.similarNameDuplicates.push({
                                    name1,
                                    name2,
                                    players: [
                                        { 
                                            id: data1.id, 
                                            details: data1.details,
                                            club: data1.club,
                                            position: data1.position
                                        },
                                        { 
                                            id: data2.id, 
                                            details: data2.details,
                                            club: data2.club,
                                            position: data2.position
                                        }
                                    ]
                                });
                                
                                // Mark this pair as processed
                                processedPairs.add(pairKey1);
                                processedPairs.add(pairKey2);
                            }
                        }
                    }
                }
                
                // Add duplicate IDs as a special category if any found
                if (duplicateIds.size > 0) {
                    duplicates.duplicateIds = Array.from(duplicateIds);
                    duplicateTypes.duplicateIds = 'Duplicate IDs (CRITICAL ERROR)';
                }
                
                // Format results for output
                resultsText = formatResultsText(duplicates);
                duplicateCategories = duplicates;
                
                // Display results on page
                displayResults(duplicates);
                
                // Enable download button
                downloadBtn.disabled = false;
                
            } catch (error) {
                console.error('Error processing players.json:', error);
                tabContent.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }
        
        // Function to format results text for download
        function formatResultsText(duplicates) {
            let text = `==== DUPLICATE PLAYERS REPORT ====\n\n`;
            
            // Summary of duplicates found
            text += `SUMMARY OF DUPLICATES FOUND:\n`;
            for (const [type, list] of Object.entries(duplicates)) {
                if (Array.isArray(list)) {
                    text += `- ${duplicateTypes[type]}: ${list.length}\n`;
                } else if (type === 'duplicateIds') {
                    text += `- ${duplicateTypes[type]}: ${duplicates[type].length}\n`;
                }
            }
            text += `\n`;
            
            // Add details for each duplicate type
            for (const [type, list] of Object.entries(duplicates)) {
                if (type === 'duplicateIds' && list.length > 0) {
                    text += `\n==== DUPLICATE IDs (CRITICAL ERROR) ====\n`;
                    list.forEach(id => {
                        text += `- ID ${id} is used by multiple players\n`;
                    });
                    text += `\n`;
                    continue;
                }
                
                if (!Array.isArray(list) || list.length === 0) continue;
                
                text += `\n==== ${duplicateTypes[type].toUpperCase()} ====\n`;
                
                if (type === 'exactNameDuplicates' || type === 'exactNameDifferentIdDuplicates' || type === 'sameNamePositionDuplicates') {
                    list.forEach(duplicate => {
                        const name = duplicate.name;
                        const position = duplicate.position ? ` (${duplicate.position})` : '';
                        text += `- "${name}"${position}:\n`;
                        duplicate.players.forEach(player => {
                            const club = player.club ? ` - Club: ${player.club}` : '';
                            const position = player.position ? ` - Position: ${player.position}` : '';
                            text += `  * ${player.details}${club}${position}\n`;
                        });
                        text += `\n`;
                    });
                } else if (type === 'similarNameDuplicates') {
                    list.forEach(duplicate => {
                        text += `- "${duplicate.name1}" vs "${duplicate.name2}":\n`;
                        duplicate.players.forEach(player => {
                            const club = player.club ? ` - Club: ${player.club}` : '';
                            const position = player.position ? ` - Position: ${player.position}` : '';
                            text += `  * ${player.details}${club}${position}\n`;
                        });
                        text += `\n`;
                    });
                }
            }
            
            return text;
        }
        
        // Function to display results on the page
        function displayResults(duplicates) {
            // Show results container
            resultsContainer.style.display = 'block';
            
            // Update summary stats
            let summaryHTML = '<ul>';
            for (const [type, list] of Object.entries(duplicates)) {
                const count = Array.isArray(list) ? list.length : (type === 'duplicateIds' ? duplicates[type].length : 0);
                if (duplicateTypes[type]) {
                    summaryHTML += `<li>${duplicateTypes[type]}: <strong>${count}</strong></li>`;
                }
            }
            summaryHTML += '</ul>';
            summaryStatsDiv.innerHTML = summaryHTML;
            statsDiv.style.display = 'block';
            
            // Create tabs for each duplicate type
            let hasDuplicates = false;
            
            for (const [type, list] of Object.entries(duplicates)) {
                if (!duplicateTypes[type]) continue;
                
                const count = Array.isArray(list) ? list.length : (type === 'duplicateIds' ? duplicates[type].length : 0);
                if (count > 0) {
                    hasDuplicates = true;
                    
                    // Create tab button
                    const button = document.createElement('button');
                    button.className = 'tab-button';
                    button.dataset.tab = type;
                    button.innerHTML = `${duplicateTypes[type]} <span class="count-badge">${count}</span>`;
                    button.addEventListener('click', () => switchTab(type));
                    tabButtons.appendChild(button);
                    
                    // Create tab panel
                    const panel = document.createElement('div');
                    panel.className = 'tab-panel';
                    panel.id = `tab-${type}`;
                    
                    // Add content to panel
                    let panelHTML = '';
                    
                    if (type === 'duplicateIds') {
                        list.forEach(id => {
                            panelHTML += `<div class="duplicate-entry">`;
                            panelHTML += `<div class="player-name">ID ${id} is used by multiple players</div>`;
                            panelHTML += `</div>`;
                        });
                    } else if (type === 'exactNameDuplicates' || type === 'exactNameDifferentIdDuplicates' || type === 'sameNamePositionDuplicates') {
                        list.forEach(duplicate => {
                            const name = duplicate.name;
                            const position = duplicate.position ? ` (${duplicate.position})` : '';
                            
                            panelHTML += `<div class="duplicate-entry">`;
                            panelHTML += `<div class="player-name">"${name}"${position}</div>`;
                            
                            duplicate.players.forEach(player => {
                                const club = player.club ? ` - Club: ${player.club}` : '';
                                const position = player.position ? ` - Position: ${player.position}` : '';
                                panelHTML += `<div class="player-details">${player.details}${club}${position}</div>`;
                            });
                            
                            panelHTML += `</div>`;
                        });
                    } else if (type === 'similarNameDuplicates') {
                        list.forEach(duplicate => {
                            panelHTML += `<div class="duplicate-entry">`;
                            panelHTML += `<div class="player-name">"${duplicate.name1}" vs "${duplicate.name2}"</div>`;
                            
                            duplicate.players.forEach(player => {
                                const club = player.club ? ` - Club: ${player.club}` : '';
                                const position = player.position ? ` - Position: ${player.position}` : '';
                                panelHTML += `<div class="player-details">${player.details}${club}${position}</div>`;
                            });
                            
                            panelHTML += `</div>`;
                        });
                    }
                    
                    panel.innerHTML = panelHTML;
                    tabContent.appendChild(panel);
                }
            }
            
            if (hasDuplicates) {
                tabsDiv.style.display = 'block';
                // Activate first tab
                const firstTab = tabButtons.querySelector('.tab-button');
                if (firstTab) {
                    firstTab.click();
                }
            } else {
                tabContent.innerHTML = '<div>No duplicate players found!</div>';
                tabsDiv.style.display = 'block';
            }
        }
        
        // Function to switch tabs
        function switchTab(tabId) {
            // Update active button
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
            
            // Update active panel
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            const activePanel = document.getElementById(`tab-${tabId}`);
            if (activePanel) {
                activePanel.classList.add('active');
            }
        }
        
        // Function to download results
        function downloadResults() {
            const blob = new Blob([resultsText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'duplicate_players.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html> 